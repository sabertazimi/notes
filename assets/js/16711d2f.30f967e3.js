"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([["81302"],{3221(e,n,r){r.r(n),r.d(n,{metadata:()=>t,default:()=>u,frontMatter:()=>a,contentTitle:()=>l,toc:()=>c,assets:()=>i});var t=JSON.parse('{"id":"web/react/update","title":"Update","description":"Update and Update Queue:","source":"@site/content/web/react/update.md","sourceDirName":"web/react","slug":"/web/react/update","permalink":"/notes/web/react/update","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/react/update.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"React","permalink":"/notes/tags/react"},{"inline":true,"label":"Internals","permalink":"/notes/tags/internals"},{"inline":true,"label":"Reconciler","permalink":"/notes/tags/reconciler"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":35,"frontMatter":{"sidebar_position":35,"tags":["Web","React","Internals","Reconciler"]},"sidebar":"tutorialSidebar","previous":{"title":"Render","permalink":"/notes/web/react/render"},"next":{"title":"Diff","permalink":"/notes/web/react/diff"}}'),s=r(62615),o=r(30416);let a={sidebar_position:35,tags:["Web","React","Internals","Reconciler"]},l="Update",i={},c=[];function d(e){let n={a:"a",code:"code",h1:"h1",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"update",children:"Update"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://github.com/facebook/react/blob/main/packages/react-reconciler/src/ReactUpdateQueue.js",children:"Update and Update Queue"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"UpdateQueue"})," \u662F\u4E00\u4E2A",(0,s.jsx)(n.strong,{children:"\u5FAA\u73AF\u961F\u5217"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["\u521B\u5EFA ",(0,s.jsx)(n.code,{children:"Update"})," \u65F6\u673A (",(0,s.jsx)(n.code,{children:"createUpdate"}),"/",(0,s.jsx)(n.code,{children:"enqueueUpdate"}),"):","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ReactFiberReconciler.updateContainer"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ReactFiberClassComponent.setState"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ReactFiberHooks.dispatchAction"}),"."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"Reconciler.Render"})," \u9636\u6BB5, \u8C03\u7528 ",(0,s.jsx)(n.code,{children:"XXXClassInstance"}),"/",(0,s.jsx)(n.code,{children:"useXXX"}),",\n\u904D\u5386\u5904\u7406 Update Queue (",(0,s.jsx)(n.code,{children:"processUpdateQueue"}),"/",(0,s.jsx)(n.code,{children:"HooksDispatcherOnUpdate"}),"), \u8BA1\u7B97\u51FA memoizedState,\n\u5229\u7528 pendingProps \u4E0E memoizedState \u4EA7\u751F\u65B0\u7684 ReactElement (",(0,s.jsx)(n.code,{children:"ClassComponent.render()"}),"/",(0,s.jsx)(n.code,{children:"FunctionComponent()"}),")."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"interface Update<State> {\n  lane: Lane\n  tag: 'UpdateState' | 'ReplaceState' | 'ForceUpdate' | 'CaptureUpdate'\n  payload: any\n  callback: (() => mixed) | null\n  next: Update<State> | null\n  _eventTime: number\n}\n\ninterface SharedQueue<State> {\n  pending: Update<State> | null\n}\n\ninterface UpdateQueue<State> {\n  baseState: State\n  firstBaseUpdate: Update<State> | null\n  lastBaseUpdate: Update<State> | null\n  shared: SharedQueue<State>\n  effects: Array<Update<State>> | null // Updates with `callback`.\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://github.com/facebook/react/blob/main/packages/react-reconciler/src/ReactFiberClassComponent.js",children:"ReactFiberClassComponent.setState"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"const classComponentUpdater = {\n  isMounted,\n  enqueueSetState(inst, payload, callback) {\n    // 1. \u83B7\u53D6 ClassComponent \u5B9E\u4F8B\u5BF9\u5E94\u7684 Fiber \u8282\u70B9.\n    const fiber = getInstance(inst)\n    // 2. \u521B\u5EFA Update \u5BF9\u8C61.\n    const eventTime = requestEventTime()\n    const lane = requestUpdateLane(fiber)\n    const update = createUpdate(eventTime, lane)\n    update.payload = payload\n\n    if (callback !== undefined && callback !== null)\n      update.callback = callback\n\n    // 3. \u5C06 Update \u5BF9\u8C61\u6DFB\u52A0\u5230\u5F53\u524D Fiber \u8282\u70B9\u7684 updateQueue.\n    enqueueUpdate(fiber, update)\n    // 4. \u8BF7\u6C42\u8C03\u5EA6, \u8FDB\u5165 Reconciler.\n    scheduleUpdateOnFiber(fiber, lane, eventTime)\n  },\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://github.com/facebook/react/blob/main/packages/react-reconciler/src/ReactFiberHooks.js",children:"ReactFiberHooks.dispatchAction"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"function dispatchAction<S, A>(\n  fiber: Fiber,\n  queue: UpdateQueue<S, A>,\n  action: A\n) {\n  // 1. \u521B\u5EFA Update \u5BF9\u8C61.\n  const eventTime = requestEventTime()\n  const lane = requestUpdateLane(fiber)\n  const update: Update<S, A> = {\n    lane,\n    action,\n    eagerReducer: null,\n    eagerState: null,\n    next: null,\n  }\n\n  // 2. \u5C06 Update \u5BF9\u8C61\u6DFB\u52A0\u5230\u5F53\u524D Hook \u5BF9\u8C61\u7684 updateQueue.\n  const pending = queue.pending\n\n  if (pending === null) {\n    update.next = update\n  } else {\n    update.next = pending.next\n    pending.next = update\n  }\n\n  queue.pending = update\n\n  // 3. \u8BF7\u6C42\u8C03\u5EA6, \u8FDB\u5165 Reconciler.\n  scheduleUpdateOnFiber(fiber, lane, eventTime)\n}\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"createUpdate."}),"\n",(0,s.jsx)(n.li,{children:"enqueueUpdate."}),"\n",(0,s.jsx)(n.li,{children:"scheduleUpdateOnFiber."}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"markUpdateLaneFromFiberToRoot"}),":\n\u627E\u51FA Fiber \u6811\u4E2D\u53D7\u5230\u672C\u6B21 ",(0,s.jsx)(n.code,{children:"Update"})," \u5F71\u54CD\u7684\u6240\u6709\u8282\u70B9 (\u5B58\u5728\u66F4\u65B0\u53EF\u80FD),\n\u8BBE\u7F6E\u8FD9\u4E9B\u8282\u70B9\u7684 ",(0,s.jsx)(n.code,{children:"fiber.lanes"})," \u6216 ",(0,s.jsx)(n.code,{children:"fiber.childLanes"}),"."]}),"\n",(0,s.jsx)(n.li,{children:"ensureRootIsScheduled."}),"\n",(0,s.jsx)(n.li,{children:"flushSyncCallbacks."}),"\n",(0,s.jsx)(n.li,{children:"performSyncWorkOnRoot / performConcurrentWorkOnRoot."}),"\n",(0,s.jsx)(n.li,{children:"renderRootSync / renderRootConcurrent."}),"\n",(0,s.jsx)(n.li,{children:"workLoopSync / workLoopConcurrent."}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"performUnitOfWork(workInProgress)"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"beginWork"}),":","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u82E5\u5224\u65AD\u5F53\u524D Fiber \u8282\u70B9\u65E0\u9700\u66F4\u65B0 (",(0,s.jsx)(n.code,{children:"lanes: 0, childLanes: ?"}),"), \u8C03\u7528 ",(0,s.jsx)(n.code,{children:"bailoutOnAlreadyFinishedWork"})," \u5FAA\u73AF\u68C0\u6D4B\u5B50\u8282\u70B9\u662F\u5426\u9700\u8981\u66F4\u65B0:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"instance.shouldComponentUpdate() === false"}),",\n",(0,s.jsx)(n.code,{children:"workInProgress.pendingProps === current.memoizedProps"}),",\n",(0,s.jsx)(n.code,{children:"hasLegacyContextChange() === false"}),",\n",(0,s.jsx)(n.code,{children:"checkIfContextChanged(fiber.dependencies) === false"}),",\n",(0,s.jsx)(n.code,{children:"includesSomeLane(fiber.lanes, renderLanes) === false"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["When it comes to ",(0,s.jsx)(n.code,{children:"lanes: 0, childLanes: 0"}),", skip it and its children (",(0,s.jsx)(n.strong,{children:"bailout"}),")."]}),"\n",(0,s.jsxs)(n.li,{children:["When it comes to ",(0,s.jsx)(n.code,{children:"lanes: 0, childLanes: 1"}),", continue to check its children."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\u82E5\u5224\u65AD\u5F53\u524D Fiber \u8282\u70B9\u9700\u8981\u66F4\u65B0 (",(0,s.jsx)(n.code,{children:"lanes: 1"}),"), \u8C03\u7528 ",(0,s.jsx)(n.code,{children:"updateXXXComponent"})," \u8FDB\u884C\u66F4\u65B0."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"bailoutOnAlreadyFinishedWork"}),":","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u82E5 ",(0,s.jsx)(n.code,{children:"includesSomeLane(renderLanes, workInProgress.childLanes) === false"}),"\n\u8868\u660E\u5B50\u8282\u70B9\u65E0\u9700\u66F4\u65B0, \u53EF\u76F4\u63A5\u8FDB\u5165\u56DE\u6EAF\u9636\u6BB5 (",(0,s.jsx)(n.code,{children:"completeUnitOfWork"}),")."]}),"\n",(0,s.jsxs)(n.li,{children:["\u82E5 ",(0,s.jsx)(n.code,{children:"includesSomeLane(renderLanes, workInProgress.childLanes) === true"}),",\n\u8868\u660E\u5B50\u8282\u70B9\u9700\u8981\u66F4\u65B0, clone \u5E76\u8FD4\u56DE\u5B50\u8282\u70B9."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"updateHostRoot/updateXXXComponent"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ReactClassComponent.render()"})," / ",(0,s.jsx)(n.code,{children:"ReactFunctionComponent()"})," / ",(0,s.jsx)(n.code,{children:"ReactDOMComponent.createElement()"}),":\n\u904D\u5386\u5904\u7406 Update Queue (",(0,s.jsx)(n.code,{children:"processUpdateQueue"}),"/",(0,s.jsx)(n.code,{children:"HooksDispatcherOnUpdate"}),"), \u8BA1\u7B97\u51FA memoizedState,\n\u5229\u7528 pendingProps \u4E0E memoizedState \u4EA7\u751F\u65B0\u7684 ReactElement."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"reconcileChildren"}),":","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u901A\u8FC7 ReactElement \u4E0E OldFiber, \u4EA7\u751F\u6216\u590D\u7528 ChildFiber."}),"\n",(0,s.jsxs)(n.li,{children:["\u8BBE\u7F6E ",(0,s.jsx)(n.code,{children:"fiber.flags"}),", \u6807\u8BB0\u526F\u4F5C\u7528: ",(0,s.jsx)(n.code,{children:"Placement"}),"/",(0,s.jsx)(n.code,{children:"Deletion"}),"/etc."]}),"\n",(0,s.jsxs)(n.li,{children:["\u5BF9\u4E8E ",(0,s.jsx)(n.code,{children:"Deletion"})," Fiber, \u5728 ",(0,s.jsx)(n.code,{children:"beginWork"})," \u9636\u6BB5\u63D0\u524D\u5C06\u5176\u6DFB\u52A0\u5230\u7236\u8282\u70B9\u7684 Effects \u961F\u5217\u4E2D\n(\u8BE5\u8282\u70B9\u4F1A\u8131\u79BB Fiber \u6811, \u4E0D\u4F1A\u518D\u8FDB\u5165 ",(0,s.jsx)(n.code,{children:"completeWork"})," \u9636\u6BB5, \u65E0\u6CD5\u5728\u6B64\u9636\u6BB5\u6536\u96C6\u6B64\u8282\u70B9\u526F\u4F5C\u7528)."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:"reconcileChildFibers."}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"completeUnitOfWork"}),": \u6536\u96C6\u526F\u4F5C\u7528."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"completeWork"}),": \u6536\u96C6\u526F\u4F5C\u7528."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"// \u6807\u8BB0\u6240\u6709\u53EF\u80FD\u5B58\u5728\u66F4\u65B0\u7684\u8282\u70B9, \u5E76\u8BBE\u7F6E fiber.lanes \u4E0E fiber.childLanes.\nfunction markUpdateLaneFromFiberToRoot(\n  sourceFiber: Fiber, // \u88AB\u66F4\u65B0\u7684\u8282\u70B9.\n  lane: Lane\n): FiberRoot | null {\n  // \u8BBE\u7F6E sourceFiber.lanes.\n  sourceFiber.lanes = mergeLanes(sourceFiber.lanes, lane)\n  let alternate = sourceFiber.alternate\n\n  if (alternate !== null) {\n    // \u540C\u65F6\u8BBE\u7F6E sourceFiber.alternate.lanes.\n    alternate.lanes = mergeLanes(alternate.lanes, lane)\n  }\n\n  // \u4ECE sourceFiber \u5F00\u59CB, \u5411\u4E0A\u904D\u5386\u6240\u6709 Fiber, \u76F4\u5230 HostRootFiber.\n  // \u8BBE\u7F6E\u6CBF\u9014\u6240\u6709 fiber.childLanes \u4E0E fiber.alternate.childLanes.\n  let node = sourceFiber\n  let parent = sourceFiber.return\n\n  while (parent !== null) {\n    parent.childLanes = mergeLanes(parent.childLanes, lane)\n    alternate = parent.alternate\n\n    if (alternate !== null)\n      alternate.childLanes = mergeLanes(alternate.childLanes, lane)\n\n    node = parent\n    parent = parent.return\n  }\n\n  if (node.tag === HostRoot) {\n    const root: FiberRoot = node.stateNode\n    return root\n  } else {\n    return null\n  }\n}\n\nfunction beginWork(\n  current: Fiber | null,\n  workInProgress: Fiber,\n  renderLanes: Lanes\n): Fiber | null {\n  const updateLanes = workInProgress.lanes\n\n  if (current !== null) {\n    // \u8FDB\u5165\u5BF9\u6BD4.\n    const oldProps = current.memoizedProps\n    const newProps = workInProgress.pendingProps\n    if (\n      oldProps !== newProps\n      || hasLegacyContextChanged()\n      || (__DEV__ ? workInProgress.type !== current.type : false)\n    ) {\n      didReceiveUpdate = true\n    } else if (!includesSomeLane(renderLanes, updateLanes)) {\n      // \u5F53\u524D\u6E32\u67D3\u4F18\u5148\u7EA7 renderLanes \u4E0D\u5305\u62EC fiber.lanes, \u8868\u660E\u5F53\u524D Fiber \u8282\u70B9\u65E0\u9700\u66F4\u65B0.\n      didReceiveUpdate = false\n      // \u8C03\u7528 bailoutOnAlreadyFinishedWork \u5FAA\u73AF\u68C0\u6D4B\u5B50\u8282\u70B9\u662F\u5426\u9700\u8981\u66F4\u65B0.\n      return bailoutOnAlreadyFinishedWork(current, workInProgress, renderLanes)\n    }\n  }\n\n  // \u5F53\u524D\u8282\u70B9\u9700\u8981\u66F4\u65B0.\n  workInProgress.lanes = NoLanes // \u6700\u9AD8\u4F18\u5148\u7EA7\n\n  switch (workInProgress.tag) {\n    case ClassComponent: {\n      const Component = workInProgress.type\n      const unresolvedProps = workInProgress.pendingProps\n      const resolvedProps\n        = workInProgress.elementType === Component\n          ? unresolvedProps\n          : resolveDefaultProps(Component, unresolvedProps)\n      return updateClassComponent(\n        current,\n        workInProgress,\n        Component,\n        resolvedProps,\n        renderLanes\n      )\n    }\n    case HostRoot:\n      return updateHostRoot(current, workInProgress, renderLanes)\n    case HostComponent:\n      return updateHostComponent(current, workInProgress, renderLanes)\n    case HostText:\n      return updateHostText(current, workInProgress)\n    case Fragment:\n      return updateFragment(current, workInProgress, renderLanes)\n  }\n}\n\nfunction bailoutOnAlreadyFinishedWork(\n  current: Fiber | null,\n  workInProgress: Fiber,\n  renderLanes: Lanes\n): Fiber | null {\n  if (!includesSomeLane(renderLanes, workInProgress.childLanes)) {\n    // \u6E32\u67D3\u4F18\u5148\u7EA7\u4E0D\u5305\u62EC workInProgress.childLanes, \u8868\u660E\u5B50\u8282\u70B9\u4E5F\u65E0\u9700\u66F4\u65B0.\n    // \u8FD4\u56DE null, \u76F4\u63A5\u8FDB\u5165\u56DE\u6EAF\u9636\u6BB5.\n    return null\n  } else {\n    // Fiber \u81EA\u8EAB\u65E0\u9700\u66F4\u65B0, \u4F46\u5B50\u8282\u70B9\u9700\u8981\u66F4\u65B0, clone \u5E76\u8FD4\u56DE\u5B50\u8282\u70B9.\n    cloneChildFibers(current, workInProgress)\n    return workInProgress.child\n  }\n}\n\nfunction completeWork(\n  current: Fiber | null,\n  workInProgress: Fiber,\n  renderLanes: Lanes\n): Fiber | null {\n  const newProps = workInProgress.pendingProps\n\n  switch (workInProgress.tag) {\n    case HostComponent: {\n      // \u975E\u6587\u672C\u8282\u70B9.\n      popHostContext(workInProgress)\n      const rootContainerInstance = getRootHostContainer()\n      const type = workInProgress.type\n\n      if (current !== null && workInProgress.stateNode !== null) {\n        // \u5904\u7406\u6539\u52A8.\n        updateHostComponent(\n          current,\n          workInProgress,\n          type,\n          newProps,\n          rootContainerInstance\n        )\n\n        if (current.ref !== workInProgress.ref)\n          markRef(workInProgress)\n      }\n\n      return null\n    }\n    case HostText: {\n      // \u6587\u672C\u8282\u70B9.\n      const newText = newProps\n\n      if (current !== null && workInProgress.stateNode !== null) {\n        const oldText = current.memoizedProps\n        // \u5904\u7406\u6539\u52A8.\n        updateHostText(current, workInProgress, oldText, newText)\n      }\n\n      return null\n    }\n  }\n}\n\nfunction updateHostComponent(\n  current: Fiber,\n  workInProgress: Fiber,\n  type: Type,\n  newProps: Props,\n  rootContainerInstance: Container\n) {\n  const oldProps = current.memoizedProps\n\n  if (oldProps === newProps)\n    return\n\n  const instance: Instance = workInProgress.stateNode\n  const currentHostContext = getHostContext()\n  const updatePayload = prepareUpdate(\n    instance,\n    type,\n    oldProps,\n    newProps,\n    rootContainerInstance,\n    currentHostContext\n  )\n  workInProgress.updateQueue = updatePayload\n\n  // \u5982\u679C\u6709\u5C5E\u6027\u53D8\u52A8, \u8BBE\u7F6E fiber.flags |= Update, \u7B49\u5F85 Commit \u9636\u6BB5\u5904\u7406.\n  if (updatePayload)\n    markUpdate(workInProgress)\n}\n\nfunction updateHostText(\n  current: Fiber,\n  workInProgress: Fiber,\n  oldText: string,\n  newText: string\n) {\n  // \u5982\u679C\u6709\u5C5E\u6027\u53D8\u52A8, \u8BBE\u7F6E fiber.flags |= Update, \u7B49\u5F85 Commit \u9636\u6BB5\u5904\u7406.\n  if (oldText !== newText)\n    markUpdate(workInProgress)\n}\n"})})]})}function u(e={}){let{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},30416(e,n,r){r.d(n,{R:()=>a,x:()=>l});var t=r(59471);let s={},o=t.createContext(s);function a(e){let n=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);