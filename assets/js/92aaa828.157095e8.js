"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([["79066"],{16350(n,e,i){i.r(e),i.d(e,{metadata:()=>s,default:()=>u,frontMatter:()=>o,contentTitle:()=>t,toc:()=>a,assets:()=>c});var s=JSON.parse('{"id":"web/devops/bundler","title":"Bundlers","description":"Rollup","source":"@site/content/web/devops/bundler.md","sourceDirName":"web/devops","slug":"/web/devops/bundler","permalink":"/notes/web/devops/bundler","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/devops/bundler.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"DevOps","permalink":"/notes/tags/dev-ops"},{"inline":true,"label":"Bundler","permalink":"/notes/tags/bundler"},{"inline":true,"label":"Rollup","permalink":"/notes/tags/rollup"},{"inline":true,"label":"Vite","permalink":"/notes/tags/vite"},{"inline":true,"label":"ESBuild","permalink":"/notes/tags/es-build"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":13,"frontMatter":{"sidebar_position":13,"tags":["Web","DevOps","Bundler","Rollup","Vite","ESBuild"]},"sidebar":"tutorialSidebar","previous":{"title":"Webpack","permalink":"/notes/web/devops/webpack"},"next":{"title":"Electron","permalink":"/notes/web/electron/"}}'),l=i(62615),r=i(30416);let o={sidebar_position:13,tags:["Web","DevOps","Bundler","Rollup","Vite","ESBuild"]},t="Bundlers",c={},a=[{value:"Rollup",id:"rollup",level:2},{value:"Vite",id:"vite",level:2},{value:"ESBuild",id:"esbuild",level:2},{value:"Optimization",id:"optimization",level:2},{value:"Common Libraries",id:"common-libraries",level:3},{value:"Common Chunks",id:"common-chunks",level:3},{value:"Code Minimization",id:"code-minimization",level:3},{value:"Code Splitting",id:"code-splitting",level:3},{value:"Tree Shaking",id:"tree-shaking",level:3},{value:"Build Cache",id:"build-cache",level:3},{value:"Browser Cache",id:"browser-cache",level:3},{value:"Performance Profiling",id:"performance-profiling",level:3}];function d(n){let e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...n.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(e.header,{children:(0,l.jsx)(e.h1,{id:"bundlers",children:"Bundlers"})}),"\n",(0,l.jsx)(e.h2,{id:"rollup",children:"Rollup"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-ts",children:"import commonjs from '@rollup/plugin-commonjs'\nimport resolve from '@rollup/plugin-node-resolve'\nimport typescript from '@rollup/plugin-typescript'\nimport { defineConfig } from 'rollup'\nimport dts from 'rollup-plugin-dts'\nimport external from 'rollup-plugin-peer-deps-external'\nimport postcss from 'rollup-plugin-postcss'\nimport { terser } from 'rollup-plugin-terser'\nimport pkg from './package.json'\n\nexport default defineConfig([\n  {\n    input: 'src/index.ts',\n    output: [\n      {\n        file: pkg.main,\n        format: 'cjs',\n        sourcemap: true,\n        name: 'react-lib',\n      },\n      {\n        file: pkg.module,\n        format: 'esm',\n        sourcemap: true,\n      },\n    ],\n    plugins: [\n      external(),\n      resolve(),\n      commonjs(),\n      typescript({ tsconfig: './tsconfig.json' }),\n      postcss(),\n      terser(),\n    ],\n  },\n  {\n    input: 'dist/esm/types/index.d.ts',\n    output: [{ file: 'dist/index.d.ts', format: 'esm' }],\n    external: [/\\.css$/],\n    plugins: [dts()],\n  },\n])\n"})}),"\n",(0,l.jsx)(e.h2,{id:"vite",children:"Vite"}),"\n",(0,l.jsxs)(e.p,{children:[(0,l.jsx)(e.a,{href:"https://vitejs.dev/guide/why.html",children:"Unbundled development"}),":"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-ts",children:"import path from 'node:path'\nimport react from '@vitejs/plugin-react'\nimport { defineConfig } from 'vite'\nimport dts from 'vite-plugin-dts'\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    dts({\n      insertTypesEntry: true,\n    }),\n  ],\n  build: {\n    lib: {\n      entry: path.resolve(__dirname, 'src/lib/index.ts'),\n      name: 'SafeView',\n      formats: ['es', 'umd'],\n      fileName: format => `SafeView.${format}.js`,\n    },\n    rollupOptions: {\n      external: ['react', 'react-dom'],\n      output: {\n        globals: {\n          'react': 'React',\n          'react-dom': 'ReactDOM',\n        },\n      },\n    },\n    minify: true,\n    sourcemap: true,\n  },\n})\n"})}),"\n",(0,l.jsx)(e.h2,{id:"esbuild",children:"ESBuild"}),"\n",(0,l.jsx)(e.p,{children:"ESBuild build configuration:"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-ts",children:"// build.js\nconst esbuild = require('esbuild')\nconst inlineImage = require('esbuild-plugin-inline-image')\n\nesbuild\n  .build({\n    entryPoints: ['./src/index.js'],\n    outfile: './public/js/app.js',\n    minify: true,\n    bundle: true,\n    loader: {\n      '.js': 'jsx',\n    },\n    plugins: [inlineImage()],\n  })\n  .catch(() => process.exit(1))\n"})}),"\n",(0,l.jsx)(e.p,{children:"ESBuild serve configuration:"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-ts",children:"// serve.js\nconst esbuild = require('esbuild')\nconst inlineImage = require('esbuild-plugin-inline-image')\n\nesbuild\n  .serve(\n    {\n      servedir: 'public',\n      port: 8000,\n    },\n    {\n      entryPoints: ['./src/index.js'],\n      outfile: './public/js/app.js',\n      bundle: true,\n      loader: {\n        '.js': 'jsx',\n      },\n      plugins: [inlineImage()],\n    }\n  )\n  .catch(() => process.exit())\n"})}),"\n",(0,l.jsx)(e.p,{children:"ESBuild webpack configuration:"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-ts",children:"const { ESBuildMinifyPlugin } = require('esbuild-loader')\n\nmodule.exports = {\n  rules: [\n    {\n      test: /.js$/,\n      loader: 'esbuild-loader',\n      options: {\n        loader: 'jsx',\n        target: 'es2015',\n      },\n    },\n  ],\n  optimization: {\n    minimizer: [\n      new ESBuildMinifyPlugin({\n        target: 'es2015',\n      }),\n    ],\n  },\n}\n"})}),"\n",(0,l.jsx)(e.h2,{id:"optimization",children:"Optimization"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"CDN."}),"\n",(0,l.jsx)(e.li,{children:"\u670D\u52A1\u5668\u7AEF\u6E32\u67D3."}),"\n",(0,l.jsx)(e.li,{children:"\u63D0\u53D6\u516C\u5171\u5E93."}),"\n",(0,l.jsx)(e.li,{children:"\u4EE3\u7801\u538B\u7F29."}),"\n",(0,l.jsx)(e.li,{children:"\u4EE3\u7801\u5206\u5272: Chunks."}),"\n",(0,l.jsx)(e.li,{children:"\u4EE3\u7801\u5206\u5272: \u6309\u9700\u52A0\u8F7D."}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://webpack.js.org/guides/build-performance",children:"\u4F18\u5316\u6784\u5EFA\u901F\u5EA6"}),":","\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u7F29\u5C0F\u6587\u4EF6\u641C\u7D22\u8303\u56F4:","\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u4F18\u5316 ",(0,l.jsx)(e.code,{children:"loader"})," \u914D\u7F6E: ",(0,l.jsx)(e.code,{children:"include"}),"/",(0,l.jsx)(e.code,{children:"exclude"}),"."]}),"\n",(0,l.jsxs)(e.li,{children:["\u4F18\u5316 ",(0,l.jsx)(e.code,{children:"module.noParse"})," \u914D\u7F6E:\n\u5FFD\u7565\u5BF9\u90E8\u5206\u6CA1\u91C7\u7528\u6A21\u5757\u5316\u7684\u6587\u4EF6\u7684\u9012\u5F52\u89E3\u6790\u5904\u7406."]}),"\n",(0,l.jsxs)(e.li,{children:["\u4F18\u5316 ",(0,l.jsx)(e.code,{children:"resolve.modules"})," \u914D\u7F6E: \u7B2C\u4E09\u65B9\u6A21\u5757."]}),"\n",(0,l.jsxs)(e.li,{children:["\u4F18\u5316 ",(0,l.jsx)(e.code,{children:"resolve.alias"})," \u914D\u7F6E."]}),"\n",(0,l.jsxs)(e.li,{children:["\u4F18\u5316 ",(0,l.jsx)(e.code,{children:"resolve.mainFields"})," \u914D\u7F6E."]}),"\n",(0,l.jsxs)(e.li,{children:["\u4F18\u5316 ",(0,l.jsx)(e.code,{children:"resolve.extensions"})," \u914D\u7F6E: \u540E\u7F00\u5217\u8868."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u51CF\u5C11\u6253\u5305\u6587\u4EF6:","\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u63D0\u53D6\u516C\u5171\u4EE3\u7801."}),"\n",(0,l.jsxs)(e.li,{children:["\u52A8\u6001\u94FE\u63A5 ",(0,l.jsx)(e.code,{children:"DllPlugin"}),"."]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"externals"}),"."]}),"\n",(0,l.jsx)(e.li,{children:"Tree shaking."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u7F13\u5B58:","\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://webpack.js.org/configuration/cache",children:"\u6301\u4E45\u5316\u7F13\u5B58"}),"."]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"babel"})," \u7F13\u5B58 ",(0,l.jsx)(e.code,{children:"cacheDirectory: true"}),"."]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"cache-loader"}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u591A\u8FDB\u7A0B:","\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"thread-loader"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://jelly.jd.com/article/61179aa26bea510187770aa3",children:"JD Webpack optimization guide"}),"."]}),"\n"]}),"\n",(0,l.jsx)(e.h3,{id:"common-libraries",children:"Common Libraries"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-json",children:'{\n  "externals": {\n    "moment": "window.moment",\n    "antd": "window.antd",\n    "lodash": "window._",\n    "react": "window.React",\n    "react-dom": "window.ReactDOM"\n  }\n}\n'})}),"\n",(0,l.jsx)(e.h3,{id:"common-chunks",children:"Common Chunks"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-ts",children:"const config = new webpack.optimize.CommonsChunkPlugin({\n  name: string, // or\n  names: [string],\n  // The chunk name of the commons chunk.\n  // An existing chunk can be selected by passing a name of an existing chunk.\n  // If an array of strings is passed this is equal to\n  // invoking the plugin multiple times for each chunk name.\n  // If omitted and `options.async` or `options.children`\n  // is set all chunks are used, otherwise `options.filename`\n  // is used as chunk name.\n  // When using `options.async` to create common chunks\n  // from other async chunks you must specify an entry-point\n  // chunk name here instead of omitting the `option.name`.\n\n  filename: string,\n  // The filename template for the commons chunk.\n  // Can contain the same placeholders as `output.filename`.\n  // If omitted the original filename is not modified\n  // (usually `output.filename` or `output.chunkFilename`).\n  // This option is not permitted if you're using `options.async` as well,\n  // see below for more details.\n\n  minChunks: number | Number.POSITIVE_INFINITY | fn,\n  // (module, count) => boolean,\n  // The minimum number of chunks which need to contain a module\n  // before it's moved into the commons chunk.\n  // The number must be greater than or equal 2\n  // and lower than or equal to the number of chunks.\n  // Passing `Infinity` creates the commons chunk, but moves no modules into it.\n  // By providing a `function` you can add custom logic.\n  // (Defaults to the number of chunks)\n\n  chunks: [string],\n  // Select the source chunks by chunk names.\n  // The chunk must be a child of the commons chunk.\n  // If omitted all entry chunks are selected.\n\n  children: boolean,\n  // If `true` all children of the commons chunk are selected\n\n  deepChildren: boolean,\n  // If `true` all descendants of the commons chunk are selected\n\n  async: boolean | string,\n  // If `true` a new async commons chunk is created\n  // as child of `options.name` and sibling of `options.chunks`.\n  // It is loaded in parallel with `options.chunks`.\n  // Instead of using `option.filename`,\n  // it is possible to change the name of the output file by providing\n  // the desired string here instead of `true`.\n\n  minSize: number,\n  // Minimum size of all common module before a commons chunk is created.\n})\n"})}),"\n",(0,l.jsx)(e.h3,{id:"code-minimization",children:"Code Minimization"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-ts",children:"const CssMinimizerPlugin = require('css-minimizer-webpack-plugin')\nconst MiniCssExtractPlugin = require('mini-css-extract-plugin')\nconst TerserPlugin = require('terser-webpack-plugin')\n\nconst isEnvProduction = process.env.NODE_ENV === 'production'\nconst isEnvProductionProfile\n  = isEnvProduction && process.argv.includes('--profile')\nconst shouldUseSourceMap = process.env.GENERATE_SOURCEMAP !== 'false'\n\nmodule.exports = {\n  module: {\n    rules: [\n      {\n        test: /\\.(js|mjs|jsx|ts|tsx)$/,\n        include: path.resolve('src'),\n        use: [\n          'thread-loader',\n          {\n            loader: require.resolve('babel-loader'),\n          },\n        ],\n      },\n      {\n        test: /.s?css$/,\n        use: [MiniCssExtractPlugin.loader, 'css-loader', 'sass-loader'],\n      },\n    ],\n  },\n  optimization: {\n    minimize: true,\n    minimizer: [\n      new TerserPlugin({\n        parallel: true,\n        terserOptions: {\n          parse: {\n            ecma: 8,\n          },\n          compress: {\n            ecma: 5,\n            warnings: false,\n            drop_console: true,\n            comparisons: false,\n            inline: 2,\n          },\n          mangle: {\n            safari10: true,\n          },\n          keep_classnames: isEnvProductionProfile,\n          keep_fnames: isEnvProductionProfile,\n          output: {\n            ecma: 5,\n            comments: false,\n            ascii_only: true,\n          },\n        },\n      }),\n      new CssMinimizerPlugin(),\n    ],\n  },\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"code-splitting",children:"Code Splitting"}),"\n",(0,l.jsx)(e.p,{children:"Huge bundle downside:"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"Cache invalid: one line code make whole cache invalid."}),"\n",(0,l.jsxs)(e.li,{children:["Useless code: only use ",(0,l.jsx)(e.code,{children:"1/N"})," of ",(0,l.jsx)(e.code,{children:"bundle.js"}),"."]}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:"Code splitting methods:"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"require.ensure([], () => {});"}),"."]}),"\n",(0,l.jsxs)(e.li,{children:["async/await ",(0,l.jsx)(e.code,{children:"import"}),"."]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"React.Suspense"})," and ",(0,l.jsx)(e.code,{children:"React.lazy"}),"."]}),"\n",(0,l.jsxs)(e.li,{children:["Route-based ",(0,l.jsx)(e.a,{href:"https://reactjs.org/docs/code-splitting.html#route-based-code-splitting",children:"code splitting"}),"."]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"vendor.[hash].chunk.js"})," (",(0,l.jsx)(e.code,{children:"document.createElement('script')"})," promise):\nsplitting vendor and application code\nis to enable long term caching techniques\nSince vendor code tends to change less often than the actual application code,\nbrowser will be able to cache them separately,\nand won't re-download them each time the app code changes."]}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:"Split chunks configuration:"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["chunks:","\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"async: \u53EA\u63D0\u53D6\u5F02\u6B65\u52A0\u8F7D\u7684\u6A21\u5757\u51FA\u6765\u6253\u5305\u5230\u4E00\u4E2A\u6587\u4EF6\u4E2D."}),"\n",(0,l.jsx)(e.li,{children:"initial: \u63D0\u53D6\u540C\u6B65\u52A0\u8F7D\u548C\u5F02\u6B65\u52A0\u8F7D\u6A21\u5757, \u5206\u522B\u6253\u5305\u5230\u4E0D\u540C\u7684\u6587\u4EF6\u4E2D."}),"\n",(0,l.jsx)(e.li,{children:"all: \u4E0D\u7BA1\u5F02\u6B65\u52A0\u8F7D\u8FD8\u662F\u540C\u6B65\u52A0\u8F7D\u7684\u6A21\u5757\u90FD\u63D0\u53D6\u51FA\u6765, \u6253\u5305\u5230\u4E00\u4E2A\u6587\u4EF6\u4E2D."}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"minSize: \u8D85\u8FC7 minSize \u624D\u4F1A\u88AB\u63D0\u53D6."}),"\n",(0,l.jsx)(e.li,{children:"maxSize: \u8D85\u8FC7 maxSize \u4F1A\u88AB\u8FDB\u4E00\u6B65\u5206\u5272."}),"\n",(0,l.jsx)(e.li,{children:"minChunks: \u5F15\u7528\u6B21\u6570 >= minChunks \u503C\u624D\u88AB\u63D0\u53D6."}),"\n",(0,l.jsx)(e.li,{children:"maxAsyncRequests: \u6700\u5927\u7684\u6309\u9700 (\u5F02\u6B65) \u52A0\u8F7D\u6B21\u6570 (default: 6)."}),"\n",(0,l.jsx)(e.li,{children:"maxInitialRequests: \u5165\u53E3\u6587\u4EF6\u52A0\u8F7D\u6700\u5927\u6570 (default: 4)."}),"\n",(0,l.jsx)(e.li,{children:"automaticNameDelimiter: \u6587\u4EF6\u540D\u5206\u5272\u7B26."}),"\n",(0,l.jsx)(e.li,{children:"name: chunk \u6587\u4EF6\u540D."}),"\n",(0,l.jsxs)(e.li,{children:["cacheGroups: \u914D\u7F6E\u63D0\u53D6\u6A21\u5757\u7684\u65B9\u6848, \u91CC\u9762\u6BCF\u4E00\u9879\u4EE3\u8868\u4E00\u4E2A\u63D0\u53D6\u6A21\u5757\u7684\u65B9\u6848.","\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"priority: \u503C\u8D8A\u5927\u4F18\u5148\u7EA7\u8D8A\u5927."}),"\n",(0,l.jsx)(e.li,{children:"test: \u5339\u914D\u6A21\u5757\u8DEF\u5F84\u6216\u540D\u79F0."}),"\n",(0,l.jsxs)(e.li,{children:["reuseExistingChunk: ",(0,l.jsx)(e.code,{children:"true"})," / ",(0,l.jsx)(e.code,{children:"false"}),"."]}),"\n",(0,l.jsxs)(e.li,{children:["enforce: ",(0,l.jsx)(e.code,{children:"true"})," / ",(0,l.jsx)(e.code,{children:"false"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-ts",children:"module.exports = {\n  optimization: {\n    runtimeChunk: true,\n    splitChunks: {\n      chunks: 'async',\n      minSize: 30000,\n      maxSize: 200000,\n      minChunks: 1,\n      maxAsyncRequests: 6,\n      maxInitialRequests: 4,\n      automaticNameDelimiter: '-',\n      cacheGroups: {\n        vendors: {\n          name: 'chunk-vendors',\n          priority: -10,\n          chunks: 'initial',\n          test: /[\\\\/]node_modules[\\\\/]/,\n        },\n        common: {\n          name: 'chunk-common',\n          priority: -20,\n          chunks: 'initial',\n          minChunks: 2,\n          reuseExistingChunk: true,\n        },\n        element: {\n          name: 'element-ui',\n          priority: 0,\n          chunks: 'all',\n          test: /[\\\\/]element-ui[\\\\/]/,\n        },\n        api: {\n          name: 'api',\n          priority: 0,\n          test: /[\\\\/]api[\\\\/]/,\n        },\n        subApi: {\n          name: 'subApi',\n          priority: 10,\n          minChunks: 2,\n          test: /[\\\\/]api[\\\\/]subApi[\\\\/]/,\n        },\n        mixin: {\n          name: 'mixin',\n          priority: 0,\n          test: /[\\\\/]mixin[\\\\/]/,\n        },\n      },\n    },\n  },\n}\n"})}),"\n",(0,l.jsxs)(e.p,{children:[(0,l.jsx)(e.a,{href:"https://web.dev/granular-chunking-nextjs",children:"Next.js granular chunking configuration"}),":"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-ts",children:"module.exports = {\n  optimization: {\n    splitChunks: {\n      chunks: chunk => !/^polyfills|main|pages\\/_app$/.test(chunk.name),\n      cacheGroups: {\n        framework: {\n          chunks: 'all',\n          name: 'framework',\n          test(module) {\n            const resource = module.nameForCondition?.()\n            return resource\n              ? topLevelFrameworkPaths.some(pkgPath =>\n                  resource.startsWith(pkgPath)\n                )\n              : false\n          },\n          priority: 40,\n          enforce: true,\n        },\n        lib: {\n          test(module: {\n            size: Function\n            nameForCondition: Function\n          }): boolean {\n            return (\n              module.size() > 160000\n              && /node_modules[/\\\\]/.test(module.nameForCondition() || '')\n            )\n          },\n          name(module: {\n            type: string\n            libIdent?: Function\n            updateHash: (hash: crypto.Hash) => void\n          }): string {\n            const hash = crypto.createHash('sha1')\n            if (isModuleCSS(module)) {\n              module.updateHash(hash)\n            } else {\n              if (!module.libIdent) {\n                throw new Error(\n                  `Encountered unknown module type: ${module.type}.`\n                )\n              }\n              hash.update(module.libIdent({ context: dir }))\n            }\n\n            return hash.digest('hex').substring(0, 8)\n          },\n          priority: 30,\n          minChunks: 1,\n          reuseExistingChunk: true,\n        },\n      },\n      maxInitialRequests: 25,\n      minSize: 20000,\n    },\n  },\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"tree-shaking",children:"Tree Shaking"}),"\n",(0,l.jsxs)(e.p,{children:["Webpack tree shaking ",(0,l.jsx)(e.a,{href:"https://github.com/orgs/web-infra-dev/discussions/17",children:"includes"}),":"]}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"usedExports"})," Optimization:\nRemove unused export variables from modules,\nthereby further eliminating related side-effect-free statements.\nIn ",(0,l.jsx)(e.code,{children:"lib.js"}),", variable ",(0,l.jsx)(e.code,{children:"b"})," is unused,\nso related code is removed from the final output."]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"sideEffects"})," Optimization:\nRemove modules from the module graph where export variables are not used.\nIn ",(0,l.jsx)(e.code,{children:"util.js"}),", no export variables are used and entire module are side-effect-free.\nso ",(0,l.jsx)(e.code,{children:"util.js"})," module is removed from the final output."]}),"\n",(0,l.jsxs)(e.li,{children:["DCE (Dead Code Elimination) Optimization:\nRemove dead code by by general minification tools.\nIn ",(0,l.jsx)(e.code,{children:"bootstrap.js"}),", the ",(0,l.jsx)(e.code,{children:"console.log('bad')"})," statement will not execute,\nso related code is removed from the final output."]}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-ts",children:"// index.js\nimport { a } from './lib'\nimport { c } from './util'\nimport './bootstrap'\n\nconsole.log(a)\n\n// lib.js\nexport const a = 1\nexport const b = 2\n\n// util.js\nexport const c = 3\nexport const d = 4\n\n// bootstrap.js\nconsole.log('bootstrap')\n\nif (false)\n  console.log('bad')\nelse\n  console.log('good')\n"})}),"\n",(0,l.jsx)(e.p,{children:"Write tree-shakable code:"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u907F\u514D\u65E0\u610F\u4E49\u7684\u8D4B\u503C."}),"\n",(0,l.jsx)(e.li,{children:"\u5C3D\u91CF\u4E0D\u5199\u5E26\u6709\u526F\u4F5C\u7528\u7684\u4EE3\u7801: \u8BF8\u5982\u7F16\u5199\u4E86\u7ACB\u5373\u6267\u884C\u51FD\u6570, \u5728\u51FD\u6570\u91CC\u53C8\u4F7F\u7528\u4E86\u5916\u90E8\u53D8\u91CF\u7B49."}),"\n",(0,l.jsx)(e.li,{children:"\u5982\u679C\u5BF9 ES6 \u8BED\u4E49\u7279\u6027\u8981\u6C42\u4E0D\u662F\u7279\u522B\u4E25\u683C, \u53EF\u4EE5\u5F00\u542F babel \u7684 loose \u6A21\u5F0F etc. \u662F\u5426\u771F\u7684\u8981\u4E0D\u53EF\u679A\u4E3E class \u7684\u5C5E\u6027\n(babel \u5C06 Class \u8F6C\u5316\u4E3A ES5 \u8FC7\u7A0B\u4E2D\u4F1A\u4EA7\u751F Side Effect, \u5BFC\u81F4 Tree Shaking \u5931\u6548)."}),"\n",(0,l.jsxs)(e.li,{children:["\u7981\u6B62 Babel \u5C06\u6A21\u5757\u5BFC\u5165\u5BFC\u51FA\u8BED\u53E5\u8F6C\u8BD1\u6210 ",(0,l.jsx)(e.code,{children:"CommonJS"})," \u5F62\u5F0F.","\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"@babel/preset-env"}),": always ",(0,l.jsx)(e.code,{children:'{ "modules": false }'}),"."]}),"\n",(0,l.jsxs)(e.li,{children:["Babel \u4F5C\u4E3A\u7F16\u8BD1\u5668\u4E0D\u5E94\u8BE5\u5904\u7406 ",(0,l.jsx)(e.code,{children:"modules"})," \u7C7B\u578B\u7684\u8F6C\u6362."]}),"\n",(0,l.jsxs)(e.li,{children:["Webpack \u8981\u4F9D\u8D56 ",(0,l.jsx)(e.code,{children:"esm"})," \u6A21\u5757\u8FDB\u884C tree shaking."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u5982\u679C\u662F\u5F00\u53D1 JavaScript \u5E93, \u4F7F\u7528 ",(0,l.jsx)(e.code,{children:"rollup"})," (ES6 module export + code flow static analysis),\n\u5E76\u4E14\u63D0\u4F9B ES6 module \u7684\u7248\u672C, \u5165\u53E3\u6587\u4EF6\u5730\u5740\u8BBE\u7F6E\u5230 ",(0,l.jsx)(e.code,{children:"package.json"})," \u7684 module \u5B57\u6BB5."]}),"\n",(0,l.jsx)(e.li,{children:"\u5982\u679C JavaScript \u5E93\u5F00\u53D1\u4E2D, \u96BE\u4EE5\u907F\u514D\u7684\u4EA7\u751F\u5404\u79CD\u526F\u4F5C\u7528\u4EE3\u7801,\n\u53EF\u4EE5\u5C06\u529F\u80FD\u51FD\u6570\u6216\u8005\u7EC4\u4EF6, \u6253\u5305\u6210\u5355\u72EC\u7684\u6587\u4EF6\u6216\u76EE\u5F55, \u4EE5\u4FBF\u4E8E\u7528\u6237\u53EF\u4EE5\u901A\u8FC7\u76EE\u5F55\u53BB\u52A0\u8F7D.\n\u5982\u6709\u6761\u4EF6, \u4E5F\u53EF\u4E3A\u81EA\u5DF1\u7684\u5E93\u5F00\u53D1\u5355\u72EC\u7684 webpack-loader, \u4FBF\u4E8E\u7528\u6237\u6309\u9700\u52A0\u8F7D."}),"\n",(0,l.jsxs)(e.li,{children:["\u4F18\u5316\u5BFC\u51FA\u7C92\u5EA6, \u4FDD\u6301\u5BFC\u51FA\u503C\u9897\u7C92\u5EA6\u548C\u539F\u5B50\u6027:\n",(0,l.jsx)(e.code,{children:"export { foo, bar }"})," better than ",(0,l.jsx)(e.code,{children:"export default alls"}),"."]}),"\n",(0,l.jsxs)(e.li,{children:["\u4F7F\u7528\u652F\u6301 ",(0,l.jsx)(e.code,{children:"Tree Shaking"})," \u7684\u5305: ",(0,l.jsx)(e.code,{children:"lodash-es"})," or ",(0,l.jsx)(e.code,{children:"babel-plugin-lodash"}),"."]}),"\n"]}),"\n",(0,l.jsx)(e.h3,{id:"build-cache",children:"Build Cache"}),"\n",(0,l.jsxs)(e.p,{children:[(0,l.jsx)(e.code,{children:"cache"})," is set to ",(0,l.jsx)(e.code,{children:"type: 'memory'"})," in development mode\nand disabled in production mode.\n",(0,l.jsx)(e.code,{children:"cache: true"})," is an alias to ",(0,l.jsx)(e.code,{children:"cache: { type: 'memory' }"}),"."]}),"\n",(0,l.jsx)(e.p,{children:"Accelerate second build time:"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-ts",children:"const config = {\n  cache: {\n    type: 'memory',\n  },\n}\n"})}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-ts",children:"const config = {\n  cache: {\n    type: 'filesystem',\n    buildDependencies: {\n      config: [__filename],\n    },\n  },\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"browser-cache",children:"Browser Cache"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["Webpack caching ",(0,l.jsx)(e.a,{href:"https://webpack.js.org/guides/caching",children:"guide"}),"."]}),"\n",(0,l.jsxs)(e.li,{children:["Use ",(0,l.jsx)(e.code,{children:"[contenthash]"})," and long-term browser cache to improve second access time."]}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-ts",children:"const config = new HardSourceWebpackPlugin({\n  // Either an absolute path or relative to webpack options.context.\n  cacheDirectory: 'node_modules/.cache/hard-source/[confighash]',\n  // Either a string of object hash function given a webpack config.\n  configHash: (webpackConfig) => {\n    // node-object-hash on npm can be used to build this.\n    return require('node-object-hash')({ sort: false }).hash(webpackConfig)\n  },\n  // Either false, a string, an object, or a project hashing function.\n  environmentHash: {\n    root: process.cwd(),\n    directories: [],\n    files: ['package-lock.json', 'yarn.lock'],\n  },\n  // An object.\n  info: {\n    // 'none' or 'test'.\n    mode: 'none',\n    // 'debug', 'log', 'info', 'warn', or 'error'.\n    level: 'debug',\n  },\n  // Clean up large, old caches automatically.\n  cachePrune: {\n    // Caches younger than `maxAge` are not considered for deletion. They must\n    // be at least this (default: 2 days) old in milliseconds.\n    maxAge: 2 * 24 * 60 * 60 * 1000,\n    // All caches together must be larger than `sizeThreshold` before any\n    // caches will be deleted. Together they must be at least this\n    // (default: 50 MB) big in bytes.\n    sizeThreshold: 50 * 1024 * 1024,\n  },\n})\n"})}),"\n",(0,l.jsx)(e.h3,{id:"performance-profiling",children:"Performance Profiling"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-ts",children:"const SpeedMeasurePlugin = require('speed-measure-webpack-plugin')\n\nconst smp = new SpeedMeasurePlugin()\n\nconst webpackConfig = smp.wrap({\n  plugins: [new MyPlugin(), new MyOtherPlugin()],\n})\n"})}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:"npx webpack --mode production --profile --json > stats.json\n"})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://github.com/jakoblind/webpack-optimize-helper",children:"Optimize Helper"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://github.com/alexkuz/webpack-chart",children:"Statics Chart"})}),"\n"]})]})}function u(n={}){let{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,l.jsx)(e,{...n,children:(0,l.jsx)(d,{...n})}):d(n)}},30416(n,e,i){i.d(e,{R:()=>o,x:()=>t});var s=i(59471);let l={},r=s.createContext(l);function o(n){let e=s.useContext(r);return s.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function t(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(l):n.components||l:o(n.components),s.createElement(r.Provider,{value:e},n.children)}}}]);