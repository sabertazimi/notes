"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([["4415"],{73835(e,n,t){t.r(n),t.d(n,{metadata:()=>r,default:()=>p,frontMatter:()=>a,contentTitle:()=>l,toc:()=>o,assets:()=>c});var r=JSON.parse('{"id":"web/typescript/internals","title":"Internals","description":"Type System","source":"@site/content/web/typescript/internals.md","sourceDirName":"web/typescript","slug":"/web/typescript/internals","permalink":"/notes/web/typescript/internals","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/typescript/internals.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"TypeScript","permalink":"/notes/tags/type-script"},{"inline":true,"label":"Internals","permalink":"/notes/tags/internals"},{"inline":true,"label":"Compiler","permalink":"/notes/tags/compiler"},{"inline":true,"label":"Covariant","permalink":"/notes/tags/covariant"},{"inline":true,"label":"Contravariant","permalink":"/notes/tags/contravariant"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":23,"frontMatter":{"sidebar_position":23,"tags":["Web","TypeScript","Internals","Compiler","Covariant","Contravariant"]},"sidebar":"tutorialSidebar","previous":{"title":"Performance","permalink":"/notes/web/typescript/performance"},"next":{"title":"Vue","permalink":"/notes/web/vue/"}}'),s=t(62615),i=t(30416);let a={sidebar_position:23,tags:["Web","TypeScript","Internals","Compiler","Covariant","Contravariant"]},l="Internals",c={},o=[{value:"Type System",id:"type-system",level:2},{value:"Covariant",id:"covariant",level:2},{value:"Contravariant",id:"contravariant",level:2},{value:"Compiler",id:"compiler",level:2},{value:"Scanner",id:"scanner",level:2},{value:"Parser",id:"parser",level:2},{value:"Binder",id:"binder",level:2},{value:"Checker",id:"checker",level:2},{value:"Emitter",id:"emitter",level:2},{value:"APIs",id:"apis",level:2}];function d(e){let n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"internals",children:"Internals"})}),"\n",(0,s.jsx)(n.h2,{id:"type-system",children:"Type System"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"TypeScript"})," type system:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Structural type system: type checking focuses on shape (",(0,s.jsx)(n.code,{children:"Duck Typing"}),")."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://github.com/microsoft/TypeScript/issues/14833",children:"Turing complete"})," type system."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"TypeScript"})," type system models ",(0,s.jsx)(n.code,{children:"JavaScript"})," runtime behavior\nand spot out runtime exception."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"covariant",children:"Covariant"}),"\n",(0,s.jsx)(n.p,{children:"Covariant (\u534F\u53D8\u6027):"}),"\n",(0,s.jsxs)(n.p,{children:["Type ",(0,s.jsx)(n.code,{children:"T"})," is ",(0,s.jsx)(n.strong,{children:"covariant"})," if having ",(0,s.jsx)(n.code,{children:"S <: P"}),",\nthen ",(0,s.jsx)(n.code,{children:"T<S> <: T<P>"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"type IsSubtype<S, P> = S extends P ? true : false\n\ntype T1 = IsSubtype<Admin, User>\n// type T1 = true\n\ntype T2 = IsSubtype<Promise<Admin>, Promise<User>>\n// type T2 = true\n\ntype T3 = IsSubtype<'Hello', string>\n// type T3 = true\n\ntype T4 = IsSubtype<Capitalize<'Hello'>, Capitalize<string>>\n// type T4 = true\n"})}),"\n",(0,s.jsx)(n.h2,{id:"contravariant",children:"Contravariant"}),"\n",(0,s.jsx)(n.p,{children:"Contravariant (\u9006\u53D8\u6027):"}),"\n",(0,s.jsxs)(n.p,{children:["Type ",(0,s.jsx)(n.code,{children:"T"})," is ",(0,s.jsx)(n.strong,{children:"contravariant"})," if having ",(0,s.jsx)(n.code,{children:"S <: P"}),",\nthen ",(0,s.jsx)(n.code,{children:"T<P> <: T<S>"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"type IsSubtype<S, P> = S extends P ? true : false\n\ntype Func<Param> = (param: Param) => void\n\ntype T1 = IsSubtype<Admin, User>\n// type T1 = true\n\ntype T2 = IsSubtype<Func<Admin>, Func<User>>\n// type T2 = false\n\ntype T3 = IsSubtype<Func<User>, Func<Admin>>\n// type T3 = true\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"const logAdmin: Func<Admin> = (admin: Admin): void => {\n  console.log(`Name: ${admin.userName}`)\n  console.log(`Is super admin: ${admin.isSuperAdmin.toString()}`)\n}\n\nconst logUser: Func<User> = (user: User): void => {\n  console.log(`Name: ${user.userName}`)\n}\n\nconst admin = new Admin('admin1', true)\n\nlet logger: Func<Admin>\n\nlogger = logUser\nlogger(admin) // OK\n\nlogger = logAdmin\nlogger(admin) // OK\n\nconst user = new User('user1')\n\nlet logger: Func<User>\n\nlogger = logUser\nlogger(user) // OK\n\nlogger = logAdmin\n// Type 'Func<Admin>' is not assignable to type 'Func<User>'.\n//   Property 'isSuperAdmin' is missing in type 'User' but required in type 'Admin'.\nlogger(user) // Oops! `user.isSuperAdmin` is undefined.\n"})}),"\n",(0,s.jsxs)(n.admonition,{title:"Function Types",type:"tip",children:[(0,s.jsx)(n.p,{children:"\u51FD\u6570\u7C7B\u578B\u4E2D:"}),(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u53C2\u6570\u7C7B\u578B\u4E3A\u9006\u53D8."}),"\n",(0,s.jsx)(n.li,{children:"\u8FD4\u56DE\u503C\u7C7B\u578B\u4E3A\u534F\u53D8."}),"\n"]})]}),"\n",(0,s.jsx)(n.admonition,{title:"Array Types",type:"tip",children:(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u5141\u8BB8\u4E0D\u53D8\u7684\u5217\u8868 (",(0,s.jsx)(n.code,{children:"Immutable"}),") \u5728\u5B83\u7684\u53C2\u6570\u7C7B\u578B\u4E0A\u662F\u534F\u53D8\u7684:\n",(0,s.jsx)(n.code,{children:"ConstList<Dog>"})," \u4E3A ",(0,s.jsx)(n.code,{children:"ConstList<Animal>"})," \u7684\u5B50\u7C7B\u578B."]}),"\n",(0,s.jsxs)(n.li,{children:["\u5BF9\u4E8E\u53EF\u53D8\u7684\u5217\u8868 (",(0,s.jsx)(n.code,{children:"Mutable"}),"), \u5176\u53C2\u6570\u7C7B\u578B\u5219\u5FC5\u987B\u662F\u4E0D\u53D8\u7684 (",(0,s.jsx)(n.code,{children:"Invariant"}),"):\n\u65E2\u4E0D\u662F\u534F\u53D8\u4E5F\u4E0D\u662F\u9006\u53D8, \u624D\u80FD\u4FDD\u8BC1\u7C7B\u578B\u5B89\u5168."]}),"\n"]})}),"\n",(0,s.jsx)(n.h2,{id:"compiler",children:"Compiler"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://github.com/Microsoft/TypeScript/tree/main/src/compiler",children:"Compiler"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Scanner \u626B\u63CF\u5668 (",(0,s.jsx)(n.code,{children:"scanner.ts"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:["Parser \u89E3\u6790\u5668 (",(0,s.jsx)(n.code,{children:"parser.ts"}),")."]}),"\n",(0,s.jsxs)(n.li,{children:["Binder \u7ED1\u5B9A\u5668 (",(0,s.jsx)(n.code,{children:"binder.ts"}),")."]}),"\n",(0,s.jsxs)(n.li,{children:["Checker \u68C0\u67E5\u5668 (",(0,s.jsx)(n.code,{children:"checker.ts"}),")."]}),"\n",(0,s.jsxs)(n.li,{children:["Emitter \u53D1\u5C04\u5668 (",(0,s.jsx)(n.code,{children:"emitter.ts"}),")."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"Source Code ~~Scanner~~> Tokens\nTokens ~~Parser~~> AST\nAST ~~Binder~~> Symbols\nAST + Symbols ~~Checker~~> Type Validation\nAST + Checker ~~Emitter~~> JavaScript\n"})}),"\n",(0,s.jsx)(n.h2,{id:"scanner",children:"Scanner"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"// \u5355\u4F8B\u626B\u63CF\u5668\nconst scanner = ts.createScanner(ts.ScriptTarget.Latest, /* \u5FFD\u7565\u6742\u9879 */ true)\n\n// \u6B64\u51FD\u6570\u4E0E\u521D\u59CB\u5316\u4F7F\u7528\u7684 `initializeState` \u51FD\u6570\u76F8\u4F3C\nfunction initializeState(text: string) {\n  scanner.setText(text)\n  scanner.setOnError((message: ts.DiagnosticMessage, length: number) => {\n    console.error(message)\n  })\n  scanner.setScriptTarget(ts.ScriptTarget.ES5)\n  scanner.setLanguageVariant(ts.LanguageVariant.Standard)\n}\n\n// \u4F7F\u7528\u793A\u4F8B\ninitializeState(`const foo = 123;`.trim())\n\n// \u5F00\u59CB\u626B\u63CF\nlet token = scanner.scan()\n\nwhile (token !== ts.SyntaxKind.EndOfFileToken) {\n  console.log(ts.formatSyntaxKind(token))\n  token = scanner.scan()\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"parser",children:"Parser"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"\u7A0B\u5E8F ->\n    CompilerHost.getSourceFile ->\n        (\u5168\u5C40\u51FD\u6570 parser.ts).createSourceFile ->\n            Parser.parseSourceFile\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"function printAllChildren(node: ts.Node, depth = 0) {\n  console.log(\n    Array.from({ length: depth + 1 }, (num, i) => i).join('----'),\n    ts.formatSyntaxKind(node.kind),\n    node.pos,\n    node.end\n  )\n  depth++\n  node.getChildren().forEach(c => printAllChildren(c, depth))\n}\n\nconst sourceCode = `const foo = 123;`.trim()\nconst sourceFile = ts.createSourceFile(\n  'foo.ts',\n  sourceCode,\n  ts.ScriptTarget.ES5,\n  true\n)\nprintAllChildren(sourceFile)\n"})}),"\n",(0,s.jsx)(n.h2,{id:"binder",children:"Binder"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"program.getTypeChecker ->\n    ts.createTypeChecker\uFF08\u68C0\u67E5\u5668\u4E2D\uFF09->\n        initializeTypeChecker\uFF08\u68C0\u67E5\u5668\u4E2D\uFF09 ->\n            for each SourceFile `ts.bindSourceFile`\uFF08\u7ED1\u5B9A\u5668\u4E2D\uFF09\n            for each SourceFile `ts.mergeSymbolTable`\uFF08\u68C0\u67E5\u5668\u4E2D\uFF09\n"})}),"\n",(0,s.jsx)(n.h2,{id:"checker",children:"Checker"}),"\n",(0,s.jsx)(n.p,{children:"\u521D\u59CB\u5316\u68C0\u67E5\u5668:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"program.getTypeChecker ->\n    ts.createTypeChecker\uFF08\u68C0\u67E5\u5668\u4E2D\uFF09->\n        initializeTypeChecker\uFF08\u68C0\u67E5\u5668\u4E2D\uFF09 ->\n            for each SourceFile `ts.bindSourceFile`\uFF08\u7ED1\u5B9A\u5668\u4E2D\uFF09\n            for each SourceFile `ts.mergeSymbolTable`\uFF08\u68C0\u67E5\u5668\u4E2D\uFF09\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u771F\u6B63\u7684\u7C7B\u578B\u68C0\u67E5\u4F1A\u5728\u8C03\u7528 ",(0,s.jsx)(n.code,{children:"getDiagnostics"})," \u65F6\u624D\u53D1\u751F:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"program.emit ->\n    emitWorker (program local) ->\n        createTypeChecker.getEmitResolver ->\n            // \u7B2C\u4E00\u6B21\u8C03\u7528\u4E0B\u9762\u7684\u51E0\u4E2A createTypeChecker \u7684\u672C\u5730\u51FD\u6570\n            call getDiagnostics ->\n                getDiagnosticsWorker ->\n                    checkSourceFile\n\n            // \u63A5\u7740\n            return resolver\n            // \u901A\u8FC7\u5BF9\u672C\u5730\u51FD\u6570 createResolver() \u7684\u8C03\u7528\uFF0Cresolver \u5DF2\u5728 createTypeChecker \u4E2D\u521D\u59CB\u5316\u3002\n"})}),"\n",(0,s.jsx)(n.h2,{id:"emitter",children:"Emitter"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"Program.emit ->\n    `emitWorker` \uFF08\u5728 program.ts \u4E2D\u7684 createProgram\uFF09 ->\n        `emitFiles` \uFF08emitter.ts \u4E2D\u7684\u51FD\u6570\uFF09\n"})}),"\n",(0,s.jsx)(n.h2,{id:"apis",children:"APIs"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"// Path of the file we want to analyze.\n// It's important that @types/react is installed in the same package.\nconst filePath = 'example.jsx'\n\n// Make sure to analyze .js/.jsx files.\nconst options = {\n  allowJs: true,\n  jsx: 'preserve',\n}\n\n// Create a TypeScript compilation environment.\nconst host = ts.createCompilerHost(options)\n\n// Parse and analyze our file, along with dependencies.\nconst program = ts.createProgram([filePath], options, host)\nconst sourceFile = program.getSourceFile(filePath)\nconst checker = program.getTypeChecker()\n\nconst detectedComponents = []\n\nfor (const statement of sourceFile.statements) {\n  if (ts.isVariableStatement(statement)) {\n    for (const declaration of statement.declarationList.declarations) {\n      // \u{1F680} This is where the magic happens.\n      const type = checker.getTypeAtLocation(declaration.name)\n\n      // A type that has call signatures is a function type.\n      for (const callSignature of type.getCallSignatures()) {\n        const returnType = callSignature.getReturnType()\n\n        if (returnType.symbol?.getEscapedName().toString() === 'Element')\n          detectedComponents.push(declaration.name.text)\n      }\n    }\n  }\n}\n\nconsole.log(detectedComponents)\n// [\"Foo\", \"Bar\"]\n"})})]})}function p(e={}){let{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},30416(e,n,t){t.d(n,{R:()=>a,x:()=>l});var r=t(59471);let s={},i=r.createContext(s);function a(e){let n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);