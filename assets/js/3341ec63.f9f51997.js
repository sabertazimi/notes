"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([["3050"],{44420(e,n,t){t.r(n),t.d(n,{metadata:()=>r,default:()=>u,frontMatter:()=>s,contentTitle:()=>i,toc:()=>c,assets:()=>l});var r=JSON.parse('{"id":"web/javascript/storage","title":"Storage","description":"- Cookie for session state.","source":"@site/content/web/javascript/storage.md","sourceDirName":"web/javascript","slug":"/web/javascript/storage","permalink":"/notes/web/javascript/storage","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/javascript/storage.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"JavaScript","permalink":"/notes/tags/java-script"},{"inline":true,"label":"ECMAScript","permalink":"/notes/tags/ecma-script"},{"inline":true,"label":"Storage","permalink":"/notes/tags/storage"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":56,"frontMatter":{"sidebar_position":56,"tags":["Web","JavaScript","ECMAScript","Storage"]},"sidebar":"tutorialSidebar","previous":{"title":"Media","permalink":"/notes/web/javascript/media"},"next":{"title":"Payment","permalink":"/notes/web/javascript/payment"}}'),o=t(62615),a=t(30416);let s={sidebar_position:56,tags:["Web","JavaScript","ECMAScript","Storage"]},i="Storage",l={},c=[{value:"Cookie",id:"cookie",level:2},{value:"Local Storage",id:"local-storage",level:2},{value:"IndexDB",id:"indexdb",level:2},{value:"File",id:"file",level:2}];function d(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"storage",children:"Storage"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Cookie for session state."}),"\n",(0,o.jsx)(n.li,{children:"DOM storage for Web Component state."}),"\n",(0,o.jsx)(n.li,{children:"Web Storage for simple UI options (dark mode, sidebar size, etc.)."}),"\n",(0,o.jsx)(n.li,{children:"IndexedDB for large binary objects and data dumps."}),"\n",(0,o.jsx)(n.li,{children:"Cache API for offline and quick file access."}),"\n",(0,o.jsx)(n.li,{children:"JavaScript variables for everything else."}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"cookie",children:"Cookie"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"name=value"}),".."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"expires=expiration_time"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"path=domain_path"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"domain=domain_name"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"secure"}),"."]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"HTTP/1.1 200 OK\nContent-type: text/html\nSet-Cookie: name=value; expires=Mon, 22-Jan-07 07:10:24 GMT; domain=.foo.com\nOther-header: other-header-value\n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"HTTP/1.1 200 OK\nContent-type: text/html\nSet-Cookie: name=value; domain=.foo.com; path=/; secure\nOther-header: other-header-value\n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",children:"class CookieUtil {\n  static get(name) {\n    const cookieName = `${encodeURIComponent(name)}=`\n    const cookieStart = document.cookie.indexOf(cookieName)\n    let cookieValue = null\n\n    if (cookieStart > -1) {\n      let cookieEnd = document.cookie.indexOf(';', cookieStart)\n\n      if (cookieEnd === -1)\n        cookieEnd = document.cookie.length\n\n      cookieValue = decodeURIComponent(\n        document.cookie.substring(cookieStart + cookieName.length, cookieEnd)\n      )\n    }\n\n    return cookieValue\n  }\n\n  static set(name, value, { expires, path, domain, secure }) {\n    let cookieText = `${encodeURIComponent(name)}=${encodeURIComponent(value)}`\n\n    if (expires instanceof Date)\n      cookieText += `; expires=${expires.toGMTString()}`\n\n    if (path)\n      cookieText += `; path=${path}`\n\n    if (domain)\n      cookieText += `; domain=${domain}`\n\n    if (secure)\n      cookieText += '; secure'\n\n    document.cookie = cookieText\n  }\n\n  static unset(name, { path, domain, secure }) {\n    CookieUtil.set(name, '', new Date(0), path, domain, secure)\n  }\n}\n"})}),"\n",(0,o.jsx)(n.h2,{id:"local-storage",children:"Local Storage"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"\u534F\u540C Cookie."}),"\n",(0,o.jsxs)(n.li,{children:["\u5BF9\u4E8E\u590D\u6742\u5BF9\u8C61\u7684\u8BFB\u53D6\u4E0E\u5B58\u50A8,\n\u9700\u8981\u501F\u52A9 ",(0,o.jsx)(n.code,{children:"JSON.parse"})," \u4E0E ",(0,o.jsx)(n.code,{children:"JSON.stringify"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsxs)(n.a,{href:"https://developer.mozilla.org/docs/Web/API/Storage",children:[(0,o.jsx)(n.code,{children:"Storage"})," object"]}),":","\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"Storage.length"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"Storage.key()"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"Storage.getItem()"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"Storage.setItem()"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"Storage.removeItem()"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"Storage.clear()"}),"."]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"storage"})," event: \u6BCF\u5F53 ",(0,o.jsx)(n.code,{children:"Storage"})," \u5BF9\u8C61\u53D1\u751F\u53D8\u5316\u65F6, \u90FD\u4F1A\u5728\u6587\u6863\u4E0A\u89E6\u53D1 ",(0,o.jsx)(n.code,{children:"storage"})," \u4E8B\u4EF6.","\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"event.domain"}),": \u5B58\u50A8\u53D8\u5316\u5BF9\u5E94\u7684\u57DF."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"event.key"}),": \u88AB\u8BBE\u7F6E\u6216\u5220\u9664\u7684\u952E."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"event.newValue"}),": \u952E\u88AB\u8BBE\u7F6E\u7684\u65B0\u503C, \u82E5\u952E\u88AB\u5220\u9664\u5219\u4E3A null."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"event.oldValue"}),": \u952E\u53D8\u5316\u4E4B\u524D\u7684\u503C."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",children:"if (!localStorage.getItem('bgColor'))\n  populateStorage()\nelse\n  setStyles()\n\nfunction populateStorage() {\n  localStorage.setItem('bgColor', document.getElementById('bgColor').value)\n  localStorage.setItem('font', document.getElementById('font').value)\n  localStorage.setItem('image', document.getElementById('image').value)\n\n  setStyles()\n}\n\nfunction setStyles() {\n  const currentColor = localStorage.getItem('bgColor')\n  const currentFont = localStorage.getItem('font')\n  const currentImage = localStorage.getItem('image')\n\n  document.getElementById('bgColor').value = currentColor\n  document.getElementById('font').value = currentFont\n  document.getElementById('image').value = currentImage\n\n  htmlElem.style.backgroundColor = `#${currentColor}`\n  pElem.style.fontFamily = currentFont\n  imgElem.setAttribute('src', currentImage)\n}\n"})}),"\n",(0,o.jsx)(n.h2,{id:"indexdb",children:"IndexDB"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",children:"class IndexedDB {\n  constructor(dbName, dbVersion, dbUpgrade) {\n    return new Promise((resolve, reject) => {\n      this.db = null\n\n      if (!('indexedDB' in window))\n        reject(new Error('Not supported'))\n\n      const dbOpen = indexedDB.open(dbName, dbVersion)\n\n      if (dbUpgrade) {\n        dbOpen.onupgradeneeded = (e) => {\n          dbUpgrade(dbOpen.result, e.oldVersion, e.newVersion)\n        }\n      }\n\n      dbOpen.onsuccess = () => {\n        this.db = dbOpen.result\n        resolve(this)\n      }\n\n      dbOpen.onerror = (e) => {\n        reject(new Error(`IndexedDB error: ${e.target.errorCode}`))\n      }\n    })\n  }\n\n  get(storeName, name) {\n    return new Promise((resolve, reject) => {\n      const transaction = this.db.transaction(storeName, 'readonly')\n      const store = transaction.objectStore(storeName)\n      const request = store.get(name)\n\n      request.onsuccess = () => {\n        resolve(request.result)\n      }\n\n      request.onerror = () => {\n        reject(request.error)\n      }\n    })\n  }\n\n  set(storeName, name, value) {\n    return new Promise((resolve, reject) => {\n      const transaction = this.db.transaction(storeName, 'readwrite')\n      const store = transaction.objectStore(storeName)\n\n      store.put(value, name)\n\n      transaction.oncomplete = () => {\n        resolve(true)\n      }\n\n      transaction.onerror = () => {\n        reject(transaction.error)\n      }\n    })\n  }\n}\n\nexport class State {\n  static dbName = 'stateDB'\n  static dbVersion = 1\n  static storeName = 'state'\n  static DB = null\n  static target = new EventTarget()\n\n  constructor(observed, updateCallback) {\n    this.updateCallback = updateCallback\n    this.observed = new Set(observed)\n\n    // subscribe `set` event with `updateCallback`\n    State.target.addEventListener('set', (e) => {\n      if (this.updateCallback && this.observed.has(e.detail.name))\n        this.updateCallback(e.detail.name, e.detail.value)\n    })\n  }\n\n  async dbConnect() {\n    State.DB\n      = State.DB\n        || (await new IndexedDB(\n          State.dbName,\n          State.dbVersion,\n          (db, oldVersion, newVersion) => {\n          // upgrade database\n            switch (oldVersion) {\n              case 0: {\n                db.createObjectStore(State.storeName)\n                break\n              }\n              default:\n                throw new Error('Unsupported version!')\n            }\n          }\n        ))\n\n    return State.DB\n  }\n\n  async get(name) {\n    this.observedSet.add(name)\n    const db = await this.dbConnect()\n    return await db.get(State.storeName, name)\n  }\n\n  async set(name, value) {\n    this.observed.add(name)\n    const db = await this.dbConnect()\n    await db.set(State.storeName, name, value)\n\n    // publish event to subscriber\n    const event = new CustomEvent('set', { detail: { name, value } })\n    State.target.dispatchEvent(event)\n  }\n}\n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",children:"const store = db.transaction('users').objectStore('users')\nconst index = store.createIndex('username', 'username', { unique: true })\nconst range = IDBKeyRange.bound('007', 'ace')\n\nconst request = store.openCursor(range, 'next')\nconst request = index.openCursor(range, 'next')\n\nrequest.onsuccess = function (event) {\n  const cursor = event.target.result\n\n  if (cursor) {\n    // \u6C38\u8FDC\u8981\u68C0\u67E5\n    console.log(`Key: ${cursor.key}, Value: ${JSON.stringify(cursor.value)}`)\n    cursor.continue() // \u79FB\u52A8\u5230\u4E0B\u4E00\u6761\u8BB0\u5F55\n  } else {\n    console.log('Done!')\n  }\n}\n"})}),"\n",(0,o.jsx)(n.h2,{id:"file",children:"File"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",children:"function readFileText(file) {\n  return new Promise((resolve, reject) => {\n    const reader = new FileReader()\n    reader.addEventListener('load', () => resolve(reader.result))\n    reader.addEventListener('error', () => reject(reader.error))\n    reader.readAsText(file)\n  })\n}\n\nfunction readFileBuffer(file) {\n  return new Promise((resolve, reject) => {\n    const reader = new FileReader()\n    reader.addEventListener('load', () => resolve(reader.result))\n    reader.addEventListener('error', () => reject(reader.error))\n    reader.readAsArrayBuffer(file)\n  })\n}\n\nconst fileInput = document.querySelector('fileInput')\n\nfor (const file of fileInput.files) {\n  const text = await readFileText(file)\n  const buffer = await readFileBuffer(file)\n}\n"})})]})}function u(e={}){let{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},30416(e,n,t){t.d(n,{R:()=>s,x:()=>i});var r=t(59471);let o={},a=r.createContext(o);function s(e){let n=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);