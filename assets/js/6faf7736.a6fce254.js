"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([["21952"],{19584(e,n,t){t.r(n),t.d(n,{metadata:()=>r,default:()=>d,frontMatter:()=>s,contentTitle:()=>o,toc:()=>c,assets:()=>l});var r=JSON.parse('{"id":"web/react/event","title":"Synthetic Events","description":"- Events delegation:","source":"@site/content/web/react/event.md","sourceDirName":"web/react","slug":"/web/react/event","permalink":"/notes/web/react/event","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/react/event.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"React","permalink":"/notes/tags/react"},{"inline":true,"label":"Event","permalink":"/notes/tags/event"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":3,"frontMatter":{"sidebar_position":3,"tags":["Web","React","Event"]},"sidebar":"tutorialSidebar","previous":{"title":"State","permalink":"/notes/web/react/state"},"next":{"title":"Types","permalink":"/notes/web/react/types"}}'),i=t(62615),a=t(30416);let s={sidebar_position:3,tags:["Web","React","Event"]},o="Synthetic Events",l={},c=[];function v(e){let n={a:"a",code:"code",h1:"h1",header:"header",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"synthetic-events",children:"Synthetic Events"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Events delegation:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["React 16: delegate events handlers on ",(0,i.jsx)(n.code,{children:"document"})," DOM node."]}),"\n",(0,i.jsxs)(n.li,{children:["React 17: delegate events handlers on ",(0,i.jsx)(n.code,{children:"app"})," root DOM node."]}),"\n",(0,i.jsx)(n.li,{children:"\u5148\u5904\u7406\u539F\u751F\u4E8B\u4EF6, \u540E\u5904\u7406 React \u4E8B\u4EF6."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Events dispatching: dispatch native events to ",(0,i.jsx)(n.code,{children:"React.onXXX"})," handlers by ",(0,i.jsx)(n.code,{children:"SyntheticEvent"}),".","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u6536\u96C6\u76D1\u542C\u5668: ",(0,i.jsx)(n.code,{children:"const listeners = accumulateSinglePhaseListeners(targetFiber, eventName)"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["\u6D3E\u53D1\u5408\u6210\u4E8B\u4EF6: ",(0,i.jsx)(n.code,{children:"dispatchQueue.push({ new SyntheticEvent(eventName), listeners })"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["\u6267\u884C\u6D3E\u53D1:\n",(0,i.jsx)(n.code,{children:"processDispatchQueue(dispatchQueue, eventSystemFlags)"}),"\n-> ",(0,i.jsx)(n.code,{children:"executeDispatch(event, listener, currentTarget)"}),"."]}),"\n",(0,i.jsx)(n.li,{children:"Capture event: \u4ECE\u4E0A\u81F3\u4E0B\u8C03\u7528 Fiber \u6811\u4E2D\u7ED1\u5B9A\u7684\u56DE\u8C03\u51FD\u6570."}),"\n",(0,i.jsx)(n.li,{children:"Bubble event: \u4ECE\u4E0B\u81F3\u4E0A\u8C03\u7528 Fiber \u6811\u4E2D\u7ED1\u5B9A\u7684\u56DE\u8C03\u51FD\u6570."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://7kms.github.io/react-illustration-series/main/synthetic-event",children:(0,i.jsx)(n.img,{alt:"React Synthetic Events",src:t(57530).A+"",width:"1090",height:"1248"})})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://github.com/facebook/react/blob/main/packages/react-dom/src/events/DOMPluginEventSystem.js",children:"react-dom/src/events/DOMPluginEventSystem"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"function listenToAllSupportedEvents(rootContainerElement: EventTarget) {\n  if (enableEagerRootListeners) {\n    // 1. \u8282\u6D41\u4F18\u5316, \u4FDD\u8BC1\u5168\u5C40\u6CE8\u518C\u53EA\u88AB\u8C03\u7528\u4E00\u6B21.\n    if (rootContainerElement[listeningMarker])\n      return\n\n    rootContainerElement[listeningMarker] = true\n\n    // 2. \u904D\u5386 allNativeEvents \u76D1\u542C\u5192\u6CE1\u548C\u6355\u83B7\u9636\u6BB5\u7684\u4E8B\u4EF6.\n    allNativeEvents.forEach((domEventName) => {\n      if (!nonDelegatedEvents.has(domEventName)) {\n        listenToNativeEvent(\n          domEventName,\n          false, // \u5192\u6CE1\u9636\u6BB5\u76D1\u542C.\n          rootContainerElement,\n          null,\n        )\n      }\n\n      listenToNativeEvent(\n        domEventName,\n        true, // \u6355\u83B7\u9636\u6BB5\u76D1\u542C.\n        rootContainerElement,\n        null,\n      )\n    })\n  }\n}\n\nfunction listenToNativeEvent(\n  domEventName: DOMEventName,\n  isCapturePhaseListener: boolean,\n  rootContainerElement: EventTarget,\n  targetElement: Element | null,\n  eventSystemFlags?: EventSystemFlags = 0,\n): void {\n  const target = rootContainerElement\n  const listenerSet = getEventListenerSet(target)\n  const listenerSetKey = getListenerSetKey(domEventName, isCapturePhaseListener)\n\n  // \u5229\u7528 Set \u6570\u636E\u7ED3\u6784, \u4FDD\u8BC1\u76F8\u540C\u7684\u4E8B\u4EF6\u7C7B\u578B\u53EA\u4F1A\u88AB\u6CE8\u518C\u4E00\u6B21.\n  if (!listenerSet.has(listenerSetKey)) {\n    if (isCapturePhaseListener)\n      eventSystemFlags |= IS_CAPTURE_PHASE\n\n    // \u6CE8\u518C\u4E8B\u4EF6\u76D1\u542C.\n    addTrappedEventListener(\n      target,\n      domEventName,\n      eventSystemFlags,\n      isCapturePhaseListener,\n    )\n    listenerSet.add(listenerSetKey)\n  }\n}\n\nfunction addTrappedEventListener(\n  targetContainer: EventTarget,\n  domEventName: DOMEventName,\n  eventSystemFlags: EventSystemFlags,\n  isCapturePhaseListener: boolean,\n  isDeferredListenerForLegacyFBSupport?: boolean,\n) {\n  // 1. \u6784\u9020 listener.\n  const listener = createEventListenerWrapperWithPriority(\n    targetContainer,\n    domEventName,\n    eventSystemFlags,\n  )\n\n  // 2. \u6CE8\u518C\u4E8B\u4EF6\u76D1\u542C.\n  let unsubscribeListener\n\n  if (isCapturePhaseListener) {\n    unsubscribeListener = addEventCaptureListener(\n      targetContainer,\n      domEventName,\n      listener,\n    )\n  } else {\n    unsubscribeListener = addEventBubbleListener(\n      targetContainer,\n      domEventName,\n      listener,\n    )\n  }\n}\n\n// \u6CE8\u518C\u539F\u751F\u5192\u6CE1\u4E8B\u4EF6.\nfunction addEventBubbleListener(\n  target: EventTarget,\n  eventType: string,\n  listener: Function,\n): Function {\n  target.addEventListener(eventType, listener, false)\n  return listener\n}\n\n// \u6CE8\u518C\u539F\u751F\u6355\u83B7\u4E8B\u4EF6.\nfunction addEventCaptureListener(\n  target: EventTarget,\n  eventType: string,\n  listener: Function,\n): Function {\n  target.addEventListener(eventType, listener, true)\n  return listener\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://github.com/facebook/react/blob/main/packages/react-dom/src/events/ReactDOMEventListener.js",children:"react-dom/src/events/ReactDOMEventListener"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// \u6D3E\u53D1\u539F\u751F\u4E8B\u4EF6\u81F3 React.onXXX.\nfunction createEventListenerWrapperWithPriority(\n  targetContainer: EventTarget,\n  domEventName: DOMEventName,\n  eventSystemFlags: EventSystemFlags,\n): Function {\n  // 1. \u6839\u636E\u4F18\u5148\u7EA7\u8BBE\u7F6E listenerWrapper.\n  const eventPriority = getEventPriorityForPluginSystem(domEventName)\n  let listenerWrapper\n\n  switch (eventPriority) {\n    case DiscreteEvent:\n      listenerWrapper = dispatchDiscreteEvent\n      break\n    case UserBlockingEvent:\n      listenerWrapper = dispatchUserBlockingUpdate\n      break\n    case ContinuousEvent:\n    default:\n      listenerWrapper = dispatchEvent\n      break\n  }\n\n  // 2. \u8FD4\u56DE listenerWrapper.\n  return listenerWrapper.bind(\n    null,\n    domEventName,\n    eventSystemFlags,\n    targetContainer,\n  )\n}\n\nfunction dispatchDiscreteEvent(\n  domEventName,\n  eventSystemFlags,\n  container,\n  nativeEvent,\n) {\n  const previousPriority = getCurrentUpdatePriority()\n  const prevTransition = ReactCurrentBatchConfig.transition\n  ReactCurrentBatchConfig.transition = null\n\n  try {\n    setCurrentUpdatePriority(DiscreteEventPriority)\n    dispatchEvent(domEventName, eventSystemFlags, container, nativeEvent)\n  } finally {\n    setCurrentUpdatePriority(previousPriority)\n    ReactCurrentBatchConfig.transition = prevTransition\n  }\n}\n\nfunction dispatchContinuousEvent(\n  domEventName,\n  eventSystemFlags,\n  container,\n  nativeEvent,\n) {\n  const previousPriority = getCurrentUpdatePriority()\n  const prevTransition = ReactCurrentBatchConfig.transition\n  ReactCurrentBatchConfig.transition = null\n\n  try {\n    setCurrentUpdatePriority(ContinuousEventPriority)\n    dispatchEvent(domEventName, eventSystemFlags, container, nativeEvent)\n  } finally {\n    setCurrentUpdatePriority(previousPriority)\n    ReactCurrentBatchConfig.transition = prevTransition\n  }\n}\n\nfunction dispatchEvent(\n  domEventName: DOMEventName,\n  eventSystemFlags: EventSystemFlags,\n  targetContainer: EventTarget,\n  nativeEvent: AnyNativeEvent,\n) {\n  let blockedOn = findInstanceBlockingEvent(\n    domEventName,\n    eventSystemFlags,\n    targetContainer,\n    nativeEvent,\n  )\n\n  if (blockedOn === null) {\n    dispatchEventForPluginEventSystem(\n      domEventName,\n      eventSystemFlags,\n      nativeEvent,\n      return_targetInst,\n      targetContainer,\n    )\n    clearIfContinuousEvent(domEventName, nativeEvent)\n    return\n  }\n\n  if (\n    queueIfContinuousEvent(\n      blockedOn,\n      domEventName,\n      eventSystemFlags,\n      targetContainer,\n      nativeEvent,\n    )\n  ) {\n    nativeEvent.stopPropagation()\n    return\n  }\n\n  // We need to clear only if we didn't queue because queueing is accumulative.\n  clearIfContinuousEvent(domEventName, nativeEvent)\n\n  if (\n    eventSystemFlags & IS_CAPTURE_PHASE\n    && isDiscreteEventThatRequiresHydration(domEventName)\n  ) {\n    while (blockedOn !== null) {\n      const fiber = getInstanceFromNode(blockedOn)\n\n      if (fiber !== null)\n        attemptSynchronousHydration(fiber)\n\n      const nextBlockedOn = findInstanceBlockingEvent(\n        domEventName,\n        eventSystemFlags,\n        targetContainer,\n        nativeEvent,\n      )\n\n      if (nextBlockedOn === null) {\n        dispatchEventForPluginEventSystem(\n          domEventName,\n          eventSystemFlags,\n          nativeEvent,\n          return_targetInst,\n          targetContainer,\n        )\n      }\n\n      if (nextBlockedOn === blockedOn)\n        break\n\n      blockedOn = nextBlockedOn\n    }\n\n    if (blockedOn !== null)\n      nativeEvent.stopPropagation()\n\n    return\n  }\n\n  dispatchEventForPluginEventSystem(\n    domEventName,\n    eventSystemFlags,\n    nativeEvent,\n    null,\n    targetContainer,\n  )\n}\n"})})]})}function d(e={}){let{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(v,{...e})}):v(e)}},57530(e,n,t){t.d(n,{A:()=>r});let r=t.p+"assets/images/react-synthetic-events-4c0afc0525ad26f8ec7ec03816133710.png"},30416(e,n,t){t.d(n,{R:()=>s,x:()=>o});var r=t(59471);let i={},a=r.createContext(i);function s(e){let n=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);