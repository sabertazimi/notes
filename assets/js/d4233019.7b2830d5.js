"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([["19202"],{50495(n,e,r){r.r(e),r.d(e,{metadata:()=>o,default:()=>u,frontMatter:()=>i,contentTitle:()=>l,toc:()=>d,assets:()=>c});var o=JSON.parse('{"id":"web/react/render","title":"Render","description":"Reconciler construct Fiber tree:","source":"@site/content/web/react/render.md","sourceDirName":"web/react","slug":"/web/react/render","permalink":"/notes/web/react/render","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/react/render.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"React","permalink":"/notes/tags/react"},{"inline":true,"label":"Internals","permalink":"/notes/tags/internals"},{"inline":true,"label":"Reconciler","permalink":"/notes/tags/reconciler"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":34,"frontMatter":{"sidebar_position":34,"tags":["Web","React","Internals","Reconciler"]},"sidebar":"tutorialSidebar","previous":{"title":"Reconciler","permalink":"/notes/web/react/reconciler"},"next":{"title":"Update","permalink":"/notes/web/react/update"}}'),t=r(62615),s=r(30416);let i={sidebar_position:34,tags:["Web","React","Internals","Reconciler"]},l="Render",c={},d=[{value:"Host Root",id:"host-root",level:2},{value:"Host Component",id:"host-component",level:2}];function a(n){let e={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.header,{children:(0,t.jsx)(e.h1,{id:"render",children:"Render"})}),"\n",(0,t.jsx)(e.p,{children:"Reconciler construct Fiber tree:"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["scheduleUpdateOnFiber:","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u9996\u6B21 render \u76F4\u63A5\u8C03\u7528 ",(0,t.jsx)(e.code,{children:"performWorkOnRoot"}),"."]}),"\n",(0,t.jsxs)(e.li,{children:["\u518D\u6B21 render \u9700\u8981\u8C03\u7528 ",(0,t.jsx)(e.code,{children:"ensureRootIsScheduled"}),"."]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.li,{children:"ensureRootIsScheduled."}),"\n",(0,t.jsx)(e.li,{children:"flushSyncCallbacks."}),"\n",(0,t.jsxs)(e.li,{children:["performSyncWorkOnRoot / performConcurrentWorkOnRoot:","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"performConcurrentWorkOnRoot"})," \u652F\u6301\u53EF\u4E2D\u65AD\u6E32\u67D3:","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u6B64\u51FD\u6570\u9996\u5148\u68C0\u67E5\u662F\u5426\u5904\u4E8E render \u8FC7\u7A0B\u4E2D,\n\u662F\u5426\u9700\u8981\u6062\u590D\u4E0A\u4E00\u6B21\u6E32\u67D3."}),"\n",(0,t.jsxs)(e.li,{children:["\u5982\u679C\u672C\u6B21\u6E32\u67D3\u88AB\u4E2D\u65AD,\n\u6B64\u51FD\u6570\u6700\u540E\u8FD4\u56DE\u4E00\u4E2A\u65B0\u7684 ",(0,t.jsx)(e.code,{children:"performConcurrentWorkOnRoot"})," \u51FD\u6570,\n\u7B49\u5F85\u4E0B\u4E00\u6B21 Scheduler \u8C03\u5EA6."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["renderRootSync / renderRootConcurrent:","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u6B64\u51FD\u6570\u4F1A\u8C03\u7528 ",(0,t.jsx)(e.code,{children:"prepareFreshStack"}),", \u91CD\u7F6E FiberRoot \u4E0A\u7684\u5168\u5C40\u5C5E\u6027, \u91CD\u7F6E Fiber work loop \u5168\u5C40\u53D8\u91CF."]}),"\n",(0,t.jsxs)(e.li,{children:["\u6B64\u51FD\u6570\u4F1A\u8BBE\u7F6E ",(0,t.jsx)(e.code,{children:"workInProgressRoot = FiberRoot"}),", \u8868\u793A\u6B63\u5728\u8FDB\u884C render."]}),"\n",(0,t.jsxs)(e.li,{children:["\u6B64\u51FD\u6570\u9000\u51FA\u524D, \u4F1A\u91CD\u7F6E ",(0,t.jsx)(e.code,{children:"workInProgressRoot = null"}),", \u8868\u793A\u6CA1\u6709\u6B63\u5728\u8FDB\u884C\u4E2D\u7684 render."]}),"\n",(0,t.jsxs)(e.li,{children:["\u6B64\u51FD\u6570\u9000\u51FA\u524D, \u4F1A\u6302\u8F7D ",(0,t.jsx)(e.code,{children:"FiberRoot.finishedWork = workInProgressHostRootFiber"}),".\n\u6B64\u65F6 ",(0,t.jsx)(e.code,{children:"HostRootFiber"})," \u4E0A\u6302\u8F7D\u4E86\u526F\u4F5C\u7528\u961F\u5217, \u5C42\u7EA7\u8D8A\u6DF1\u5B50\u8282\u70B9\u526F\u4F5C\u7528\u8D8A\u9760\u524D."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["workLoopSync / workLoopConcurrent:\n\u5FAA\u73AF\u8C03\u7528 ",(0,t.jsx)(e.code,{children:"performUnitOfWork"}),",\n\u76F4\u5230 ",(0,t.jsx)(e.code,{children:"workInProgress === null"})," \u6216\u7528\u5B8C\u5F53\u524D\u65F6\u95F4\u5206\u7247."]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"performUnitOfWork(workInProgress)"}),":","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u5B58\u5728\u5B50\u8282\u70B9\uFF0C ",(0,t.jsx)(e.code,{children:"beginWork"})," \u4E0E ",(0,t.jsx)(e.code,{children:"completeUnitOfWork"})," \u4E0D\u5728\u540C\u4E00\u6B21\u5FAA\u73AF\u91CC\u8C03\u7528:\n\u6267\u884C\u5B8C ",(0,t.jsx)(e.code,{children:"beginWork"})," \u540E,\n\u4F18\u5148\u5411\u4E0B\u904D\u5386, \u6267\u884C\u5B50\u8282\u70B9\u7684 ",(0,t.jsx)(e.code,{children:"beginWork"})," \u4E0E ",(0,t.jsx)(e.code,{children:"completeUnitOfWork"}),",\n\u5728 N \u6B21\u5FAA\u73AF\u540E\u518D\u5411\u4E0A\u56DE\u6EAF."]}),"\n",(0,t.jsxs)(e.li,{children:["\u4E0D\u5B58\u5728\u5B50\u8282\u70B9\uFF0C ",(0,t.jsx)(e.code,{children:"beginWork"})," \u4E0E ",(0,t.jsx)(e.code,{children:"completeUnitOfWork"})," \u5728\u540C\u4E00\u6B21\u5FAA\u73AF\u91CC\u8C03\u7528."]}),"\n",(0,t.jsxs)(e.li,{children:["\u82E5 ",(0,t.jsx)(e.code,{children:"beginWork"})," \u8FD4\u56DE ",(0,t.jsx)(e.code,{children:"next"})," \u8282\u70B9,\n\u5219\u8BBE\u7F6E ",(0,t.jsx)(e.code,{children:"workInProgress = next"})," \u8FDB\u884C DFS \u904D\u5386,\n\u518D\u6B21\u8C03\u7528\u6B64\u51FD\u6570."]}),"\n",(0,t.jsxs)(e.li,{children:["\u82E5 ",(0,t.jsx)(e.code,{children:"beginWork"})," \u8FD4\u56DE ",(0,t.jsx)(e.code,{children:"null"})," \u8282\u70B9,\n\u5219\u8C03\u7528 ",(0,t.jsx)(e.code,{children:"completeUnitOfWork"})," \u51FD\u6570\u5B8C\u6210\u8282\u70B9\u5904\u7406."]}),"\n",(0,t.jsxs)(e.li,{children:["\u82E5\u5B58\u5728\u5144\u5F1F\u8282\u70B9,\n",(0,t.jsx)(e.code,{children:"completeUnitOfWork"})," \u4F1A\u8BBE\u7F6E ",(0,t.jsx)(e.code,{children:"workInProgress = siblingFiber"})," \u8FDB\u884C DFS \u904D\u5386,\n\u518D\u6B21\u8C03\u7528\u6B64\u51FD\u6570."]}),"\n",(0,t.jsxs)(e.li,{children:["\u82E5\u5230\u8FBE\u5B50\u53F6\u8282\u70B9,\n",(0,t.jsx)(e.code,{children:"completeUnitOfWork"})," \u4F1A\u8BBE\u7F6E ",(0,t.jsx)(e.code,{children:"workInProgress = returnFiber"})," \u8FDB\u884C DFS \u56DE\u6EAF,\n\u518D\u6B21\u8C03\u7528\u6B64\u51FD\u6570."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"beginWork"}),":","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u6839\u636E ",(0,t.jsx)(e.code,{children:"ReactElement"})," \u5BF9\u8C61\u521B\u5EFA\u6240\u6709\u7684 Fiber \u8282\u70B9, \u6700\u7EC8\u6784\u9020\u51FA Fiber \u6811\u5F62\u7ED3\u6784\n(\u8BBE\u7F6E ",(0,t.jsx)(e.code,{children:"return"})," \u548C ",(0,t.jsx)(e.code,{children:"sibling"})," \u6307\u9488)."]}),"\n",(0,t.jsxs)(e.li,{children:["\u8C03\u7528 ",(0,t.jsx)(e.code,{children:"updateXXX"}),", \u8BBE\u7F6E ",(0,t.jsx)(e.code,{children:"fiber.flags"}),"/",(0,t.jsx)(e.code,{children:"fiber.stateNode"})," \u7B49\u72B6\u6001."]}),"\n",(0,t.jsxs)(e.li,{children:["\u975E\u5B50\u53F6\u8282\u70B9\u8FD4\u56DE\u5B50\u8282\u70B9, \u8FDB\u884C DFS \u904D\u5386; \u5B50\u53F6\u8282\u70B9\u8FD4\u56DE ",(0,t.jsx)(e.code,{children:"null"}),", \u76F4\u63A5\u8FDB\u5165 ",(0,t.jsx)(e.code,{children:"completeUnitOfWork"})," \u9636\u6BB5."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"updateHostRoot/updateXXXComponent"}),":","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u6839\u636E ",(0,t.jsx)(e.code,{children:"fiber.pendingProps"}),"/",(0,t.jsx)(e.code,{children:"fiber.updateQueue"})," \u7B49\u8F93\u5165\u6570\u636E\u72B6\u6001,\n\u8BA1\u7B97 ",(0,t.jsx)(e.code,{children:"fiber.memoizedState"})," \u4F5C\u4E3A\u8F93\u51FA\u72B6\u6001."]}),"\n",(0,t.jsxs)(e.li,{children:["ClassComponent:","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u6784\u5EFA ",(0,t.jsx)(e.code,{children:"React.Component"})," \u5B9E\u4F8B."]}),"\n",(0,t.jsxs)(e.li,{children:["\u628A\u65B0\u5B9E\u4F8B\u6302\u8F7D\u5230 ",(0,t.jsx)(e.code,{children:"fiber.stateNode"})," \u4E0A."]}),"\n",(0,t.jsxs)(e.li,{children:["\u6267\u884C ",(0,t.jsx)(e.code,{children:"render"})," \u4E4B\u524D\u7684\u751F\u547D\u5468\u671F\u51FD\u6570."]}),"\n",(0,t.jsxs)(e.li,{children:["\u6267\u884C ",(0,t.jsx)(e.code,{children:"render"})," \u65B9\u6CD5, \u83B7\u53D6\u4E0B\u7EA7 ",(0,t.jsx)(e.code,{children:"ReactElement"}),"."]}),"\n",(0,t.jsxs)(e.li,{children:["\u8BBE\u7F6E ",(0,t.jsx)(e.code,{children:"fiber.flags"}),", \u6807\u8BB0\u526F\u4F5C\u7528."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["FunctionComponent:","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u6267\u884C ",(0,t.jsx)(e.code,{children:"renderWithHooks()"})," -> ",(0,t.jsx)(e.code,{children:"FunctionComponent()"}),", \u83B7\u53D6\u4E0B\u7EA7 ",(0,t.jsx)(e.code,{children:"ReactElement"}),"."]}),"\n",(0,t.jsxs)(e.li,{children:["\u8BBE\u7F6E ",(0,t.jsx)(e.code,{children:"fiber.flags"}),", \u6807\u8BB0\u526F\u4F5C\u7528."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["HostComponent.","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"pendingProps.children"})," \u4F5C\u4E3A\u4E0B\u7EA7 ",(0,t.jsx)(e.code,{children:"ReactElement"}),"."]}),"\n",(0,t.jsxs)(e.li,{children:["\u5982\u679C\u4E0B\u7EA7\u8282\u70B9\u662F\u6587\u672C\u8282\u70B9, \u5219\u8BBE\u7F6E\u4E0B\u7EA7\u8282\u70B9\u4E3A ",(0,t.jsx)(e.code,{children:"null"})," (\u8FDB\u5165 ",(0,t.jsx)(e.code,{children:"completeUnitOfWork"})," \u9636\u6BB5)."]}),"\n",(0,t.jsxs)(e.li,{children:["\u8BBE\u7F6E ",(0,t.jsx)(e.code,{children:"fiber.flags"}),", \u6807\u8BB0\u526F\u4F5C\u7528."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\u6839\u636E\u5B9E\u9645\u60C5\u51B5, \u8BBE\u7F6E ",(0,t.jsx)(e.code,{children:"fiber.flags"}),", \u6807\u8BB0\u526F\u4F5C\u7528."]}),"\n",(0,t.jsxs)(e.li,{children:["\u6839\u636E\u83B7\u53D6\u7684\u4E0B\u7EA7 ",(0,t.jsx)(e.code,{children:"ReactElement"})," \u5BF9\u8C61, \u8C03\u7528 ",(0,t.jsx)(e.code,{children:"reconcileChildren"})," \u751F\u6210 ",(0,t.jsx)(e.code,{children:"Fiber"})," \u5B50\u8282\u70B9 (\u53EA\u751F\u6210\u6B21\u7EA7\u5B50\u8282\u70B9)."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"ReactDOMComponent.createElement()"})," / ",(0,t.jsx)(e.code,{children:"ReactClassComponent.render()"})," / ",(0,t.jsx)(e.code,{children:"ReactFunctionComponent()"}),"."]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"reconcileChildren"}),"."]}),"\n",(0,t.jsxs)(e.li,{children:["mountChildFibers/reconcileChildFibers:","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"mountChildFibers"}),": similar logic, not tracking side effects."]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"reconcileChildFibers"}),": similar logic, tracking side effects."]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"reconcileSingleElement"}),"."]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"reconcileSingleTextNode"}),"."]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"reconcileSinglePortal"}),"."]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"reconcileChildrenArray"}),"."]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"reconcileChildrenIterator"}),"."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"completeUnitOfWork"}),":","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u5F53 ",(0,t.jsx)(e.code,{children:"reconcileChildren"})," \u8FD4\u56DE\u503C\u4E3A ",(0,t.jsx)(e.code,{children:"null"})," \u65F6, \u8868\u793A DFS \u8FDB\u884C\u5230\u5B50\u53F6\u8282\u70B9,\n",(0,t.jsx)(e.code,{children:"performUnitOfWork"})," \u4F1A\u8C03\u7528 ",(0,t.jsx)(e.code,{children:"completeUnitOfWork"})," \u51FD\u6570."]}),"\n",(0,t.jsxs)(e.li,{children:["\u8C03\u7528 ",(0,t.jsx)(e.code,{children:"completeWork"})," \u8FDB\u884C ",(0,t.jsx)(e.code,{children:"render"}),"."]}),"\n",(0,t.jsxs)(e.li,{children:["\u628A\u5F53\u524D Fiber \u5BF9\u8C61\u7684\u526F\u4F5C\u7528\u961F\u5217 (",(0,t.jsx)(e.code,{children:"firstEffect"})," \u4E0E ",(0,t.jsx)(e.code,{children:"lastEffect"}),")\n\u52A0\u5230\u7236\u8282\u70B9\u7684\u526F\u4F5C\u7528\u961F\u5217\u4E4B\u540E, \u66F4\u65B0\u7236\u8282\u70B9\u7684 ",(0,t.jsx)(e.code,{children:"firstEffect"})," \u548C ",(0,t.jsx)(e.code,{children:"lastEffect"})," \u6307\u9488."]}),"\n",(0,t.jsxs)(e.li,{children:["\u8BC6\u522B ",(0,t.jsx)(e.code,{children:"beginWork"})," \u9636\u6BB5\u8BBE\u7F6E\u7684 ",(0,t.jsx)(e.code,{children:"fiber.flags"}),",\n\u82E5\u5F53\u524D Fiber \u5B58\u5728\u526F\u4F5C\u7528 (Effects),\n\u5219\u5C06\u5F53\u524D Fiber \u52A0\u5165\u5230\u7236\u8282\u70B9\u7684 Effects \u961F\u5217,\n\u7B49\u5F85 Commit \u9636\u6BB5\u5904\u7406."]}),"\n",(0,t.jsxs)(e.li,{children:["\u5C06 ",(0,t.jsx)(e.code,{children:"workInProgress"})," \u8BBE\u7F6E\u4E3A ",(0,t.jsx)(e.code,{children:"siblingFiber"})," (DFS \u904D\u5386) \u6216 ",(0,t.jsx)(e.code,{children:"returnFiber"})," (DFS \u56DE\u6EAF),\n\u7EE7\u7EED\u6784\u5EFA Fiber \u6811."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"completeWork"}),":","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u521B\u5EFA DOM \u5B9E\u4F8B, \u7ED1\u5B9A\u81F3 ",(0,t.jsx)(e.code,{children:"HostComponent"}),"/",(0,t.jsx)(e.code,{children:"HostText"})," ",(0,t.jsx)(e.code,{children:"fiber.stateNode"})," (\u5C40\u90E8\u72B6\u6001)."]}),"\n",(0,t.jsx)(e.li,{children:"\u8BBE\u7F6E DOM \u8282\u70B9\u5C5E\u6027, \u7ED1\u5B9A\u4E8B\u4EF6."}),"\n",(0,t.jsxs)(e.li,{children:["\u8BBE\u7F6E ",(0,t.jsx)(e.code,{children:"fiber.flags"}),", \u6536\u96C6\u526F\u4F5C\u7528."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ts",children:"export function scheduleUpdateOnFiber(\n  fiber: Fiber,\n  lane: Lane,\n  eventTime: number\n) {\n  const root = markUpdateLaneFromFiberToRoot(fiber, lane)\n\n  if (lane === SyncLane) {\n    if (\n      (executionContext & LegacyUnbatchedContext) !== NoContext\n      && (executionContext & (RenderContext | CommitContext)) === NoContext\n    ) {\n      // \u521D\u6B21\u6E32\u67D3.\n      performSyncWorkOnRoot(root)\n    } else {\n      // \u5BF9\u6BD4\u66F4\u65B0.\n      ensureRootIsScheduled(root, eventTime)\n    }\n  }\n\n  mostRecentlyUpdatedRoot = root\n}\n\nfunction performSyncWorkOnRoot(root) {\n  // 1. \u83B7\u53D6\u672C\u6B21render\u7684\u4F18\u5148\u7EA7, \u521D\u6B21\u6784\u9020\u8FD4\u56DE NoLanes.\n  const lanes = getNextLanes(root, NoLanes)\n  // 2. \u4ECEroot\u8282\u70B9\u5F00\u59CB, \u81F3\u4E0A\u800C\u4E0B\u66F4\u65B0.\n  const exitStatus = renderRootSync(root, lanes)\n  // 3. \u5C06\u6700\u65B0\u7684 Fiber \u6811\u6302\u8F7D\u5230 root.finishedWork \u8282\u70B9\u4E0A.\n  const finishedWork: Fiber = root.current.alternate\n  root.finishedWork = finishedWork\n  root.finishedLanes = lanes\n  // 4. \u8FDB\u5165 Commit \u9636\u6BB5.\n  commitRoot(root)\n}\n\nfunction performConcurrentWorkOnRoot(root) {\n  const originalCallbackNode = root.callbackNode\n\n  // 1. \u5237\u65B0 pending \u72B6\u6001\u7684 effects, \u6709\u53EF\u80FD\u67D0\u4E9B effect \u4F1A\u53D6\u6D88\u672C\u6B21\u4EFB\u52A1.\n  const didFlushPassiveEffects = flushPassiveEffects()\n\n  if (didFlushPassiveEffects) {\n    if (root.callbackNode !== originalCallbackNode) {\n      // \u4EFB\u52A1\u88AB\u53D6\u6D88, \u9000\u51FA\u8C03\u7528.\n      return null\n    } else {\n      // Current task was not canceled. Continue.\n    }\n  }\n\n  // 2. \u83B7\u53D6\u672C\u6B21\u6E32\u67D3\u7684\u4F18\u5148\u7EA7.\n  const lanes = getNextLanes(\n    root,\n    root === workInProgressRoot ? workInProgressRootRenderLanes : NoLanes\n  )\n\n  // 3. \u6784\u9020 Fiber \u6811.\n  const exitStatus = renderRootConcurrent(root, lanes)\n\n  if (\n    includesSomeLane(\n      workInProgressRootIncludedLanes,\n      workInProgressRootUpdatedLanes\n    )\n  ) {\n    // \u5982\u679C\u5728 render \u8FC7\u7A0B\u4E2D\u4EA7\u751F\u4E86\u65B0 update, \u4E14\u65B0 update \u7684\u4F18\u5148\u7EA7\u4E0E\u6700\u521D render \u7684\u4F18\u5148\u7EA7\u6709\u4EA4\u96C6.\n    // \u90A3\u4E48\u6700\u521D render \u65E0\u6548, \u4E22\u5F03\u6700\u521D render \u7684\u7ED3\u679C, \u7B49\u5F85\u4E0B\u4E00\u6B21\u8C03\u5EA6.\n    prepareFreshStack(root, NoLanes)\n  } else if (exitStatus !== RootIncomplete) {\n    // 4. \u5F02\u5E38\u5904\u7406: \u6709\u53EF\u80FDfiber\u6784\u9020\u8FC7\u7A0B\u4E2D\u51FA\u73B0\u5F02\u5E38.\n    if (exitStatus === RootError)\n      processError()\n\n    const finishedWork = root.current.alternate // Fiber\n    root.finishedWork = finishedWork\n    root.finishedLanes = lanes\n\n    // 5. \u8F93\u51FA: \u6E32\u67D3 Fiber\u6811.\n    finishConcurrentRender(root, exitStatus, lanes)\n  }\n\n  // \u9000\u51FA\u524D\u518D\u6B21\u68C0\u6D4B, \u662F\u5426\u8FD8\u6709\u5176\u4ED6\u66F4\u65B0, \u662F\u5426\u9700\u8981\u53D1\u8D77\u65B0\u8C03\u5EA6.\n  ensureRootIsScheduled(root, now())\n\n  if (root.callbackNode === originalCallbackNode) {\n    // \u6E32\u67D3\u88AB\u963B\u65AD, \u8FD4\u56DE\u4E00\u4E2A\u65B0\u7684 performConcurrentWorkOnRoot \u51FD\u6570, \u7B49\u5F85\u4E0B\u4E00\u6B21\u8C03\u5EA6.\n    return performConcurrentWorkOnRoot.bind(null, root)\n  }\n\n  return null\n}\n\nfunction renderRootSync(root: FiberRoot, lanes: Lanes) {\n  const prevExecutionContext = executionContext\n  executionContext |= RenderContext\n\n  // \u5982\u679C FiberRoot \u53D8\u52A8, \u6216\u8005 update.lane \u53D8\u52A8, \u90FD\u4F1A\u5237\u65B0\u6808\u5E27, \u4E22\u5F03\u4E0A\u4E00\u6B21\u6E32\u67D3\u8FDB\u5EA6.\n  if (workInProgressRoot !== root || workInProgressRootRenderLanes !== lanes) {\n    // \u5237\u65B0\u6808\u5E27.\n    prepareFreshStack(root, lanes)\n  }\n  do {\n    try {\n      workLoopSync()\n      break\n    } catch (thrownValue) {\n      handleError(root, thrownValue)\n    }\n  } while (true)\n\n  // \u91CD\u7F6E\u5168\u5C40\u53D8\u91CF, \u8868\u660E render \u7ED3\u675F.\n  executionContext = prevExecutionContext\n  workInProgressRoot = null\n  workInProgressRootRenderLanes = NoLanes\n  return workInProgressRootExitStatus\n}\n\nfunction renderRootConcurrent(root: FiberRoot, lanes: Lanes) {\n  const prevExecutionContext = executionContext\n  executionContext |= RenderContext\n  const prevDispatcher = pushDispatcher()\n\n  // \u5982\u679C FiberRoot \u53D8\u52A8, \u6216\u8005 update.lane \u53D8\u52A8, \u90FD\u4F1A\u5237\u65B0\u6808\u5E27, \u4E22\u5F03\u4E0A\u4E00\u6B21\u6E32\u67D3\u8FDB\u5EA6.\n  if (workInProgressRoot !== root || workInProgressRootRenderLanes !== lanes) {\n    resetRenderTimer()\n    // \u5237\u65B0\u6808\u5E27.\n    prepareFreshStack(root, lanes)\n    startWorkOnPendingInteractions(root, lanes)\n  }\n\n  const prevInteractions = pushInteractions(root)\n\n  do {\n    try {\n      workLoopConcurrent()\n      break\n    } catch (thrownValue) {\n      handleError(root, thrownValue)\n    }\n  } while (true)\n\n  // \u91CD\u7F6E\u5168\u5C40\u53D8\u91CF.\n  resetContextDependencies()\n  popDispatcher(prevDispatcher)\n  executionContext = prevExecutionContext\n\n  // Check if tree has completed.\n  if (workInProgress !== null) {\n    // Still work remaining.\n    return RootIncomplete\n  } else {\n    // Completed tree.\n    // Set this to null to indicate there's no in-progress render.\n    workInProgressRoot = null\n    workInProgressRootRenderLanes = NoLanes\n\n    // Return final exit status.\n    return workInProgressRootExitStatus\n  }\n}\n\nfunction prepareFreshStack(root: FiberRoot, lanes: Lanes) {\n  // \u91CD\u7F6E FiberRoot \u4E0A\u7684\u5C5E\u6027.\n  root.finishedWork = null\n  root.finishedLanes = NoLanes\n  const timeoutHandle = root.timeoutHandle\n\n  if (timeoutHandle !== noTimeout) {\n    root.timeoutHandle = noTimeout\n    cancelTimeout(timeoutHandle)\n  }\n\n  if (workInProgress !== null) {\n    let interruptedWork = workInProgress.return\n    while (interruptedWork !== null) {\n      unwindInterruptedWork(interruptedWork)\n      interruptedWork = interruptedWork.return\n    }\n  }\n\n  // \u91CD\u7F6E\u5168\u5C40\u53D8\u91CF.\n  workInProgressRoot = root\n  workInProgress = createWorkInProgress(root.current, null) // currentHostRootFiber.alternate.\n  workInProgressRootRenderLanes\n    = subtreeRenderLanes\n      = workInProgressRootIncludedLanes\n        = lanes\n  workInProgressRootExitStatus = RootIncomplete\n  workInProgressRootFatalError = null\n  workInProgressRootSkippedLanes = NoLanes\n  workInProgressRootUpdatedLanes = NoLanes\n  workInProgressRootPingedLanes = NoLanes\n}\n\nfunction workLoopSync() {\n  while (workInProgress !== null)\n    performUnitOfWork(workInProgress)\n}\n\nfunction workLoopConcurrent() {\n  // Perform work until Scheduler asks us to yield.\n  while (workInProgress !== null && !shouldYield())\n    performUnitOfWork(workInProgress)\n}\n\nfunction performUnitOfWork(unitOfWork: Fiber): void {\n  // unitOfWork \u5C31\u662F\u88AB\u4F20\u5165\u7684 workInProgress.\n  const current = unitOfWork.alternate\n  const next = beginWork(current, unitOfWork, subtreeRenderLanes)\n  unitOfWork.memoizedProps = unitOfWork.pendingProps\n\n  if (next === null) {\n    // \u5982\u679C\u6CA1\u6709\u6D3E\u751F\u51FA\u65B0\u7684\u4E0B\u7EA7\u8282\u70B9, \u5219\u8FDB\u5165 completeWork \u9636\u6BB5, \u4F20\u5165\u7684\u662F\u5F53\u524D unitOfWork.\n    completeUnitOfWork(unitOfWork)\n  } else {\n    // \u5982\u679C\u6D3E\u751F\u51FA\u65B0\u7684\u4E0B\u7EA7\u8282\u70B9, \u5219\u9012\u5F52\u5904\u7406.\n    workInProgress = next\n  }\n}\n\nfunction _performUnitOfWork_Recursive(unitOfWork: Fiber): void {\n  beginWork(unitOfWork.alternate, unitOfWork, subtreeRenderLanes)\n  if (unitOfWork.child)\n    _performUnitOfWork_Recursive(unitOfWork.child)\n  completeUnitOfWork(unitOfWork)\n  if (unitOfWork.sibling)\n    _performUnitOfWork_Recursive(unitOfWork.sibling)\n}\n\nfunction beginWork(\n  current: Fiber | null,\n  workInProgress: Fiber,\n  renderLanes: Lanes\n): Fiber | null {\n  // 1. \u8BBE\u7F6E workInProgress \u4F18\u5148\u7EA7\u4E3A NoLanes (\u6700\u9AD8\u4F18\u5148\u7EA7).\n  const updateLanes = workInProgress.lanes\n  didReceiveUpdate = false\n  workInProgress.lanes = NoLanes\n\n  // 2. \u6839\u636E workInProgress \u8282\u70B9\u7684\u7C7B\u578B, \u7528\u4E0D\u540C\u7684\u65B9\u6CD5\u6D3E\u751F\u51FA\u5B50\u8282\u70B9.\n  switch (workInProgress.tag) {\n    case ClassComponent: {\n      const Component = workInProgress.type\n      const unresolvedProps = workInProgress.pendingProps\n      const resolvedProps\n        = workInProgress.elementType === Component\n          ? unresolvedProps\n          : resolveDefaultProps(Component, unresolvedProps)\n      return updateClassComponent(\n        current,\n        workInProgress,\n        Component,\n        resolvedProps,\n        renderLanes\n      )\n    }\n    case HostRoot:\n      return updateHostRoot(current, workInProgress, renderLanes)\n    case HostComponent:\n      return updateHostComponent(current, workInProgress, renderLanes)\n    case HostText:\n      return updateHostText(current, workInProgress)\n    case Fragment:\n      return updateFragment(current, workInProgress, renderLanes)\n  }\n}\n\nfunction completeUnitOfWork(unitOfWork: Fiber): void {\n  let completedWork = unitOfWork\n\n  // \u5916\u5C42\u5FAA\u73AF\u63A7\u5236\u5E76\u79FB\u52A8\u6307\u9488 (workInProgress/completedWork).\n  do {\n    const current = completedWork.alternate\n    const returnFiber = completedWork.return\n\n    if ((completedWork.flags & Incomplete) === NoFlags) {\n      // 1. \u5904\u7406 Fiber \u8282\u70B9, \u4F1A\u8C03\u7528\u6E32\u67D3\u5668 (\u5173\u8054 Fiber \u8282\u70B9\u548C DOM \u5BF9\u8C61, \u7ED1\u5B9A\u4E8B\u4EF6\u7B49).\n      const next = completeWork(current, completedWork, subtreeRenderLanes)\n\n      if (next !== null) {\n        // \u5982\u679C\u6D3E\u751F\u51FA\u5176\u4ED6\u7684\u5B50\u8282\u70B9, \u5219\u56DE\u5230 beginWork \u9636\u6BB5\u8FDB\u884C\u5904\u7406.\n        workInProgress = next\n        return\n      }\n\n      // \u91CD\u7F6E\u5B50\u8282\u70B9\u7684\u4F18\u5148\u7EA7.\n      resetChildLanes(completedWork)\n\n      if (\n        returnFiber !== null\n        && (returnFiber.flags & Incomplete) === NoFlags\n      ) {\n        // 2. \u6536\u96C6\u5F53\u524D Fiber \u8282\u70B9\u4EE5\u53CA\u5176\u5B50\u6811\u7684\u526F\u4F5C\u7528 Effects.\n        // 2.1 \u628A\u5B50\u8282\u70B9\u7684\u526F\u4F5C\u7528\u961F\u5217\u6DFB\u52A0\u5230\u7236\u8282\u70B9\u4E0A.\n        if (returnFiber.firstEffect === null)\n          returnFiber.firstEffect = completedWork.firstEffect\n\n        if (completedWork.lastEffect !== null) {\n          if (returnFiber.lastEffect !== null)\n            returnFiber.lastEffect.nextEffect = completedWork.firstEffect\n\n          returnFiber.lastEffect = completedWork.lastEffect\n        }\n\n        // 2.2 \u5982\u679C\u5F53\u524D Fiber \u8282\u70B9\u6709\u526F\u4F5C\u7528, \u5C06\u5176\u6DFB\u52A0\u5230\u5B50\u8282\u70B9\u7684\u526F\u4F5C\u7528\u961F\u5217\u4E4B\u540E.\n        const flags = completedWork.flags\n\n        if (returnFiber.lastEffect !== null)\n          returnFiber.lastEffect.nextEffect = completedWork\n        else\n          returnFiber.firstEffect = completedWork\n\n        returnFiber.lastEffect = completedWork\n      }\n    }\n\n    const siblingFiber = completedWork.sibling\n\n    if (siblingFiber !== null) {\n      // \u5982\u679C\u6709\u5144\u5F1F\u8282\u70B9, \u8FD4\u56DE\u4E4B\u540E\u518D\u6B21\u8FDB\u5165 beginWork \u9636\u6BB5.\n      workInProgress = siblingFiber\n      return\n    }\n\n    // \u79FB\u52A8\u6307\u9488, \u6307\u5411\u4E0B\u4E00\u4E2A\u8282\u70B9.\n    completedWork = returnFiber\n    workInProgress = completedWork\n  } while (completedWork !== null)\n\n  // \u5DF2\u56DE\u6EAF\u5230\u6839\u8282\u70B9, \u8BBE\u7F6E workInProgressRootExitStatus = RootCompleted.\n  if (workInProgressRootExitStatus === RootIncomplete)\n    workInProgressRootExitStatus = RootCompleted\n}\n\nfunction completeWork(\n  current: Fiber | null,\n  workInProgress: Fiber,\n  renderLanes: Lanes\n): Fiber | null {\n  const newProps = workInProgress.pendingProps\n\n  switch (workInProgress.tag) {\n    case HostRoot: {\n      const fiberRoot: FiberRoot = workInProgress.stateNode\n\n      if (fiberRoot.pendingContext) {\n        fiberRoot.context = fiberRoot.pendingContext\n        fiberRoot.pendingContext = null\n      }\n\n      if (current === null || current.child === null) {\n        // \u8BBE\u7F6E fiber.flags.\n        workInProgress.flags |= Snapshot\n      }\n\n      return null\n    }\n    case HostComponent: {\n      popHostContext(workInProgress)\n      const rootContainerInstance = getRootHostContainer()\n      const type = workInProgress.type\n      const currentHostContext = getHostContext()\n\n      // 1. \u521B\u5EFA DOM \u5BF9\u8C61.\n      const instance = createInstance(\n        type,\n        newProps,\n        rootContainerInstance,\n        currentHostContext,\n        workInProgress\n      )\n\n      // 2. \u628A\u5B50\u6811\u4E2D\u7684 DOM \u5BF9\u8C61 append \u5230\u672C\u8282\u70B9\u7684 DOM \u5BF9\u8C61\u4E4B\u540E.\n      appendAllChildren(instance, workInProgress, false, false)\n\n      // 3. \u8BBE\u7F6E stateNode \u5C5E\u6027, \u6307\u5411 DOM \u5BF9\u8C61.\n      workInProgress.stateNode = instance\n\n      if (\n        // 4. \u8BBE\u7F6EDOM\u5BF9\u8C61\u7684\u5C5E\u6027, \u7ED1\u5B9A\u4E8B\u4EF6\u7B49.\n        finalizeInitialChildren(\n          instance,\n          type,\n          newProps,\n          rootContainerInstance,\n          currentHostContext\n        )\n      ) {\n        // \u8BBE\u7F6E fiber.flags (Update).\n        markUpdate(workInProgress)\n      }\n\n      if (workInProgress.ref !== null) {\n        // \u8BBE\u7F6E fiber.flags (Ref).\n        markRef(workInProgress)\n      }\n\n      return null\n    }\n  }\n}\n"})}),"\n",(0,t.jsx)(e.h2,{id:"host-root",children:"Host Root"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ts",children:"function updateHostRoot(current, workInProgress, renderLanes) {\n  // 1. \u72B6\u6001\u8BA1\u7B97, \u66F4\u65B0\u6574\u5408\u5230 workInProgress.memoizedState.\n  const updateQueue = workInProgress.updateQueue\n  const nextProps = workInProgress.pendingProps\n  const prevState = workInProgress.memoizedState\n  const prevChildren = prevState !== null ? prevState.element : null\n  cloneUpdateQueue(current, workInProgress)\n  // \u904D\u5386 updateQueue.shared.pending, \u63D0\u53D6\u6709\u8DB3\u591F\u4F18\u5148\u7EA7\u7684 update\u5BF9\u8C61, \u8BA1\u7B97\u51FA\u6700\u7EC8\u7684\u72B6\u6001 workInProgress.memoizedState.\n  processUpdateQueue(workInProgress, nextProps, null, renderLanes)\n  const nextState = workInProgress.memoizedState\n\n  // 2. \u83B7\u53D6\u4E0B\u7EA7 ReactElement \u5BF9\u8C61.\n  const nextChildren = nextState.element\n  const root: FiberRoot = workInProgress.stateNode\n\n  // 3. \u6839\u636E ReactElement \u5BF9\u8C61, \u8C03\u7528 reconcileChildren \u751F\u6210 Fiber \u5B50\u8282\u70B9 (\u53EA\u751F\u6210\u6B21\u7EA7\u5B50\u8282\u70B9).\n  reconcileChildren(current, workInProgress, nextChildren, renderLanes)\n  return workInProgress.child\n}\n"})}),"\n",(0,t.jsx)(e.h2,{id:"host-component",children:"Host Component"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ts",children:"function updateHostComponent(\n  current: Fiber | null,\n  workInProgress: Fiber,\n  renderLanes: Lanes\n) {\n  // 1. \u72B6\u6001\u8BA1\u7B97, \u7531\u4E8E HostComponent \u662F\u65E0\u72B6\u6001\u7EC4\u4EF6, \u53EA\u9700\u8981\u6536\u96C6 nextProps.\n  const type = workInProgress.type\n  const nextProps = workInProgress.pendingProps\n  const prevProps = current !== null ? current.memoizedProps : null\n\n  // 2. \u83B7\u53D6\u4E0B\u7EA7 ReactElement \u5BF9\u8C61.\n  let nextChildren = nextProps.children\n  const isDirectTextChild = shouldSetTextContent(type, nextProps)\n\n  if (isDirectTextChild) {\n    // \u5982\u679C\u5B50\u8282\u70B9\u53EA\u6709\u4E00\u4E2A\u6587\u672C\u8282\u70B9, \u4E0D\u7528\u518D\u521B\u5EFA\u4E00\u4E2A HostText \u7C7B\u578B\u7684 Fiber.\n    nextChildren = null\n  } else if (prevProps !== null && shouldSetTextContent(type, prevProps)) {\n    // \u8BBE\u7F6E fiber.flags.\n    workInProgress.flags |= ContentReset\n  }\n\n  // \u8BBE\u7F6E fiber.flags.\n  markRef(current, workInProgress)\n\n  // 3. \u6839\u636E ReactElement \u5BF9\u8C61, \u8C03\u7528 reconcileChildren \u751F\u6210 Fiber \u5B50\u8282\u70B9(\u53EA\u751F\u6210\u6B21\u7EA7\u5B50\u8282\u70B9)\n  reconcileChildren(current, workInProgress, nextChildren, renderLanes)\n  return workInProgress.child\n}\n"})})]})}function u(n={}){let{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(a,{...n})}):a(n)}},30416(n,e,r){r.d(e,{R:()=>i,x:()=>l});var o=r(59471);let t={},s=o.createContext(t);function i(n){let e=o.useContext(s);return o.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function l(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:i(n.components),o.createElement(s.Provider,{value:e},n.children)}}}]);