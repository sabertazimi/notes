"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([["89461"],{14476(e,n,t){t.r(n),t.d(n,{metadata:()=>s,default:()=>u,frontMatter:()=>r,contentTitle:()=>i,toc:()=>a,assets:()=>l});var s=JSON.parse('{"id":"web/react/hooks/effects","title":"Effects","description":"Dispatcher","source":"@site/content/web/react/hooks/effects.md","sourceDirName":"web/react/hooks","slug":"/web/react/hooks/effects","permalink":"/notes/web/react/hooks/effects","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/react/hooks/effects.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"React","permalink":"/notes/tags/react"},{"inline":true,"label":"Hook","permalink":"/notes/tags/hook"},{"inline":true,"label":"Effect","permalink":"/notes/tags/effect"}],"version":"current","lastUpdatedBy":"renovate[bot]","lastUpdatedAt":1772011424000,"sidebarPosition":7,"frontMatter":{"sidebar_position":7,"tags":["Web","React","Hook","Effect"]},"sidebar":"tutorialSidebar","previous":{"title":"Context","permalink":"/notes/web/react/hooks/context"},"next":{"title":"Concurrent","permalink":"/notes/web/react/hooks/concurrent"}}'),c=t(62615),o=t(30416);let r={sidebar_position:7,tags:["Web","React","Hook","Effect"]},i="Effects",l={},a=[{value:"Dispatcher",id:"dispatcher",level:2},{value:"Lifecycle",id:"lifecycle",level:2},{value:"Nasty Loop",id:"nasty-loop",level:2},{value:"Dependencies List",id:"dependencies-list",level:2},{value:"Omits",id:"omits",level:3},{value:"Primitives",id:"primitives",level:3},{value:"Functions",id:"functions",level:3},{value:"Comparison",id:"comparison",level:3},{value:"Closure",id:"closure",level:2},{value:"State",id:"state",level:2},{value:"Cleanup",id:"cleanup",level:2},{value:"useEffect",id:"useeffect",level:2},{value:"useLayoutEffect",id:"uselayouteffect",level:2},{value:"useInsertionEffect",id:"useinsertioneffect",level:2},{value:"References",id:"references",level:2}];function d(e){let n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(n.header,{children:(0,c.jsx)(n.h1,{id:"effects",children:"Effects"})}),"\n",(0,c.jsx)(n.h2,{id:"dispatcher",children:"Dispatcher"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-ts",children:"function mountEffect(\n  create: () => (() => void) | void,\n  deps: Array<mixed> | void | null\n): void {\n  return mountEffectImpl(\n    UpdateEffect | PassiveEffect,\n    HookPassive,\n    create,\n    deps\n  )\n}\n\nfunction mountEffectImpl(fiberFlags, hookFlags, create, deps) {\n  const hook = mountWorkInProgressHook()\n  const nextDeps = deps === undefined ? null : deps\n  currentlyRenderingFiber.flags |= fiberFlags // UpdateEffect | PassiveEffect.\n  hook.memoizedState = pushEffect(\n    HasEffect | hookFlags, // PassiveHook.\n    create,\n    undefined,\n    nextDeps\n  )\n}\n\nfunction updateEffect(\n  create: () => (() => void) | void,\n  deps: Array<mixed> | void | null\n): void {\n  return updateEffectImpl(PassiveEffect, HookPassive, create, deps)\n}\n\nfunction updateEffectImpl(fiberFlags, hookFlags, create, deps) {\n  const hook = updateWorkInProgressHook()\n  const nextDeps = deps === undefined ? null : deps\n  let destroy\n\n  if (currentHook !== null) {\n    const prevEffect = currentHook.memoizedState\n    destroy = prevEffect.destroy\n\n    if (nextDeps !== null) {\n      const prevDeps = prevEffect.deps\n\n      if (areHookInputsEqual(nextDeps, prevDeps)) {\n        // \u5982\u679C\u4F9D\u8D56\u4E0D\u53D8, \u65B0\u5EFA Effect (tag \u4E0D\u542B HookHasEffect).\n        // Reconciler.Commit \u9636\u6BB5\u4F1A\u8DF3\u8FC7\u6B64 Effect.\n        pushEffect(hookFlags, create, destroy, nextDeps)\n        return\n      }\n    }\n  }\n\n  // \u5982\u679C\u4F9D\u8D56\u6539\u53D8, \u66F4\u6539 fiber.flags, \u65B0\u5EFA Effect.\n  // Reconciler.Commit \u9636\u6BB5\u4F1A\u518D\u6B21\u6267\u884C\u6B64 Effect.\n  currentlyRenderingFiber.flags |= fiberFlags\n  hook.memoizedState = pushEffect(\n    HasEffect | hookFlags,\n    create,\n    destroy,\n    nextDeps\n  )\n}\n\nfunction pushEffect(tag, create, destroy, deps) {\n  const effect = {\n    tag,\n    create, // User code: effect callback.\n    destroy, // User code: destroy callback.\n    deps, // User code: deps list.\n    next: null,\n  }\n\n  let componentUpdateQueue = currentlyRenderingFiber.updateQueue\n\n  if (componentUpdateQueue === null) {\n    componentUpdateQueue = createFunctionComponentUpdateQueue()\n    currentlyRenderingFiber.updateQueue = componentUpdateQueue\n    componentUpdateQueue.lastEffect = effect.next = effect\n  } else {\n    const lastEffect = componentUpdateQueue.lastEffect\n\n    if (lastEffect === null) {\n      componentUpdateQueue.lastEffect = effect.next = effect\n    } else {\n      // Circular effect list.\n      const firstEffect = lastEffect.next\n      lastEffect.next = effect\n      effect.next = firstEffect\n      componentUpdateQueue.lastEffect = effect\n    }\n  }\n\n  return effect\n}\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"useEffect"})," ",(0,c.jsx)(n.a,{href:"https://jser.dev/2023-07-08-how-does-useeffect-work",children:"quiz"}),":"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-tsx",children:"import * as React from 'react'\nimport { useEffect, useState } from 'react'\nimport { createRoot } from 'react-dom/client'\n\nfunction App() {\n  const [count, setCount] = useState(1)\n  console.log(1)\n  useEffect(() => {\n    console.log(2)\n    return () => {\n      console.log(3)\n    }\n  }, [count])\n\n  useEffect(() => {\n    console.log(4)\n    setCount(count => count + 1)\n  }, [])\n  return <Child count={count} />\n}\n\nfunction Child({ count }) {\n  useEffect(() => {\n    console.log(5)\n    return () => {\n      console.log(6)\n    }\n  }, [count])\n\n  return null\n};\n\nconst root = createRoot(document.getElementById('root'))\nroot.render(<App />)\n// 1 -> Parent initial render\n// 5 -> Child useEffect normal runs\n// 2 -> Parent first useEffect normal runs\n// 4 -> Parent second useEffect normal runs  <-- Causes a state change\n// 1 -> Parent re-render\n// 6 -> Cleanup code in Child's useEffect (return ...)\n// 3 -> Cleanup code in parent's useEffect (return... )\n// 5 -> Child useEffect normal runs (due to dependency on count)\n// 2 -> Parent useEffect normal runs (due to dependency on count)\n"})}),"\n",(0,c.jsx)(n.h2,{id:"lifecycle",children:"Lifecycle"}),"\n",(0,c.jsxs)(n.ol,{children:["\n",(0,c.jsx)(n.li,{children:"React renders UI for current props/state to screen."}),"\n",(0,c.jsx)(n.li,{children:"React cleans up the effect for prev props/state."}),"\n",(0,c.jsxs)(n.li,{children:["React runs the effect for current props/state\n(",(0,c.jsx)(n.code,{children:"useEffect"})," got invoked after ",(0,c.jsx)(n.code,{children:"componentDidMount"}),")."]}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"nasty-loop",children:"Nasty Loop"}),"\n",(0,c.jsxs)(n.p,{children:["The effect hook runs when the component ",(0,c.jsx)(n.code,{children:"mounts"}),"\nbut also when the component ",(0,c.jsx)(n.code,{children:"updates"}),".\nBecause we are setting the state after every data fetch,\nthe component updates and the effect runs again.\nIt fetches the data again and again.\nThat\u2019s a bug and needs to be avoided."]}),"\n",(0,c.jsx)(n.h2,{id:"dependencies-list",children:"Dependencies List"}),"\n",(0,c.jsxs)(n.p,{children:["\u65E0\u8BBA\u662F\u5C06\u7EC4\u4EF6\u7F16\u5199\u4E3A\u7C7B\u8FD8\u662F\u51FD\u6570,\n\u90FD\u5FC5\u987B\u4E3A effect \u54CD\u5E94\u6240\u6709 props \u548C state \u7684\u66F4\u65B0\n(",(0,c.jsx)(n.code,{children:"Reactive Value"}),").\n\u5728\u4F20\u7EDF\u7684 Class Component, \u9700\u8981\u7F16\u5199\u4EE3\u7801\u53BB\u68C0\u6D4B\u8FD9\u4E9B props \u548C state \u662F\u5426\u53D8\u66F4\n(",(0,c.jsx)(n.code,{children:"shouldComponentUpdate"}),", ",(0,c.jsx)(n.code,{children:"componentDidUpdate"}),").\n\u5728 Function Component, \u501F\u52A9 ",(0,c.jsx)(n.code,{children:"useEffect"})," \u53EF\u4EE5\u5B9E\u73B0\u81EA\u52A8\u68C0\u6D4B."]}),"\n",(0,c.jsxs)(n.p,{children:["If one of deps list changes, the hook runs again.\nProvide ",(0,c.jsx)(n.strong,{children:"empty array"})," as second argument to the effect hook\nto avoid activating it on component updates\nbut ",(0,c.jsx)(n.strong,{children:"only for the mounting"})," of the component.\nFor listeners binding, use ",(0,c.jsx)(n.code,{children:"[]"})," deps list should be better."]}),"\n",(0,c.jsx)(n.h3,{id:"omits",children:"Omits"}),"\n",(0,c.jsx)(n.p,{children:"Omit stable values from the deps list:"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"set"})," function returned from ",(0,c.jsx)(n.code,{children:"useState"}),"."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"ref"})," object returned from ",(0,c.jsx)(n.code,{children:"useRef"}),"."]}),"\n"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-tsx",children:"export default function App() {\n  const [count, setCount] = useState(0)\n  const countRef = useRef(count)\n\n  useEffect(() => {\n    countRef.current = count\n  }, [count]) // \u2705 Only count is declared.\n}\n"})}),"\n",(0,c.jsx)(n.h3,{id:"primitives",children:"Primitives"}),"\n",(0,c.jsxs)(n.p,{children:["Primitive values are ",(0,c.jsx)(n.a,{href:"https://react.dev/learn/removing-effect-dependencies",children:"better"}),":"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-ts",children:"function ChatRoom({ options }) {\n  const [message, setMessage] = useState('')\n  const { roomId, serverUrl } = options\n\n  useEffect(() => {\n    const connection = createConnection({\n      roomId,\n      serverUrl,\n    })\n    connection.connect()\n    return () => connection.disconnect()\n  }, [roomId, serverUrl]) // \u2705 All dependencies declared\n}\n"})}),"\n",(0,c.jsx)(n.h3,{id:"functions",children:"Functions"}),"\n",(0,c.jsxs)(n.p,{children:["Functions in ",(0,c.jsx)(n.code,{children:"useEffect"}),":"]}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"If only use some functions inside an effect, move them directly into that effect."}),"\n",(0,c.jsx)(n.li,{children:"Hoisting functions that don\u2019t need props or state outside of component,\nand pull the ones that are used only by an effect inside of that effect."}),"\n",(0,c.jsxs)(n.li,{children:["For useCallback function, it should be in deps list ",(0,c.jsx)(n.code,{children:"useEffect(() => {}, [callback])"})]}),"\n"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-ts",children:"import axios from 'axios'\n// https://www.robinwieruch.de/react-hooks-fetch-data\nimport { useEffect, useState } from 'react'\n\nfunction useDataApi(initialUrl, initialData) {\n  const [data, setData] = useState(initialData)\n  const [url, setUrl] = useState(initialUrl)\n  const [isLoading, setIsLoading] = useState(false)\n  const [isError, setIsError] = useState(false)\n\n  useEffect(() => {\n    const fetchData = async () => {\n      setIsError(false)\n      setIsLoading(true)\n\n      try {\n        const result = await axios(url)\n\n        setData(result.data)\n      } catch (error) {\n        setIsError(true)\n      }\n\n      setIsLoading(false)\n    }\n\n    fetchData()\n  }, [url])\n\n  const doFetch = (url) => {\n    setUrl(url)\n  }\n\n  return { data, isLoading, isError, doFetch }\n}\n"})}),"\n",(0,c.jsx)(n.h3,{id:"comparison",children:"Comparison"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-ts",children:"import { DependencyList, EffectCallback, useEffect, useRef } from 'react'\n\nconst isPrimitive = (val: any) => val !== Object(val)\n\ntype DepsEqualFnType<TDeps extends DependencyList>\n  = (prevDeps: TDeps, nextDeps: TDeps) => boolean\n\nexport default function useCustomCompareEffect<TDeps extends DependencyList>(\n  effect: EffectCallback,\n  deps: TDeps,\n  depsEqual: DepsEqualFnType<TDeps>,\n) {\n  const ref = useRef<TDeps | undefined>(undefined)\n\n  if (!ref.current || !depsEqual(deps, ref.current)) {\n    ref.current = deps\n  }\n\n  useEffect(effect, ref.current)\n}\n"})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-ts",children:"import { DependencyList, EffectCallback } from 'react'\nimport fastDeepEqual from './misc/fastDeepEqual'\nimport useCustomCompareEffect from './useCustomCompareEffect'\n\nconst isPrimitive = (val: any) => val !== Object(val)\n\nexport default function useDeepCompareEffect(\n  effect: EffectCallback,\n  deps: DependencyList,\n) {\n  useCustomCompareEffect(effect, deps, fastDeepEqual)\n}\n"})}),"\n",(0,c.jsx)(n.h2,{id:"closure",children:"Closure"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"useEffect Hook \u4F1A\u4E22\u5F03\u4E0A\u4E00\u6B21\u6E32\u67D3\u7ED3\u679C,\n\u5B83\u4F1A\u6E05\u9664\u4E0A\u4E00\u6B21 effect,\n\u518D\u5EFA\u7ACB\u4E0B\u4E00\u4E2A effect\n(\u4E5F\u4F1A\u521B\u5EFA\u65B0\u7684 Closure),\n\u4E0B\u4E00\u4E2A effect \u9501\u4F4F\u65B0\u7684 props \u548C state\n(\u6574\u4E2A Counter \u51FD\u6570\u5728 re-render \u65F6\u4F1A\u88AB\u91CD\u590D\u8C03\u7528\u4E00\u6B21)."}),"\n",(0,c.jsx)(n.li,{children:"setInterval \u4E0D\u4F1A\u4E22\u5F03\u4E0A\u4E00\u6B21\u7ED3\u679C,\n\u4F1A\u5F15\u7528\u65E7\u72B6\u6001 Closure \u4E2D\u7684\u53D8\u91CF,\n\u5BFC\u81F4\u5176\u4E0E useEffect \u6240\u9884\u671F\u884C\u4E3A\u4E0D\u4E00\u81F4."}),"\n",(0,c.jsx)(n.li,{children:"\u53EF\u4EE5\u901A\u8FC7 useRef \u89E3\u51B3\u8FD9\u4E00\u73B0\u8C61: get latest value."}),"\n"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-tsx",children:"// BUG\nexport default function Counter() {\n  const [count, setCount] = useState(0)\n\n  useEffect(() => {\n    const id = setInterval(() => {\n      setCount(count + 1) // always 1 regardless `count` value change\n    }, 1000)\n    return () => clearInterval(id)\n  }, [])\n\n  return <h1>{count}</h1>\n}\n"})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-tsx",children:"export default function Counter() {\n  const [count, setCount] = useState(0)\n\n  useInterval(() => {\n    setCount(count + 1)\n  }, 1000)\n\n  return <h1>{count}</h1>\n}\n\nfunction useInterval(callback, delay) {\n  const savedCallbackRef = useRef(callback)\n\n  // Remember the latest callback if it changes\n  useEffect(() => {\n    savedCallbackRef.current = callback\n  }, [callback])\n\n  // Set up the interval\n  useEffect(() => {\n    function tick() {\n      savedCallbackRef.current()\n    }\n\n    const id = setInterval(tick, delay)\n    return () => clearInterval(id)\n  }, [delay])\n}\n"})}),"\n",(0,c.jsx)(n.h2,{id:"state",children:"State"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["\u5982 ",(0,c.jsx)(n.code,{children:"UseEffect Closure"})," \u6240\u8FF0, \u6BCF\u6B21\u8C03\u7528 useEffect \u65F6,\n\u4F1A\u6355\u83B7\u90A3\u4E00\u6B21 render \u65F6\u7684 props \u548C state."]}),"\n",(0,c.jsx)(n.li,{children:"Class Component \u4E2D\u7684 this.state.xxx \u5374\u603B\u662F\u6307\u5411\u6700\u65B0\u7684 state."}),"\n"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-tsx",children:"export default function Counter() {\n  const [count, setCount] = useState(0)\n\n  useEffect(() => {\n    const timeout = setTimeout(() => {\n      console.log(`You clicked ${count} times`)\n    }, 3000)\n\n    return () => clearTimeout(timeout)\n  })\n\n  return (\n    <div>\n      <p>\n        You clicked\n        {' '}\n        {count}\n        {' '}\n        times\n      </p>\n      <button type=\"button\" onClick={() => setCount(count + 1)}>Click me</button>\n    </div>\n  )\n}\n// Output:\n// Mounted: You clicked 0 times\n// Clicked 5 times in 3s\n// You clicked 1 times\n// You clicked 2 times\n// You clicked 3 times\n// You clicked 4 times\n// You clicked 5 times\n"})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-tsx",children:"class Counter {\n  componentDidUpdate() {\n    setTimeout(() => {\n      console.log(`You clicked ${this.state.count} times`)\n    }, 3000)\n  }\n\n  render() {\n    const { count } = this.props\n\n    return (\n      <div>\n        <p>\n          You clicked\n          {' '}\n          {count}\n          {' '}\n          times\n        </p>\n        <button type=\"button\" onClick={() => this.setState(count + 1)}>Click me</button>\n      </div>\n    )\n  }\n}\n// Output:\n// Mounted: You clicked 0 times\n// Clicked 5 times in 3s\n// You clicked 5 times\n// You clicked 5 times\n// You clicked 5 times\n// You clicked 5 times\n// You clicked 5 times\n"})}),"\n",(0,c.jsx)(n.h2,{id:"cleanup",children:"Cleanup"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Avoid memory leaks."}),"\n",(0,c.jsx)(n.li,{children:"Prevent unexpected errors."}),"\n",(0,c.jsx)(n.li,{children:"Good user experience."}),"\n"]}),"\n",(0,c.jsxs)(n.p,{children:["Cleanup API requests (",(0,c.jsx)(n.a,{href:"https://maxrozen.com/race-conditions-fetching-data-react-with-useeffect",children:"race condition"}),":"]}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"Boolean"})," flag."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"AbortController"}),"."]}),"\n"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-ts",children:"function App({ url }) {\n  const [results, setResults] = useState([])\n  const [page, setPage] = useState(1)\n\n  // Cleanup with Boolean flag:\n  useEffect(() => {\n    let ignore = false\n    fetchResults(url, page).then((json) => {\n      if (!ignore)\n        setResults(json)\n    })\n    return () => {\n      ignore = true\n    }\n  }, [url, page])\n\n  // Cleanup with AbortController:\n  useEffect(() => {\n    const controller = new AbortController()\n    const { signal } = controller\n\n    const fetchData = async () => {\n      const response = await fetch(url, { signal })\n      const json = await response.json()\n      setResults(json)\n    }\n\n    fetchData()\n\n    return () => controller.abort()\n  }, [url])\n}\n"})}),"\n",(0,c.jsx)(n.p,{children:"Cleanup connections:"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-ts",children:"function App() {\n  useEffect(() => {\n    const socket = new WebSocket('url', protocols)\n    // do what you want with the socket\n\n    return () => socket.close()\n  }, [])\n}\n"})}),"\n",(0,c.jsx)(n.p,{children:"Cleanup timeouts:"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-ts",children:"function App() {\n  useEffect(() => {\n    const timeoutId = setTimeout(() => {\n      // do something in the timeout\n    }, 3000)\n\n    return () => clearTimeout(timeoutId)\n  }, [])\n}\n"})}),"\n",(0,c.jsxs)(n.admonition,{title:"React 18 Development Strict Mode",type:"caution",children:[(0,c.jsxs)(n.p,{children:["With ",(0,c.jsx)(n.code,{children:"Strict Mode"})," in React 18,\nReact will simulate unmounting and remounting component in development mode:"]}),(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["React mounts component:","\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Layout effects are created."}),"\n",(0,c.jsx)(n.li,{children:"Effect effects are created."}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["React simulates unmounting component:","\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Layout effects are destroyed."}),"\n",(0,c.jsx)(n.li,{children:"Effects are destroyed."}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["React simulates mounting component with previous state:","\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Layout effect setup code runs."}),"\n",(0,c.jsx)(n.li,{children:"Effect setup code runs."}),"\n"]}),"\n"]}),"\n"]}),(0,c.jsxs)(n.p,{children:["When ",(0,c.jsx)(n.code,{children:"Strict Mode"})," is on,\nremounts twice helps find out ",(0,c.jsx)(n.code,{children:"Effects"})," need cleanup\nand exposes bugs like race conditions early."]})]}),"\n",(0,c.jsx)(n.h2,{id:"useeffect",children:"useEffect"}),"\n",(0,c.jsxs)(n.p,{children:["Effects are typically used to\n",(0,c.jsx)(n.a,{href:"https://react.dev/learn/synchronizing-with-effects",children:"synchronize with external system"}),":\nbrowser APIs,\nthird-party library,\nnetwork, and so on."]}),"\n",(0,c.jsx)(n.p,{children:"Effects let you specify side effects that are caused by rendering itself,\nrather than by a particular event:"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["Sending a message in the chat is an event\nbecause it is directly caused by user clicking a specific button:\nput it in ",(0,c.jsx)(n.code,{children:"handleClick()"}),"."]}),"\n",(0,c.jsxs)(n.li,{children:["However, setting up a server connection is an ",(0,c.jsx)(n.code,{children:"Effect"}),"\nbecause it needs to happen regardless of\nwhich interaction caused the component to appear:\nput int in ",(0,c.jsx)(n.code,{children:"useEffect()"}),"."]}),"\n"]}),"\n",(0,c.jsxs)(n.p,{children:["If your effect only adjusts some state based on other state,\n",(0,c.jsx)(n.a,{href:"https://react.dev/learn/you-might-not-need-an-effect",children:"you might not need effects"}),":"]}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"You don\u2019t need Effects to transform data for rendering."}),"\n",(0,c.jsx)(n.li,{children:"You don\u2019t need Effects to handle user events."}),"\n"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-ts",children:"function handleClick() {\n  // \u2705 Buying is an event because it is caused by a particular interaction.\n  fetch('/api/buy', { method: 'POST' })\n  showNotification(`Added ${product.name} to the shopping cart!`)\n  navigateTo('/checkout')\n}\n\nfunction Form() {\n  const [firstName, setFirstName] = useState('')\n  const [lastName, setLastName] = useState('')\n\n  // \u2705 Good: calculated during rendering\n  const fullName = `${firstName} ${lastName}`\n\n  // \u2705 Good: This logic runs because the component was displayed\n  useEffect(() => {\n    post('/analytics/event', { eventName: 'visit_form' })\n  }, [])\n\n  function handleSubmit(e) {\n    e.preventDefault()\n    // \u2705 Good: Event-specific logic is in the event handler\n    post('/api/register', { firstName, lastName })\n  }\n  // ...\n}\n"})}),"\n",(0,c.jsx)(n.h2,{id:"uselayouteffect",children:"useLayoutEffect"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"useLayoutEffect"})," callback called ",(0,c.jsx)(n.strong,{children:"synchronously"}),"\n(fires synchronously after all DOM mutations),\nsubstitute for ",(0,c.jsx)(n.code,{children:"componentDidMount"})," lifecycle function:\n",(0,c.jsx)(n.code,{children:"Update"})," effect flags, ",(0,c.jsx)(n.code,{children:"HasEffect | Layout"})," hook flags."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"useEffect"})," got invoked after ",(0,c.jsx)(n.code,{children:"componentDidMount"})," ",(0,c.jsx)(n.strong,{children:"asynchronously"}),":\n",(0,c.jsx)(n.code,{children:"Update | Passive"})," effect flags, ",(0,c.jsx)(n.code,{children:"HasEffect | Passive"})," hook flags."]}),"\n",(0,c.jsxs)(n.li,{children:["Lifecycle of React component:","\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"User interacts, props or state change."}),"\n",(0,c.jsx)(n.li,{children:"React updates DOM."}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"useLayoutEffect"})," hook fires."]}),"\n",(0,c.jsx)(n.li,{children:"Browser paints: visual changes are displayed to user."}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"useEffect"})," hook fires."]}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["If need to mutate DOM directly (visual changes to UI)\nor need to perform DOM measurements,\n",(0,c.jsx)(n.code,{children:"useLayoutEffect"})," is better than ",(0,c.jsx)(n.code,{children:"useEffect"}),"."]}),"\n"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-ts",children:"function mountLayoutEffect(\n  create: () => (() => void) | void,\n  deps: Array<mixed> | void | null\n): void {\n  return mountEffectImpl(\n    UpdateEffect, // Fiber Flags\n    HookLayout, // Hook Flags\n    create,\n    deps\n  )\n}\n\nfunction mountEffect(\n  create: () => (() => void) | void,\n  deps: Array<mixed> | void | null\n): void {\n  return mountEffectImpl(\n    UpdateEffect | PassiveEffect, // Fiber Flags\n    HookPassive, // Hook Flags\n    create,\n    deps\n  )\n}\n\nfunction updateLayoutEffect(\n  create: () => (() => void) | void,\n  deps: Array<mixed> | void | null\n): void {\n  return updateEffectImpl(UpdateEffect, HookLayout, create, deps)\n}\n\nfunction updateEffect(\n  create: () => (() => void) | void,\n  deps: Array<mixed> | void | null\n): void {\n  return updateEffectImpl(PassiveEffect, HookPassive, create, deps)\n}\n"})}),"\n",(0,c.jsx)(n.h2,{id:"useinsertioneffect",children:"useInsertionEffect"}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.a,{href:"https://github.com/reactwg/react-18/discussions/110",children:(0,c.jsx)(n.code,{children:"useInsertionEffect"})}),"\nallows ",(0,c.jsx)(n.code,{children:"CSS-in-JS"})," libraries to address performance\nissues of injecting styles in render:"]}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"useInsertionEffect"})," will run after the DOM is mutated,\nbut before layout effects read the new layout."]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-tsx",children:"function useCSS(rule) {\n  if (!canUseDOM)\n    collectedRulesSet.add(rule)\n\n  useInsertionEffect(() => {\n    if (!isInserted.has(rule)) {\n      isInserted.add(rule)\n      document.head.appendChild(getStyleForRule(rule))\n    }\n  })\n\n  return rule\n}\n\nexport default function Component() {\n  const className = useCSS(rule)\n  return <div className={className} />\n}\n"})}),"\n",(0,c.jsx)(n.p,{children:"In commit phase, the ordering of effects are:"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["Insertion Effects - ",(0,c.jsx)(n.code,{children:"useInsertionEffect()"}),"."]}),"\n",(0,c.jsx)(n.li,{children:"Mutation Effects - host DOM updates diffed from reconciliation."}),"\n",(0,c.jsxs)(n.li,{children:["Layout Effects - ",(0,c.jsx)(n.code,{children:"useLayoutEffect()"}),"."]}),"\n",(0,c.jsxs)(n.li,{children:["Passive Effects - ",(0,c.jsx)(n.code,{children:"useEffect()"}),"."]}),"\n"]}),"\n",(0,c.jsxs)(n.p,{children:["It is synchronous from 1 to 3, the last step of Passive Effects are run\n",(0,c.jsx)(n.a,{href:"https://jser.dev/react/2022/01/19/lifecycle-of-effect-hook/#flushpassiveeffects",children:"in next tick"}),"."]}),"\n",(0,c.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"useEffect"})," complete ",(0,c.jsx)(n.a,{href:"https://overreacted.io/a-complete-guide-to-useeffect",children:"guide"}),"."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"useEffect"})," usage ",(0,c.jsx)(n.a,{href:"https://react.dev/learn/you-might-not-need-an-effect",children:"guide"}),"."]}),"\n"]})]})}function u(e={}){let{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,c.jsx)(n,{...e,children:(0,c.jsx)(d,{...e})}):d(e)}},30416(e,n,t){t.d(n,{R:()=>r,x:()=>i});var s=t(59471);let c={},o=s.createContext(c);function r(e){let n=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:r(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);