"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([["98662"],{97854(e,n,t){t.r(n),t.d(n,{metadata:()=>a,default:()=>c,frontMatter:()=>i,contentTitle:()=>u,toc:()=>l,assets:()=>d});var a=JSON.parse('{"id":"web/react/hooks/state","title":"State","description":"- Read rendered props/state.","source":"@site/content/web/react/hooks/state.md","sourceDirName":"web/react/hooks","slug":"/web/react/hooks/state","permalink":"/notes/web/react/hooks/state","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/react/hooks/state.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"React","permalink":"/notes/tags/react"},{"inline":true,"label":"Hook","permalink":"/notes/tags/hook"},{"inline":true,"label":"State","permalink":"/notes/tags/state"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":1,"frontMatter":{"sidebar_position":1,"tags":["Web","React","Hook","State"]},"sidebar":"tutorialSidebar","previous":{"title":"Hooks","permalink":"/notes/web/react/hooks/"},"next":{"title":"Reducer","permalink":"/notes/web/react/hooks/reducer"}}'),s=t(62615),r=t(30416);let i={sidebar_position:1,tags:["Web","React","Hook","State"]},u="State",d={},l=[{value:"Dispatcher",id:"dispatcher",level:2},{value:"useState",id:"usestate",level:2}];function o(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"state",children:"State"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Read rendered props/state."}),"\n",(0,s.jsxs)(n.li,{children:["Return value of ",(0,s.jsx)(n.code,{children:"useState"})," is ",(0,s.jsx)(n.code,{children:"ref"})," to ",(0,s.jsx)(n.code,{children:"hooks[idx]"}),":\ndirect change to return value doesn't change state value."]}),"\n",(0,s.jsxs)(n.li,{children:["Return function of ",(0,s.jsx)(n.code,{children:"useState"})," (",(0,s.jsx)(n.code,{children:"setState"}),") is to change value of ",(0,s.jsx)(n.code,{children:"hooks[idx]"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["\u7531\u4E8E setState \u66F4\u65B0\u72B6\u6001 (dispatch action) \u65F6\u57FA\u4E8E hook.BaseState,\n",(0,s.jsx)(n.code,{children:"setState(value + 1)"})," \u4E0E ",(0,s.jsx)(n.code,{children:"setState(value => value + 1)"})," \u5B58\u5728\u5DEE\u5F02."]}),"\n",(0,s.jsxs)(n.li,{children:["\u5F53\u5728 useEffect \u4E2D\u8C03\u7528 setState \u65F6, \u6700\u597D\u4F7F\u7528 ",(0,s.jsx)(n.code,{children:"setState(callback)"})," \u5F62\u5F0F,\n\u8FD9\u6837\u53EF\u4EE5\u4E0D\u7528\u518D Deps List \u4E2D\u663E\u5F0F\u58F0\u660E state, \u4E5F\u53EF\u4EE5\u907F\u514D\u4E00\u4E9B BUG."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"dispatchAction"}),":","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u521B\u5EFA ",(0,s.jsx)(n.code,{children:"Update"})," \u5BF9\u8C61."]}),"\n",(0,s.jsx)(n.li,{children:"\u5C06 Update \u5BF9\u8C61\u6DFB\u52A0\u5230 hook.queue.pending \u961F\u5217."}),"\n",(0,s.jsx)(n.li,{children:"\u6839\u636E reducerEagerState \u4E0E currentState, \u51B3\u5B9A\u662F\u5426\u53D1\u8D77\u65B0\u7684 Reconciler \u8C03\u5EA6."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"dispatcher",children:"Dispatcher"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"function mountState<T>(initialState: T) {\n  const hook = mountWorkInProgressHook()\n\n  if (typeof initialState === 'function')\n    initialState = initialState()\n\n  // Setup Hook.\n  hook.memoizedState = hook.baseState = initialState\n  const queue = (hook.queue = {\n    pending: null,\n    dispatch: null,\n    lastRenderedReducer: basicStateReducer,\n    lastRenderedState: initialState,\n  })\n  const dispatch = (queue.dispatch = dispatchAction.bind(\n    null,\n    currentlyRenderingFiber,\n    queue\n  ))\n\n  // Return Hook state and dispatch action.\n  return [hook.memoizedState, dispatch]\n}\n\nfunction updateState<T>(initialState: T) {\n  const basicStateReducer = (state, action) => {\n    return typeof action === 'function' ? action(state) : action\n  }\n\n  return updateReducer(basicStateReducer)\n}\n\nfunction dispatchAction<S, A>(\n  fiber: Fiber,\n  queue: UpdateQueue<S, A>,\n  action: A\n) {\n  // 1. \u521B\u5EFA Update \u5BF9\u8C61.\n  const eventTime = requestEventTime()\n  const lane = requestUpdateLane(fiber)\n  const update: Update<S, A> = {\n    lane,\n    action,\n    eagerReducer: null,\n    eagerState: null,\n    next: null,\n  }\n\n  // 2. \u5C06 Update \u5BF9\u8C61\u6DFB\u52A0\u5230 hook.queue.pending \u961F\u5217.\n  const pending = queue.pending\n  if (pending === null) {\n    // \u9996\u4E2A Update, \u521B\u5EFA\u4E00\u4E2A\u73AF\u5F62\u94FE\u8868.\n    update.next = update\n  } else {\n    update.next = pending.next\n    pending.next = update\n  }\n  queue.pending = update\n\n  const alternate = fiber.alternate\n  if (\n    fiber === currentlyRenderingFiber\n    || (alternate !== null && alternate === currentlyRenderingFiber)\n  ) {\n    // \u6E32\u67D3\u65F6\u66F4\u65B0, \u505A\u597D\u5168\u5C40\u6807\u8BB0.\n    didScheduleRenderPhaseUpdateDuringThisPass = didScheduleRenderPhaseUpdate\n      = true\n  } else {\n    if (\n      fiber.lanes === NoLanes\n      && (alternate === null || alternate.lanes === NoLanes)\n    ) {\n      const lastRenderedReducer = queue.lastRenderedReducer\n\n      if (lastRenderedReducer !== null) {\n        let prevDispatcher\n        const currentState: S = queue.lastRenderedState\n        const eagerState = lastRenderedReducer(currentState, action)\n        update.eagerReducer = lastRenderedReducer\n        update.eagerState = eagerState\n\n        // \u82E5\u5728 Render \u9636\u6BB5, reducerEagerState === currentState,\n        // \u5219\u53EF\u4EE5\u65E0\u9700\u518D\u6B21\u8BA1\u7B97\u72B6\u6001, \u8DF3\u8FC7\u8C03\u5EA6\u9636\u6BB5, \u540E\u7EED\u76F4\u63A5\u4F7F\u7528 update.eagerState.\n        if (is(eagerState, currentState))\n          return\n      }\n    }\n\n    // 3. \u53D1\u8D77\u8C03\u5EA6\u66F4\u65B0, \u8FDB\u5165 Reconciler.\n    scheduleUpdateOnFiber(fiber, lane, eventTime)\n  }\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://react.dev/learn/queueing-a-series-of-state-updates",children:"Queueing series of state updates"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"export function getFinalState(baseState, queue) {\n  let finalState = baseState\n\n  for (const update of queue)\n    finalState = typeof update === 'function' ? update(finalState) : update\n\n  return finalState\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"usestate",children:"useState"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"setState((prevState) => {\n  // Object.assign would also work\n  return { ...prevState, ...updatedValues }\n})\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"let newState = baseState\nconst firstUpdate = hook.baseQueue.next\nlet update = firstUpdate\n\n// setState(value + 1) \u4E0E setState(value => value + 1) \u5B58\u5728\u5DEE\u5F02\n// \u904D\u5386 baseQueue \u4E2D\u7684\u6BCF\u4E00\u4E2A update\ndo {\n  if (typeof update.action === 'function')\n    newState = update.action(newState)\n  else newState = action\n\n  update = reconciler()\n} while (update !== firstUpdate)\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",children:"import { useState } from 'react'\n\nexport default function Example() {\n  // Declare a new state variable, which we'll call \"count\"\n  const [count, setCount] = useState(0)\n\n  return (\n    <div>\n      <p>\n        You clicked\n        {' '}\n        {count}\n        {' '}\n        times\n      </p>\n      <button type=\"button\" onClick={() => setCount(count + 1)}>Click me</button>\n    </div>\n  )\n}\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"import { useEffect, useState } from 'react'\n\nfunction FriendStatus(props) {\n  const [isOnline, setIsOnline] = useState(null)\n\n  function handleStatusChange(status) {\n    setIsOnline(status.isOnline)\n  }\n\n  useEffect(() => {\n    ChatAPI.subscribeToFriendStatus(props.friend.id, handleStatusChange)\n\n    return () => {\n      ChatAPI.unsubscribeFromFriendStatus(props.friend.id, handleStatusChange)\n    }\n  })\n\n  if (isOnline === null)\n    return 'Loading...'\n\n  return isOnline ? 'Online' : 'Offline'\n}\n\n// Mount with { friend: { id: 100 } } props\nChatAPI.subscribeToFriendStatus(100, handleStatusChange) // Run first effect\n\n// Update with { friend: { id: 200 } } props\n// Clean up previous effect\nChatAPI.unsubscribeFromFriendStatus(100, handleStatusChange)\nChatAPI.subscribeToFriendStatus(200, handleStatusChange) // Run next effect\n\n// Update with { friend: { id: 300 } } props\n// Clean up previous effect\nChatAPI.unsubscribeFromFriendStatus(200, handleStatusChange)\nChatAPI.subscribeToFriendStatus(300, handleStatusChange) // Run next effect\n\n// Unmount\nChatAPI.unsubscribeFromFriendStatus(300, handleStatusChange) // Clean up last effect\n"})})]})}function c(e={}){let{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},30416(e,n,t){t.d(n,{R:()=>i,x:()=>u});var a=t(59471);let s={},r=a.createContext(s);function i(e){let n=a.useContext(r);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function u(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);