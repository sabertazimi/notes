"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([["20507"],{87596(e,n,t){t.r(n),t.d(n,{metadata:()=>s,default:()=>u,frontMatter:()=>r,contentTitle:()=>o,toc:()=>l,assets:()=>c});var s=JSON.parse('{"id":"web/react/hooks/servers","title":"Servers","description":"useOptimistic","source":"@site/content/web/react/hooks/servers.md","sourceDirName":"web/react/hooks","slug":"/web/react/hooks/servers","permalink":"/notes/web/react/hooks/servers","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/react/hooks/servers.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"React","permalink":"/notes/tags/react"},{"inline":true,"label":"Hook","permalink":"/notes/tags/hook"},{"inline":true,"label":"Server","permalink":"/notes/tags/server"},{"inline":true,"label":"Form","permalink":"/notes/tags/form"}],"version":"current","lastUpdatedBy":"sabertazimi","lastUpdatedAt":1772298670000,"sidebarPosition":9,"frontMatter":{"sidebar_position":9,"tags":["Web","React","Hook","Server","Form"]},"sidebar":"tutorialSidebar","previous":{"title":"Concurrent","permalink":"/notes/web/react/hooks/concurrent"},"next":{"title":"Utility","permalink":"/notes/web/react/hooks/utility"}}'),a=t(62615),i=t(30416);let r={sidebar_position:9,tags:["Web","React","Hook","Server","Form"]},o="Servers",c={},l=[{value:"<code>useOptimistic</code>",id:"useoptimistic",level:2},{value:"Async React",id:"async-react",level:3},{value:"Internals",id:"internals",level:3},{value:"<code>useActionState</code>",id:"useactionstate",level:2},{value:"<code>useFormStatus</code>",id:"useformstatus",level:2},{value:"References",id:"references",level:2}];function d(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"servers",children:"Servers"})}),"\n",(0,a.jsx)(n.h2,{id:"useoptimistic",children:(0,a.jsx)(n.code,{children:"useOptimistic"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.a,{href:"https://jser.dev/2024-03-20-how-does-useoptimisticwork-internally-in-react#42-updateoptimistic",children:(0,a.jsx)(n.code,{children:"updateOptimistic()"})}),":"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["An optimistic update has ",(0,a.jsx)(n.code,{children:"revertLane"})," of ",(0,a.jsx)(n.code,{children:"TransitionLaneXX"})," and ",(0,a.jsx)(n.code,{children:"lane"})," of ",(0,a.jsx)(n.code,{children:"SyncLane"}),"."]}),"\n",(0,a.jsxs)(n.li,{children:["Update is processed in ",(0,a.jsx)(n.code,{children:"SyncLane"})," and in all following renders,\nbut it is NOT skipped and always kept in the next update queue."]}),"\n",(0,a.jsxs)(n.li,{children:["Update is reverted in ",(0,a.jsx)(n.code,{children:"revertLane"})," (low priority transition lane),\nby NOT getting added to the next queue.\nBut if the async action on the transition lane is not yet complete,\nit suspends by throwing the promise.\nThe revert will be tried again after the async action is done."]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"async-react",children:"Async React"}),"\n",(0,a.jsx)(n.p,{children:"Legacy React:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-tsx",children:"interface TabListProps {\n  tabs: { label: string, value: string }[]\n  activeTab: string\n  onChange: (value: string) => void\n}\n\nexport function TabList({ tabs, activeTab, onChange }: TabListProps) {\n  return (\n    <div>\n      {tabs.map(tab => (\n        <button key={tab.value} onClick={() => onChange(tab.value)} className={tab.value === activeTab ? 'active' : ''}>\n          {tab.label}\n        </button>\n      ))}\n    </div>\n  )\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Async React ",(0,a.jsx)(n.a,{href:"https://aurorascharff.no/posts/building-design-components-with-action-props-using-async-react",children:"design pattern"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-tsx",children:"import { useOptimistic, useTransition } from 'react'\n\ninterface TabListProps {\n  tabs: { label: string, value: string }[]\n  activeTab: string\n  changeAction?: (value: string) => void | Promise<void>\n  onChange?: (e: React.MouseEvent<HTMLButtonElement>) => void\n}\n\nexport function TabList({ tabs, activeTab, changeAction, onChange }: TabListProps) {\n  const [optimisticTab, setOptimisticTab] = useOptimistic(activeTab)\n  const [isPending, startTransition] = useTransition()\n\n  function handleTabChange(e: React.MouseEvent<HTMLButtonElement>, value: string) {\n    onChange?.(e)\n    startTransition(async () => {\n      setOptimisticTab(value)\n      await changeAction?.(value)\n    })\n  }\n\n  return (\n    <div>\n      {tabs.map(tab => (\n        <button\n          key={tab.value}\n          onClick={e => handleTabChange(e, tab.value)}\n          className={tab.value === optimisticTab ? 'active' : ''}\n        >\n          {tab.label}\n        </button>\n      ))}\n      {isPending && <Spinner />}\n    </div>\n  )\n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"internals",children:"Internals"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-tsx",children:'function useOptimistic(state, optimisticDispatcher) {\n  const [optimisticState, setOptimisticState] = useState(state)\n\n  useLayoutEffect(() => {\n    setOptimisticState(optimisticState)\n  }, [state])\n\n  const dispatch = (action) => {\n    setOptimisticState(state => optimisticDispatcher(state, action))\n  }\n\n  return [optimisticState, dispatch]\n}\n\nfunction Thread({ messages, sendMessage }) {\n  const formRef = useRef()\n\n  async function formAction(formData) {\n    addOptimisticMessage(formData.get(\'message\'))\n    formRef.current.reset()\n    await sendMessage(formData)\n  }\n\n  const [optimisticMessages, addOptimisticMessage] = useOptimistic(messages, (state, newMessage) => [\n    ...state,\n    {\n      text: newMessage,\n      sending: true,\n    },\n  ])\n\n  return (\n    <>\n      {optimisticMessages.map((message, index) => (\n        <div key={message.id}>\n          {message.text}\n          {!!message.sending && <small> (Sending...)</small>}\n        </div>\n      ))}\n      <form action={formAction} ref={formRef}>\n        <input type="text" name="message" placeholder="Hello!" />\n        <button type="submit">Send</button>\n      </form>\n    </>\n  )\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"useactionstate",children:(0,a.jsx)(n.code,{children:"useActionState"})}),"\n",(0,a.jsx)(n.p,{children:"Form loading state:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-tsx",children:"import { useActionState } from 'react'\n\nexport default function App() {\n  const sendMessage = async (_actionState: null, formData: FormData) => {\n    const message = formData.get('message')\n\n    console.log(message)\n\n    // Artificial delay to simulate async operation\n    await new Promise(resolve => setTimeout(resolve, 2000))\n\n    // TODO: do call (e.g. API call) to send the message\n\n    return null\n  }\n\n  const [_actionState, action, isPending] = useActionState(sendMessage, null)\n\n  return (\n    <form action={action}>\n      <label htmlFor=\"message\">Message:</label>\n      <input name=\"message\" id=\"message\" />\n\n      <button type=\"submit\" disabled={isPending}>\n        {isPending ? 'Sending ...' : 'Send'}\n      </button>\n    </form>\n  )\n}\n"})}),"\n",(0,a.jsx)(n.h2,{id:"useformstatus",children:(0,a.jsx)(n.code,{children:"useFormStatus"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-tsx",children:"import { useFormStatus } from 'react-dom'\n\nfunction SubmitButton() {\n  const { pending } = useFormStatus()\n\n  return (\n    <button type=\"submit\" disabled={pending}>\n      {pending ? 'Sending ...' : 'Send'}\n    </button>\n  )\n}\n\nexport default function App() {\n  const sendMessage = async (formData: FormData) => {\n    const message = formData.get('message')\n\n    console.log(message)\n\n    // Artificial delay to simulate async operation\n    await new Promise(resolve => setTimeout(resolve, 2000))\n\n    // TODO: do call (e.g. API call) to send the message\n  }\n\n  return (\n    <form action={sendMessage}>\n      <label htmlFor=\"message\">Message:</label>\n      <input name=\"message\" id=\"message\" />\n\n      <SubmitButton />\n    </form>\n  )\n}\n"})}),"\n",(0,a.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Async React ",(0,a.jsx)(n.a,{href:"https://aurorascharff.no/posts/building-design-components-with-action-props-using-async-react",children:"design patterns"}),"."]}),"\n"]})]})}function u(e={}){let{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},30416(e,n,t){t.d(n,{R:()=>r,x:()=>o});var s=t(59471);let a={},i=s.createContext(a);function r(e){let n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);