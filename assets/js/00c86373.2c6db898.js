"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([["96250"],{19508(e,n,o){o.r(n),o.d(n,{metadata:()=>s,default:()=>u,frontMatter:()=>r,contentTitle:()=>i,toc:()=>t,assets:()=>c});var s=JSON.parse('{"id":"web/node/module","title":"Module","description":"- CommonJS \u6A21\u5757\u5728\u6267\u884C\u9636\u6BB5\u540C\u6B65\u52A0\u8F7D\u5B50\u6A21\u5757\u6587\u4EF6,","source":"@site/content/web/node/module.md","sourceDirName":"web/node","slug":"/web/node/module","permalink":"/notes/web/node/module","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/node/module.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"Node.js","permalink":"/notes/tags/node-js"},{"inline":true,"label":"Module","permalink":"/notes/tags/module"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":5,"frontMatter":{"sidebar_position":5,"tags":["Web","Node.js","Module"]},"sidebar":"tutorialSidebar","previous":{"title":"PNPM","permalink":"/notes/web/node/pnpm"},"next":{"title":"Process","permalink":"/notes/web/node/process"}}'),d=o(62615),l=o(30416);let r={sidebar_position:5,tags:["Web","Node.js","Module"]},i="Module",c={},t=[{value:"CommonJS",id:"commonjs",level:2},{value:"ESM",id:"esm",level:2},{value:"CallBack",id:"callback",level:2},{value:"Resolution",id:"resolution",level:2}];function a(e){let n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,l.R)(),...e.components};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(n.header,{children:(0,d.jsx)(n.h1,{id:"module",children:"Module"})}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:"CommonJS \u6A21\u5757\u5728\u6267\u884C\u9636\u6BB5\u540C\u6B65\u52A0\u8F7D\u5B50\u6A21\u5757\u6587\u4EF6,\nES6 \u6A21\u5757\u5728\u9884\u5904\u7406\u9636\u6BB5\u52A0\u8F7D\u5B50\u6A21\u5757\u6587\u4EF6, ES6 \u6A21\u5757\u5728\u6267\u884C\u9636\u6BB5\u4E5F\u4F1A\u52A0\u8F7D\u5B50\u6A21\u5757\u6587\u4EF6, \u4E0D\u8FC7\u4F1A\u4F7F\u7528\u9884\u5904\u7406\u9636\u6BB5\u7684\u7F13\u5B58."}),"\n",(0,d.jsx)(n.li,{children:"CommonJS \u6A21\u5757\u540C\u6B65\u52A0\u8F7D\u5E76\u6267\u884C\u6A21\u5757\u6587\u4EF6, ES6 \u6A21\u5757\u63D0\u524D\u52A0\u8F7D\u5E76\u6267\u884C\u6A21\u5757\u6587\u4EF6.\n\u5F02\u6B65\u901A\u5E38\u88AB\u7406\u89E3\u4E3A\u5EF6\u540E\u4E00\u4E2A\u65F6\u95F4\u8282\u70B9\u6267\u884C, \u6240\u4EE5\u8BF4\u6210\u5F02\u6B65\u52A0\u8F7D\u662F\u9519\u8BEF\u7684."}),"\n",(0,d.jsx)(n.li,{children:"\u4ECE\u5F62\u5F0F\u4E0A\u770B,\nCommonJS \u6A21\u5757\u6574\u4F53\u5BFC\u51FA\u4E00\u4E2A\u5305\u542B\u82E5\u5E72\u4E2A\u53D8\u91CF\u7684\u5BF9\u8C61,\nES6 \u6A21\u5757\u5206\u5F00\u5BFC\u51FA\u5355\u4E2A\u53D8\u91CF."}),"\n"]}),"\n",(0,d.jsx)(n.h2,{id:"commonjs",children:"CommonJS"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"CommonJS"})," \u6A21\u5757\u4E00\u822C\u7531\u5305\u7BA1\u7406\u5668\u63D0\u4F9B\u7684\u8FD0\u884C\u65F6\u5B9E\u73B0."]}),"\n",(0,d.jsxs)(n.li,{children:["\u7531\u4E8E ",(0,d.jsx)(n.code,{children:"require"})," \u8BED\u53E5\u76F4\u63A5\u5206\u5272\u4E86\u6267\u884C\u7684\u4EE3\u7801\u5757,\n",(0,d.jsx)(n.code,{children:"CommonJS"})," \u6A21\u5757\u7684\u5BFC\u5165\u5BFC\u51FA\u8BED\u53E5\u7684\u4F4D\u7F6E\u4F1A\u5F71\u54CD\u6A21\u5757\u4EE3\u7801\u8BED\u53E5\u7684\u6267\u884C\u7ED3\u679C."]}),"\n"]}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-ts",children:"const fs = require('node:fs')\nconst path = require('node:path')\nconst vm = require('node:vm')\n\nfunction Module(id) {\n  this.id = id\n  this.exports = {}\n}\n\nModule.wrapper = [\n  '(function(exports, module, Require, __dirname, __filename) {',\n  '})',\n]\n\nModule._extensions = {\n  '.js': function (module) {\n    const content = fs.readFileSync(module.id, 'utf8')\n    const fnStr = Module.wrapper[0] + content + Module.wrapper[1]\n    const fn = vm.runInThisContext(fnStr)\n    fn.call(\n      module.exports, // Bind `this` to `module.exports`\n      module.exports,\n      module,\n      Require,\n      _dirname,\n      _filename\n    )\n  },\n  '.json': function (module) {\n    const json = fs.readFileSync(module.id, 'utf8')\n    module.exports = JSON.parse(json) // \u628A\u6587\u4EF6\u7684\u7ED3\u679C\u653E\u5728exports\u5C5E\u6027\u4E0A\n  },\n}\n\nfunction Require(modulePath) {\n  const absPathname = path.resolve(__dirname, modulePath)\n  const module = new Module(absPathname)\n  tryModuleLoad(module)\n  return module.exports\n}\n\nfunction tryModuleLoad(module) {\n  const extension = path.extname(module.id)\n  Module._extensions[extension](module)\n}\n"})}),"\n",(0,d.jsx)(n.h2,{id:"esm",children:"ESM"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"ES6"})," \u6A21\u5757\u501F\u52A9 ",(0,d.jsx)(n.code,{children:"JS"})," \u5F15\u64CE\u5B9E\u73B0.\n",(0,d.jsx)(n.code,{children:"JS"})," \u5F15\u64CE\u5B9E\u73B0\u4E86 ",(0,d.jsx)(n.code,{children:"ES6"})," \u6A21\u5757\u7684\u5E95\u5C42\u6838\u5FC3\u903B\u8F91."]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"ES6"})," \u6A21\u5757\u6709 5 \u79CD\u72B6\u6001,\n\u5206\u522B\u4E3A ",(0,d.jsx)(n.code,{children:"unlinked"}),", ",(0,d.jsx)(n.code,{children:"linking"}),", ",(0,d.jsx)(n.code,{children:"linked"}),", ",(0,d.jsx)(n.code,{children:"evaluating"})," and ",(0,d.jsx)(n.code,{children:"evaluated"}),"\n(Module Environment Records)."]}),"\n",(0,d.jsxs)(n.li,{children:["\u7531\u4E8E\u8FDE\u63A5\u9636\u6BB5\u4F1A\u7ED9\u5BFC\u5165\u6A21\u5757\u53D8\u91CF\u521B\u5EFA\u7ED1\u5B9A\u5E76\u521D\u59CB\u5316\u4E3A\u5B50\u6A21\u5757\u7684\u5BF9\u5E94\u53D8\u91CF,\n\u5B50\u6A21\u5757\u7684\u5BF9\u5E94\u53D8\u91CF\u5728\u8BC4\u4F30\u9636\u6BB5\u4F1A\u5148\u88AB\u8D4B\u503C,\n\u6240\u4EE5\u5BFC\u5165\u6A21\u5757\u53D8\u91CF\u83B7\u5F97\u4E86\u548C\u51FD\u6570\u58F0\u660E\u53D8\u91CF\u4E00\u6837\u7684\u63D0\u5347\u6548\u679C.\n",(0,d.jsx)(n.code,{children:"ES6"})," \u6A21\u5757\u7684 ",(0,d.jsx)(n.code,{children:"import/export"})," \u4F4D\u7F6E\u4E0D\u5F71\u54CD\u6A21\u5757\u4EE3\u7801\u8BED\u53E5\u7684\u6267\u884C\u7ED3\u679C."]}),"\n",(0,d.jsxs)(n.li,{children:["Experimental ",(0,d.jsx)(n.code,{children:".mjs"})," file."]}),"\n"]}),"\n",(0,d.jsx)(n.h2,{id:"callback",children:"CallBack"}),"\n",(0,d.jsx)(n.p,{children:"\u7F16\u5199\u5177\u6709\u56DE\u8C03\u51FD\u6570\u53C2\u6570\u7684\u6A21\u5757:"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-ts",children:"function foo(x, y, callback) {\n  try {\n    if (paramNotValid())\n      throw new Error('Invalid parameters!')\n    else\n      callback(null, param)\n  } catch (error) {\n    callback(error, param)\n  }\n}\n\nfoo(a, b, (err, param) => {\n  if (err)\n    processError()\n  else\n    process()\n})\n"})}),"\n",(0,d.jsx)(n.p,{children:"\u5411\u5B9A\u4E49\u6700\u5185\u5C42\u56DE\u8C03, \u53EF\u907F\u514D\u56DE\u5957\u5D4C\u5957:"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-ts",children:"server.on('request', (req, res) => {\n  const render = function (wsData) {\n    page = pageRender(req, session, userData, wsData)\n  }\n  const getWsInfo = function (userData) {\n    ws.get(req, render)\n  }\n  const getDbInfo = function (session) {\n    db.get(session.user, getWsInfo)\n  }\n  const getMemCached = function (req, res) {\n    memcached.getSession(req, getDbInfo)\n  }\n})\n"})}),"\n",(0,d.jsx)(n.h2,{id:"resolution",children:"Resolution"}),"\n",(0,d.jsxs)(n.p,{children:[(0,d.jsx)(n.code,{children:"const x = require('./module')"}),":"]}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"/root/src/module.js"})}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"/root/src/module/package.json"})," + ",(0,d.jsx)(n.code,{children:'{ "main": "lib/mainModule.js" }'}),"\n= ",(0,d.jsx)(n.code,{children:"/root/src/module/lib/mainModule.js"})]}),"\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"/root/src/module/index.js"})}),"\n"]}),"\n",(0,d.jsxs)(n.p,{children:[(0,d.jsx)(n.code,{children:"const x = require('module')"}),":"]}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"/root/src/node_modules/module.js"})}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"/root/src/node_modules/module/package.json"})," (if it specifies a ",(0,d.jsx)(n.code,{children:"main"})," property)"]}),"\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"/root/src/node_modules/module/index.js"})}),"\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"/root/node_modules/module.js"})}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"/root/node_modules/module/package.json"})," (if it specifies a ",(0,d.jsx)(n.code,{children:"main"})," property)"]}),"\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"/root/node_modules/module/index.js"})}),"\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"/node_modules/module.js"})}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"/node_modules/module/package.json"})," (if it specifies a ",(0,d.jsx)(n.code,{children:"main"})," property)"]}),"\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"/node_modules/module/index.js"})}),"\n"]})]})}function u(e={}){let{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,d.jsx)(n,{...e,children:(0,d.jsx)(a,{...e})}):a(e)}},30416(e,n,o){o.d(n,{R:()=>r,x:()=>i});var s=o(59471);let d={},l=s.createContext(d);function r(e){let n=s.useContext(l);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:r(e.components),s.createElement(l.Provider,{value:n},e.children)}}}]);