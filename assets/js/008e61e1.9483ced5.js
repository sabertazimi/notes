"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([["48480"],{86731(e,n,t){t.r(n),t.d(n,{metadata:()=>r,default:()=>d,frontMatter:()=>a,contentTitle:()=>o,toc:()=>c,assets:()=>l});var r=JSON.parse('{"id":"web/react/scheduler","title":"Scheduler","description":"Work loop in scheduler focus on Task Scheduling,","source":"@site/content/web/react/scheduler.md","sourceDirName":"web/react","slug":"/web/react/scheduler","permalink":"/notes/web/react/scheduler","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/react/scheduler.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"React","permalink":"/notes/tags/react"},{"inline":true,"label":"Internals","permalink":"/notes/tags/internals"},{"inline":true,"label":"Scheduler","permalink":"/notes/tags/scheduler"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":31,"frontMatter":{"sidebar_position":31,"tags":["Web","React","Internals","Scheduler"]},"sidebar":"tutorialSidebar","previous":{"title":"Architecture","permalink":"/notes/web/react/architecture"},"next":{"title":"Fiber","permalink":"/notes/web/react/fiber"}}'),i=t(62615),s=t(30416);let a={sidebar_position:31,tags:["Web","React","Internals","Scheduler"]},o="Scheduler",l={},c=[{value:"Priority",id:"priority",level:2},{value:"Workflow",id:"workflow",level:2},{value:"Time Slicing",id:"time-slicing",level:2},{value:"Task Queue",id:"task-queue",level:2},{value:"Work Loop",id:"work-loop",level:2}];function u(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"scheduler",children:"Scheduler"})}),"\n",(0,i.jsxs)(n.p,{children:["Work loop in scheduler focus on ",(0,i.jsx)(n.strong,{children:"Task Scheduling"}),",\nnot only including ",(0,i.jsx)(n.code,{children:"Reconciler.performSyncWorkOnRoot"}),"/",(0,i.jsx)(n.code,{children:"Reconciler.performConcurrentWorkOnRoot"}),",\nbut also for non-react tasks\n(meaning ",(0,i.jsx)(n.code,{children:"Scheduler"})," module can work standalone without ",(0,i.jsx)(n.code,{children:"React"}),")."]}),"\n",(0,i.jsx)(n.h2,{id:"priority",children:"Priority"}),"\n",(0,i.jsxs)(n.p,{children:["React 16, unstable concurrent mode with\n",(0,i.jsx)(n.a,{href:"https://github.com/facebook/react/blob/main/packages/scheduler/src/SchedulerPriorities.js",children:(0,i.jsx)(n.code,{children:"Priorities"})}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["ImmediatePriority: \u7ACB\u5373\u6267\u884C\u4F18\u5148\u7EA7, \u7EA7\u522B\u6700\u9AD8, ",(0,i.jsx)(n.code,{children:"expirationTime = -1"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["UserBlockingPriority: \u7528\u6237\u963B\u585E\u4F18\u5148\u7EA7, ",(0,i.jsx)(n.code,{children:"expirationTime = 250"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["NormalPriority: \u6B63\u5E38\u4F18\u5148\u7EA7, ",(0,i.jsx)(n.code,{children:"expirationTime = 5000"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["LowPriority: \u4F4E\u4F18\u5148\u7EA7, ",(0,i.jsx)(n.code,{children:"expirationTime = 10000"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["IdlePriority: \u53EF\u95F2\u7F6E\u4F18\u5148\u7EA7, ",(0,i.jsx)(n.code,{children:"expirationTime = maxSigned31BitInt"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["React 17, stable concurrent mode with\n",(0,i.jsx)(n.a,{href:"https://github.com/facebook/react/blob/main/packages/react-reconciler/src/ReactFiberLane.js",children:(0,i.jsx)(n.code,{children:"Lanes"})}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export type Lanes = number\nexport type Lane = number\n\nexport const TotalLanes = 31\n\nexport const NoLanes: Lanes = /*                        */ 0b0000000000000000000000000000000\nexport const NoLane: Lane = /*                          */ 0b0000000000000000000000000000000\n\nexport const SyncLane: Lane = /*                        */ 0b0000000000000000000000000000001\n\nexport const InputContinuousHydrationLane: Lane = /*    */ 0b0000000000000000000000000000010\nexport const InputContinuousLane: Lanes = /*            */ 0b0000000000000000000000000000100\n\nexport const DefaultHydrationLane: Lane = /*            */ 0b0000000000000000000000000001000\nexport const DefaultLane: Lanes = /*                    */ 0b0000000000000000000000000010000\n\nconst TransitionHydrationLane: Lane = /*                */ 0b0000000000000000000000000100000\nconst TransitionLanes: Lanes = /*                       */ 0b0000000001111111111111111000000\nconst TransitionLane1: Lane = /*                        */ 0b0000000000000000000000001000000\nconst TransitionLane2: Lane = /*                        */ 0b0000000000000000000000010000000\nconst TransitionLane3: Lane = /*                        */ 0b0000000000000000000000100000000\nconst TransitionLane4: Lane = /*                        */ 0b0000000000000000000001000000000\nconst TransitionLane5: Lane = /*                        */ 0b0000000000000000000010000000000\nconst TransitionLane6: Lane = /*                        */ 0b0000000000000000000100000000000\nconst TransitionLane7: Lane = /*                        */ 0b0000000000000000001000000000000\nconst TransitionLane8: Lane = /*                        */ 0b0000000000000000010000000000000\nconst TransitionLane9: Lane = /*                        */ 0b0000000000000000100000000000000\nconst TransitionLane10: Lane = /*                       */ 0b0000000000000001000000000000000\nconst TransitionLane11: Lane = /*                       */ 0b0000000000000010000000000000000\nconst TransitionLane12: Lane = /*                       */ 0b0000000000000100000000000000000\nconst TransitionLane13: Lane = /*                       */ 0b0000000000001000000000000000000\nconst TransitionLane14: Lane = /*                       */ 0b0000000000010000000000000000000\nconst TransitionLane15: Lane = /*                       */ 0b0000000000100000000000000000000\nconst TransitionLane16: Lane = /*                       */ 0b0000000001000000000000000000000\n\nconst RetryLanes: Lanes = /*                            */ 0b0000111110000000000000000000000\nconst RetryLane1: Lane = /*                             */ 0b0000000010000000000000000000000\nconst RetryLane2: Lane = /*                             */ 0b0000000100000000000000000000000\nconst RetryLane3: Lane = /*                             */ 0b0000001000000000000000000000000\nconst RetryLane4: Lane = /*                             */ 0b0000010000000000000000000000000\nconst RetryLane5: Lane = /*                             */ 0b0000100000000000000000000000000\n\nexport const SomeRetryLane: Lane = RetryLane1\n\nexport const SelectiveHydrationLane: Lane = /*          */ 0b0001000000000000000000000000000\n\nconst NonIdleLanes = /*                                 */ 0b0001111111111111111111111111111\n\nexport const IdleHydrationLane: Lane = /*               */ 0b0010000000000000000000000000000\nexport const IdleLane: Lanes = /*                       */ 0b0100000000000000000000000000000\n\nexport const OffscreenLane: Lane = /*                   */ 0b1000000000000000000000000000000\n"})}),"\n",(0,i.jsx)(n.h2,{id:"workflow",children:"Workflow"}),"\n",(0,i.jsxs)(n.p,{children:["Scheduler main ",(0,i.jsx)(n.a,{href:"https://github.com/facebook/react/blob/main/packages/scheduler/src/forks/Scheduler.js",children:"workflow"}),":"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"scheduleCallback(callback)"}),"\n-> ",(0,i.jsx)(n.code,{children:"push(queue, newTask)"})," (Wrap ",(0,i.jsx)(n.code,{children:"callback"})," into ",(0,i.jsx)(n.code,{children:"task"}),")\n(For delayed task -> ",(0,i.jsx)(n.code,{children:"requestHostTimeout(handleTimeout, delayTime)"}),")\n-> ",(0,i.jsx)(n.code,{children:"requestHostCallback(flushWork)"}),"\n-> ",(0,i.jsx)(n.code,{children:"messageChannelPort.postMessage(null)"}),"\n-> ",(0,i.jsx)(n.code,{children:"performWorkUntilDeadline()"}),"\n-> ",(0,i.jsx)(n.code,{children:"flushWork(hasTimeRemaining, currentTime)"}),":\n-> ",(0,i.jsx)(n.code,{children:"workLoop(hasTimeRemaining, currentTime)"}),":"]}),"\n",(0,i.jsx)(n.p,{children:"\u5C06 Reconciler \u7684\u5DE5\u4F5C (Callback)\n\u5305\u88C5\u6210 Task \u7EC4\u6210 Task Queue,\n\u6309\u7167\u65F6\u95F4\u5206\u7247\u673A\u5236,\n\u4E0D\u65AD\u5730\u6D88\u8D39 Task Queue."}),"\n",(0,i.jsx)(n.p,{children:"\u5BF9\u4E8E\u5EF6\u65F6\u4EFB\u52A1 (Delayed Task),\n\u4F1A\u5C06\u5176\u5148\u653E\u5165 Timer Queue,\n\u7B49\u5F85\u5EF6\u65F6\u5B8C\u6210\u540E\u518D\u5C06\u5176\u653E\u5165 Task Queue."}),"\n",(0,i.jsx)(n.h2,{id:"time-slicing",children:"Time Slicing"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// \u65F6\u95F4\u5207\u7247\u5468\u671F, \u9ED8\u8BA4\u662F 5ms.\n// \u5982\u679C\u4E00\u4E2A task \u8FD0\u884C\u8D85\u8FC7\u8BE5\u5468\u671F, \u4E0B\u4E00\u4E2A task \u6267\u884C\u524D, \u4F1A\u628A\u63A7\u5236\u6743\u5F52\u8FD8\u6D4F\u89C8\u5668.\nconst yieldInterval = 5\nconst maxYieldInterval = 300\n\nlet deadline = 0 // currentTime + yieldInterval.\nlet needsPaint = false\nlet isMessageLoopRunning = false\nlet scheduledHostCallback = null\n\nconst channel = new MessageChannel()\nconst port = channel.port2\nchannel.port1.onmessage = performWorkUntilDeadline\n\nconst scheduling = navigator.scheduling\nconst getCurrentTime = performance.now\n\n// \u8BF7\u6C42\u56DE\u8C03:\nfunction requestHostCallback(callback) {\n  // 1. \u4FDD\u5B58 callback.\n  scheduledHostCallback = callback\n\n  if (!isMessageLoopRunning) {\n    isMessageLoopRunning = true\n    // 2. \u901A\u8FC7 MessageChannel \u53D1\u9001\u6D88\u606F.\n    port.postMessage(null)\n  }\n}\n\n// \u53D6\u6D88\u56DE\u8C03:\nfunction cancelHostCallback() {\n  scheduledHostCallback = null\n}\n\nfunction requestHostTimeout(callback, ms) {\n  taskTimeoutID = setTimeout(() => {\n    callback(getCurrentTime())\n  }, ms)\n}\n\nfunction cancelHostTimeout() {\n  clearTimeout(taskTimeoutID)\n  taskTimeoutID = -1\n}\n\n// \u662F\u5426\u8BA9\u51FA\u4E3B\u7EBF\u7A0B (time slice):\nfunction shouldYieldToHost() {\n  const currentTime = getCurrentTime()\n\n  if (currentTime >= deadline) {\n    if (needsPaint || scheduling.isInputPending()) {\n      // There is either a pending paint or a pending input.\n      return true\n    }\n\n    // There's no pending input.\n    // Only yield if we've reached max yield interval.\n    return currentTime >= maxYieldInterval\n  } else {\n    // There's still time left in frame.\n    return false\n  }\n}\n\n// \u8BF7\u6C42\u7ED8\u5236:\nfunction requestPaint() {\n  needsPaint = true\n}\n\n// \u5B9E\u9645\u56DE\u8C03\u51FD\u6570\u5904\u7406:\nfunction performWorkUntilDeadline() {\n  if (scheduledHostCallback !== null) {\n    // 1. \u8BBE\u7F6E currentTime \u4E0E deadline.\n    const currentTime = getCurrentTime()\n    deadline = currentTime + yieldInterval\n    const hasTimeRemaining = true\n\n    try {\n      // 2. \u6267\u884C\u56DE\u8C03, \u8FD4\u56DE\u662F\u5426\u6709\u8FD8\u6709\u5269\u4F59\u4EFB\u52A1.\n      const hasMoreWork = scheduledHostCallback(hasTimeRemaining, currentTime)\n\n      if (!hasMoreWork) {\n        // \u6CA1\u6709\u5269\u4F59\u4EFB\u52A1, \u9000\u51FA.\n        isMessageLoopRunning = false\n        scheduledHostCallback = null\n      } else {\n        port.postMessage(null) // \u6709\u5269\u4F59\u4EFB\u52A1, \u53D1\u8D77\u65B0\u7684\u8C03\u5EA6.\n      }\n    } catch (error) {\n      port.postMessage(null) // \u5982\u6709\u5F02\u5E38, \u91CD\u65B0\u53D1\u8D77\u8C03\u5EA6.\n      throw error\n    }\n  } else {\n    isMessageLoopRunning = false\n  }\n\n  needsPaint = false // Reset.\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"task-queue",children:"Task Queue"}),"\n",(0,i.jsxs)(n.p,{children:["Task queue is ",(0,i.jsx)(n.a,{href:"https://github.com/facebook/react/blob/main/packages/scheduler/src/SchedulerMinHeap.js",children:"MinHeap"}),",\nstoring Tasks."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"const newTask = {\n  id: taskIdCounter++,\n  callback, // Work from reconciler.\n  priorityLevel,\n  startTime,\n  expirationTime,\n  sortIndex: -1, // MinHeap queue indexing.\n}\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"function scheduleCallback(priorityLevel, callback, options) {\n  const currentTime = getCurrentTime()\n  const startTime = currentTime\n  const expirationTime = startTime + timeout[priorityLevel] // -1/250/5000/10000/MAX_INT.\n  const newTask = {\n    id: taskIdCounter++,\n    callback,\n    priorityLevel,\n    startTime,\n    expirationTime,\n    sortIndex: -1,\n  }\n\n  if (startTime > currentTime) {\n    // Delayed task.\n    newTask.sortIndex = startTime\n    push(timerQueue, newTask)\n\n    // All tasks are delayed, and this is task with earliest delay.\n    if (peek(taskQueue) === null && newTask === peek(timerQueue)) {\n      if (isHostTimeoutScheduled) {\n        // Cancel an existing timeout.\n        cancelHostTimeout()\n      } else {\n        isHostTimeoutScheduled = true\n      }\n\n      // Schedule a timeout.\n      requestHostTimeout(handleTimeout, startTime - currentTime)\n    }\n  } else {\n    // Normal task.\n    newTask.sortIndex = expirationTime\n    push(taskQueue, newTask)\n\n    if (!isHostCallbackScheduled && !isPerformingWork) {\n      isHostCallbackScheduled = true\n      requestHostCallback(flushWork)\n    }\n  }\n\n  return newTask\n}\n\nfunction handleTimeout(currentTime) {\n  isHostTimeoutScheduled = false\n  advanceTimers(currentTime)\n\n  if (!isHostCallbackScheduled) {\n    if (peek(taskQueue) !== null) {\n      isHostCallbackScheduled = true\n      requestHostCallback(flushWork)\n    } else {\n      const firstTimer = peek(timerQueue)\n\n      if (firstTimer !== null)\n        requestHostTimeout(handleTimeout, firstTimer.startTime - currentTime)\n    }\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"work-loop",children:"Work Loop"}),"\n",(0,i.jsxs)(n.p,{children:["\u5F53 ",(0,i.jsx)(n.code,{children:"callback()"})," \u8FD4\u56DE\u51FD\u6570\u65F6, \u8868\u660E\u4EA7\u751F\u8FDE\u7EED\u56DE\u8C03 (e.g. \u51FA\u73B0\u66F4\u9AD8\u4F18\u5148\u4EFB\u52A1/\u65F6\u95F4\u5206\u7247\u7528\u5B8C, \u6E32\u67D3\u4E2D\u65AD),\n\u9700\u5C06\u8FD4\u56DE\u7684\u51FD\u6570\u518D\u6B21\u653E\u5165\u4EFB\u52A1\u961F\u5217, \u7EE7\u7EED\u8FDB\u884C\u8C03\u5EA6\u76F4\u81F3\u6E05\u7A7A\u4EFB\u52A1\u961F\u5217 (\u6E32\u67D3\u6062\u590D)."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"function flushWork(hasTimeRemaining, initialTime) {\n  // We'll need a host callback next time work is scheduled.\n  isHostCallbackScheduled = false\n\n  if (isHostTimeoutScheduled) {\n    // We scheduled a timeout but it's no longer needed. Cancel it.\n    isHostTimeoutScheduled = false\n    cancelHostTimeout()\n  }\n\n  isPerformingWork = true // Lock.\n  const previousPriorityLevel = currentPriorityLevel\n\n  try {\n    return workLoop(hasTimeRemaining, initialTime)\n  } finally {\n    // Restore context.\n    currentTask = null\n    currentPriorityLevel = previousPriorityLevel\n    isPerformingWork = false\n  }\n}\n\nfunction workLoop(hasTimeRemaining, initialTime) {\n  let currentTime = initialTime\n  advanceTimers(currentTime)\n  currentTask = peek(taskQueue)\n\n  while (currentTask !== null) {\n    if (\n      currentTask.expirationTime > currentTime\n      && (!hasTimeRemaining || shouldYieldToHost())\n    ) {\n      // This currentTask hasn't expired, and we've reached deadline.\n      break\n    }\n\n    const callback = currentTask.callback\n\n    if (typeof callback === 'function') {\n      currentTask.callback = null\n      currentPriorityLevel = currentTask.priorityLevel\n      const didUserCallbackTimeout = currentTask.expirationTime <= currentTime\n      const continuationCallback = callback(didUserCallbackTimeout)\n      currentTime = getCurrentTime()\n\n      if (typeof continuationCallback === 'function') {\n        // \u4EA7\u751F\u4E86\u8FDE\u7EED\u56DE\u8C03 (\u5982 Fiber\u6811\u592A\u5927, \u51FA\u73B0\u4E86\u4E2D\u65AD\u6E32\u67D3), \u4FDD\u7559 currentTask.\n        currentTask.callback = continuationCallback\n      } else {\n        if (currentTask === peek(taskQueue))\n          pop(taskQueue)\n      }\n\n      advanceTimers(currentTime)\n    } else {\n      // \u5982\u679C\u4EFB\u52A1\u88AB\u53D6\u6D88 (currentTask.callback = null), \u5C06\u5176\u79FB\u51FA\u961F\u5217.\n      pop(taskQueue)\n    }\n\n    currentTask = peek(taskQueue)\n  }\n\n  // Return whether there's additional work.\n  if (currentTask !== null) {\n    return true\n  } else {\n    const firstTimer = peek(timerQueue)\n\n    // \u5B58\u5728\u5EF6\u65F6\u4EFB\u52A1, \u7EE7\u7EED\u8FDB\u884C\u8C03\u5EA6.\n    if (firstTimer !== null)\n      requestHostTimeout(handleTimeout, firstTimer.startTime - currentTime)\n\n    return false\n  }\n}\n"})})]})}function d(e={}){let{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(u,{...e})}):u(e)}},30416(e,n,t){t.d(n,{R:()=>a,x:()=>o});var r=t(59471);let i={},s=r.createContext(i);function a(e){let n=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);